# 開発ガイド

> **Kumihan-Formatter の開発・コントリビューション指針**

---

## 🧩 アーキテクチャ概要

```text
┌─ kumihan_formatter/            # Python パッケージルート
│  ├─ cli.py          ← Click CLIエントリポイント
│  ├─ parser.py       ← テキスト → AST (段落・ブロック・キーワード付きリスト)
│  ├─ renderer.py     ← AST → HTML (Jinja2 テンプレート)
│  ├─ config.py       ← YAML/JSON設定ファイル管理
│  ├─ templates/      ← base.html.j2
│  └─ utils/
│      └─ __init__.py
├─ dev/                # 開発者向けファイル
│  ├─ tests/          # テストファイル群
│  │  ├─ test_parser.py
│  │  ├─ test_renderer.py
│  │  ├─ test_config.py
│  │  └─ test_cli.py
│  └─ tools/
│      └─ generate_test_file.py
└─ examples/
    ├─ sample.txt
    ├─ comprehensive-sample.txt
    └─ config-sample.yaml
```

**設計原則:**
* **単一責任:** parser は純粋に構文解析、renderer は純粋に変換を担当
* **プラガブル:** マーカーや CSS は YAML で増減可能
* **ステートレス:** 大部分を純粋関数で構成しテスト容易性を向上

---

## ⚙️ 開発環境セットアップ

### 初期化コマンド

```bash
# 1) リポジトリを取得
$ git clone https://github.com/USERNAME/kumihan-formatter.git
$ cd kumihan-formatter

# 2) 仮想環境（Python ≥ 3.9）を作成しインストール
$ python -m venv .venv && source .venv/bin/activate
$ pip install -e .[dev]        # dev extras = pytest, flake8, rich

# 3) テスト実行
$ pytest -q
```

### ローカル実行例

```bash
$ python -m kumihan_formatter.cli \
    examples/sample.txt \
    -o dist/
```

**主なフラグ:**

| フラグ | 説明 |
|------|-------------|
| `-o, --output DIR` | 出力フォルダ (default: ./dist) |
| `--no-preview` | HTML 生成後にブラウザを開かない |
| `--config FILE` | YAML/JSON 設定ファイルを指定 |

---

## 🛠️ テスト戦略

* **ユニット**: パーサ & レンダラの境界ケース（マーカー入れ子、不正構文）
* **ゴールデン**: sample.txt → expected.html のスナップショット比較
* **パフォーマンス**: 10 k 文字 ≤ 1 秒（pytest-benchmark）

### CI スモークテスト

```bash
pytest && \
python -m kumihan_formatter.cli examples/sample.txt -o /tmp/out
```

---

## 📃 非機能要件

| 分類 | 要件 |
|----------|-------------|
| **性能** | 10 k 文字 → HTML ≤ 1 秒 |
| **信頼性** | エラー位置を HTML 内で可視化 |
| **移植性** | Python 標準 + `rich`, `jinja2`, `click` のみ |
| **セキュリティ** | 完全オフライン。上書き防止チェック有 |
| **i18n** | UI・メッセージともに日本語のみ |

---

## 🏷️ GitHub Issue ラベリングルール

本プロジェクトでは日本語ラベルを使用し、体系的なIssue管理を行います。

### 優先度ラベル（必須）
すべてのIssueに以下のいずれかを付与：

| ラベル | 用途 | 例 |
|-------|------|-----|
| `優先度:緊急` | システム停止・セキュリティ問題 | 変換できない、データ破損 |
| `優先度:高` | 重要な機能障害・リリースブロッカー | 主要機能の不具合 |
| `優先度:中` | 通常の機能改善・軽微なバグ | UI改善、細かなバグ |
| `優先度:低` | 細かい改善・将来的な検討事項 | ドキュメント微調整 |
| `優先度:保留` | あったら良い程度・将来検討 | 新機能のアイデア |

### 種類ラベル（推奨）
Issueの内容に応じて付与：

| ラベル | 用途 |
|-------|------|
| `バグ` | 何かが正常に動作しない |
| `機能改善` | 既存機能の改善・新機能リクエスト |
| `種類:新機能` | 全く新しい機能の実装 |
| `種類:リファクタ` | コード整理・構造改善 |
| `種類:テスト` | テスト関連の作業 |
| `種類:パフォーマンス` | 性能改善 |
| `ドキュメント` | ドキュメントの改善・追加 |
| `質問` | 詳細情報が必要・質問 |

### 状況・難易度ラベル（任意）

| ラベル | 用途 |
|-------|------|
| `状況:調査中` | 作業開始前に調査が必要 |
| `状況:ブロック中` | 他のIssueや外部依存により一時停止 |
| `状況:着手可能` | 作業開始可能 |
| `状況:作業中` | 現在作業中 |
| `難易度:易` | 初心者向け・簡単 |
| `難易度:中` | ある程度の経験が必要 |
| `難易度:難` | 高度な技術・経験が必要 |

### ラベル付与ルール
1. **優先度ラベルは必須** - すべてのIssueに付与する
2. **複数ラベル可** - 種類+状況+難易度の組み合わせ推奨
3. **日本語統一** - 英語ラベルは使用しない
4. **Claude Code使用時** - 新規Issue作成時は必ず適切なラベリングを行う

---

## 🔄 開発ワークフロー

1. **応答は必ず日本語を使用すること**
2. **コード追加前** に必ず *開発ブランチ* (`feature/XXX`) を切る
3. 機能コードと **対応するテストコード** を *セットで追加* する
4. **コミット後** に *プルリクエスト* を作成し、レビュー後 **main ブランチにマージ** する
5. **マージ後**、関連 **Issue を更新・整理** する
6. マージが完了したら **不要ブランチを削除** する
7. 1から6までの作業完了後、作業に関連するIssueがあれば更新する

---

## 🤝 コントリビューション

* **コードスタイル**: black + isort + flake8
* **コミット規約**: Conventional Commits (`feat:`, `fix:` など)

---

## 🔮 拡張フック（今後検討）

* テーマ / フォント / レイアウト切替（JSON スキーマ）
* 画像埋め込み (`:::画像 path=... alt=...`)
* PDF 出力（`weasyprint`）
* カスタムブロック用プラグインインタフェース