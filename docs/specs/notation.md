# Kumihan記法仕様書

> **実装バージョン**: v0.9.0-alpha.8  
> **記法バージョン**: v3.0.0

## 1. 概要

このドキュメントは、Kumihan-FormatterのKumihan記法の完全な仕様を定義します。本バージョンはIssue #726対応により、記法システムの根本的な統一化と単一行記法の完全廃止を実装します。

### 1.1 設計思想

- **直感性**: 見た目で内容が予想できる記法
- **簡潔性**: 最小限の記号で最大の表現力
- **一貫性**: 統一されたルールで覚えやすい
- **日本語適性**: 日本語文書作成に最適化
- **モバイル対応**: スマホでの入力のしやすさを重視
- **厳密性**: 曖昧さを排除した明確な構文定義

### 1.2 対象ユーザー

- TRPGシナリオ作成者
- 技術知識を持たない文書作成者
- 美しい文書レイアウトを必要とする一般ユーザー

### 1.3 記法の統一原則

1. **統一ブロック記法** - 全記法がブロック形式に統一
2. **単一行記法完全廃止** - 後方互換性を破棄し簡潔性を追求
3. **終了マーカー必須** - 全記法で`##`による明示的終了が必須

### 1.4 破壊的変更の概要

- **単一行記法完全廃止**: `#太字# 内容` → `#太字#\n内容\n##`
- **終了マーカー必須化**: 全記法で`##`による終了が必須
- **後方互換性完全破棄**: v2.x以前の記法は即時無効化
- **マーカー混在禁止**: 半角・全角マーカーの混在は厳格に禁止
- **色名柔軟対応**: `red`/`Red`/`RED`の全形式に対応

## 2. 基本記法（v3.0.0統一仕様）

### 2.1 統一ブロック構文

Kumihan記法v3.0.0の統一構文：

```
# キーワード #
内容
##
```

**構成要素**:
- `#` または `＃`: 開始マーカー（半角・全角どちらも可、混在禁止）
- `キーワード`: 装飾や機能を指定（複合記法は`+`で結合）
- `#` またに `＃`: 中間マーカー（開始マーカーと同一種類必須）
- **改行**: キーワード行の次の行から内容開始
- `内容`: 実際のテキスト内容（複数行可、インデント保持）
- `##` または `＃＃`: 終了マーカー（**必須**、単独行）

**柔軟性と制限**:
- 半角`#`と全角`＃`の両方をサポート（ただし混在禁止）
- スペースは省略可能（半角・全角スペースどちらも使用可能）
- 複合記法の結合子：`+`または`＋`両対応
- 色名形式：`red`/`Red`/`RED`の全形式対応

**厳格な混在禁止ルール** ⚠️:
- 1つの記法ブロック内で半角・全角を混在させることは禁止
- ✅ `#太字#\n内容\n##` または `＃太字＃\n内容\n＃＃`
- ❌ `#太字＃\n内容\n##` （半角開始・全角中間）
- ❌ `＃太字#\n内容\n＃＃` （全角開始・半角中間）
- ファイル全体でマーカー種類の一貫性を強く推奨

**注意事項**:
- Markdownの見出し記法との競合を避けるため、中間マーカーが必要
- `# キーワード #` 形式でMarkdownの`# 見出し`と区別
- ブロック記法の終了マーカー`##`はMarkdown見出しレベル2と区別するため、単独行で使用

### 2.2 統一ブロック処理ルール

#### 基本ブロック記法（全記法統一）
```
# 太字 #
重要な情報です
##

＃太字＃
重要な情報です
＃＃

＃　太字　＃
重要な情報です
＃＃
```
**特徴**: 全記法がブロック形式、終了マーカー`##`必須

#### 複数行コンテンツの例
```
# 枠線 #
NPC詳細情報：
- 名前：田中一郎
- 職業：私立探偵
- 特徴：鋭い観察眼
##

＃コードブロック＃
function example() {
    console.log("Hello World");
    return "Kumihan v3.0.0";
}
＃＃
```

**統一ルール**:
- `# キーワード #` の次の行から内容開始
- `##` または `＃＃` で明示的に終了（**必須**）
- インデントは完全に保持される
- 空行も含めて全ての内容が保持される

## 3. コアキーワード仕様

### 3.1 装飾系キーワード

#### 太字
```
# 太字 #
強調したいテキスト
##

＃太字＃
強調したいテキスト
＃＃
```
**HTML出力**: `<strong>強調したいテキスト</strong>`
**用途**: 重要な情報の強調

#### イタリック  
```
# イタリック #
引用や心の声
##

＃イタリック＃
引用や心の声
＃＃
```
**HTML出力**: `<em>引用や心の声</em>`
**用途**: 引用文、心の声、雰囲気のある文章

#### 下線
```
# 下線 #
重要な情報
##

＃下線＃
重要な情報
＃＃
```
**HTML出力**: `<u>重要な情報</u>`
**用途**: 重要な情報のマーキング、名前や専門用語の強調

#### 取り消し線
```
# 取り消し線 #
削除された内容
##

＃取り消し線＃
変更前の情報
＃＃
```
**HTML出力**: `<del>削除された内容</del>`
**用途**: 削除された情報、変更履歴の表示

#### コード
```
# コード #
function()
##

＃コード＃
var result = 123;
＃＃
```
**HTML出力**: `<code>function()</code>`
**用途**: プログラムコード、技術用語、コマンド名の表示

#### 引用
```
# 引用 #
「これは重要な引用文です」
- 著者名
##
```
**HTML出力**: `<blockquote>内容</blockquote>`
**用途**: 引用文、格言、重要な文献からの抜粋

#### 枠線
```
# 枠線 #
重要な情報をまとめます
複数行での使用が一般的です
##
```
**HTML出力**: `<div class="box-border">内容</div>`
**用途**: 情報のまとめ、重要なデータの区別

#### ハイライト
```
# ハイライト #
背景色付きの強調
##

# ハイライト color=#ffe6e6 #
赤系の背景色
##

＃ハイライト color=red＃
赤色の背景色
＃＃

# ハイライト color=BLUE #
青色の背景色
##
```
**HTML出力**: `<mark style="background-color: 色値">内容</mark>`
**属性**:
- `color=色値`: 16進数カラーコード（#ff0000）または英単語色名（red, blue等）

**サポート色名** (30色):
- **基本色**: red, green, blue, yellow, orange, purple, pink, brown, black, white
- **グレー系**: gray, grey, silver
- **明度系**: lightblue, lightgreen, lightyellow, lightgray, darkblue, darkgreen, darkred  
- **その他**: cyan, magenta, lime, navy, teal, olive, maroon, aqua, fuchsia, transparent

**色名ルール** ⚠️:
- 大文字・小文字の3形式対応: `red`（全小文字）、`Red`（頭大文字）、`RED`（全大文字）
- 形式混在は禁止: ❌ `rEd`, `ReD` (大文字小文字混在)

**推奨カラーパレット**:
- 危険・警告: `red` / `#ffe6e6`
- 安全・成功: `green` / `#e6ffe6`  
- 注意・ヒント: `yellow` / `#fff3cd`
- 情報・補足: `blue` / `#e1f5fe`

### 3.2 構造系キーワード

#### 見出し1〜5
```
# 見出し1 #
文書タイトル
##

＃見出し2＃
第1章　大項目
＃＃

#見出し3#
1.1 中項目
##

# 見出し4 #
詳細説明
##

＃　見出し5　＃
補足情報
＃＃
```
**HTML出力**: `<h1>〜<h5>`タグ
**特徴**:
- 自動的にIDが付与される（アンカーリンク対応）
- 目次生成の対象となる

#### 目次（特別記法）
```
# 目次 #
##
```
**機能**: 文書内の見出し（見出し1〜5）から自動的に目次を生成
**特別ルール**: 目次は**内容が空の唯一の許可された記法**
**HTML出力**: `<nav class="toc"><ul>...</ul></nav>`
**階層**: 見出しレベルに応じて入れ子構造（1〜5レベルのネスト）

### 3.3 機能系キーワード

#### 折りたたみ
```
# 折りたたみ #
詳細な情報：
この内容はデフォルトで非表示になり、
クリックで展開できます。
##
```
**HTML出力**: `<details><summary>クリックして展開</summary>内容</details>`
**用途**: 詳細情報の格納、ページの見やすさ向上

#### ネタバレ
```
# ネタバレ #
重要な真相や結末
GMが管理すべき秘密情報
##
```
**HTML出力**: `<details class="spoiler"><summary>ネタバレ注意</summary>内容</details>`
**用途**: TRPG用GM専用情報、小説の結末など

#### 画像
```
# 画像 #
image.jpg
##

＃画像＃
image.png
＃＃
```
**HTML出力**: `<img src="images/image.jpg">`
**ファイル配置**: 入力ファイルと同じディレクトリの`images/`フォルダ

### 3.4 レイアウト系キーワード

#### 中央寄せ
```  
# 中央寄せ #
このテキストは中央に配置されます
##
```
**HTML出力**: `<div style="text-align: center">内容</div>`
**用途**: タイトル、重要な文章の中央配置

#### 注意
```
# 注意 #
これは注意が必要な情報です
##
```
**HTML出力**: `<div class="alert warning">内容</div>`
**用途**: 警告、注意事項、危険情報の表示

#### 情報
```
# 情報 #
これは補足情報です
##
```
**HTML出力**: `<div class="alert info">内容</div>`
**用途**: 補足説明、ヒント、追加情報の表示

#### コードブロック
```
# コードブロック #
function example() {
    console.log("Hello World");
    return true;
}
##
```
**HTML出力**: `<pre><code>内容</code></pre>`
**用途**: 複数行のプログラムコード、設定ファイル、コマンド例

## 4. 複合記法（v3.0.0統一仕様）

### 4.1 統一ブロックルール

複数のキーワードを組み合わせた記法も全てブロック形式：

```
# キーワード1+キーワード2 #
内容
##

＃キーワード1＋キーワード2＃
内容
＃＃
```

**結合子ルール**:
- `+` または `＋` 両方対応
- マーカーと同様に混在禁止

### 4.2 組み合わせ例

#### 装飾の組み合わせ
```
# 太字+枠線 #
最重要情報
##

＃太字＋イタリック＃
強調された引用文
＃＃

# 枠線+ハイライト color=#fff3cd #
注意事項ボックス
##
```

#### 見出しとの組み合わせ
```
# 見出し2+太字 #
第2章：重要な章
##

＃見出し3＋ハイライト color=#e1f5fe＃
1.2 補足情報
＃＃
```

### 4.3 組み合わせ制限

**禁止されている組み合わせ**:
- 見出し同士: `# 見出し1+見出し2 #` (エラー)
- 機能系同士: `# 折りたたみ+ネタバレ #` (エラー)

**推奨されない組み合わせ**:
- 過度な装飾: 3個以上のキーワード組み合わせ

## 5. パターン定義（正規表現）- v3.0.0ブロック専用

### 5.1 ブロック記法パターン（統一仕様）

#### 5.1.1 ブロック開始パターン
```python
# 基本ブロック開始（単一行）
BLOCK_START_PATTERN = r'^[#＃]([^#＃\s]+)[#＃]$'

# 属性付きブロック開始
ATTRIBUTE_BLOCK_PATTERN = r'^[#＃](\w+)(?:\s+((color)=[^#＃\s]+(?:\s+(color)=[^#＃\s]+)*)?)[#＃]$'

# 複合記法ブロック開始
COMPOUND_BLOCK_PATTERN = r'^[#＃]([^#＃\s]+(?:[+＋][^#＃\s]+)+)[#＃]$'
```

#### 5.1.2 ブロック終了パターン
```python
# ブロック終了（##または＃＃のみ）
BLOCK_END_PATTERN = r'^[#＃]{2}$'

# マーカー混在チェック（禁止パターン）
MIXED_MARKER_ERROR = r'(?:#[^#]*＃|＃[^＃]*#)'
```

#### 5.1.3 廃止されたパターン
```

#### 5.1.3 特殊パターン
```python
# コメント行（# の後にスペース）
COMMENT_PATTERN = r'^[#＃]\s+'

# 混在チェック（半角・全角混在）
MIXED_MARKER_PATTERN = r'(?:#[^#]*＃|＃[^＃]*#)'

# 属性の抽出
COLOR_ATTRIBUTE = r'color=([#]?[0-9a-fA-F]{6}|[a-zA-Z]+)'
# alt属性は削除されました（Phase 1完了）: None}
        
        for line_num, line in enumerate(lines, 1):
            element = self._parse_line(line, line_num, state)
            if element:
                document.add_element(element)
        
        return document
```

### 10.3 エラーハンドリング

```python
class NotationError:
    """記法エラーの基底クラス"""
    
    def __init__(self, line_num: int, message: str, fix_hint: str = None):
        self.line_num = line_num
        self.message = message
        self.fix_hint = fix_hint
    
    def format_user_friendly(self) -> str:
        """ユーザーフレンドリーなエラーメッセージ"""
        base = f"行 {self.line_num}: {self.message}"
        if self.fix_hint:
            base += f"\n  修正方法: {self.fix_hint}"
        return base
```

## 11. テストケース仕様

### 11.1 正常系テストケース（v3.0.0ブロック専用）

```python
# ブロック記法のみ（v3.0.0統一仕様）
test_cases_block = [
    ("""#太字#
重要な情報
##""", "太字", "重要な情報"),
    ("""＃イタリック＃
引用文
＃＃""", "イタリック", "引用文"),
    ("""#ハイライト color=#FF0000#
赤い背景
##""", "ハイライト", "赤い背景", {"color": "#FF0000"}),
    ("""#枠線#
内容
複数行
##""", "枠線", "内容
複数行"),
]

# 複合記法（ブロック形式）
test_cases_compound = [
    ("""#太字+イタリック#
強調引用
##""", ["太字", "イタリック"], "強調引用"),
    ("""＃枠線＋ハイライト color=yellow＃
注意ボックス
＃＃""", ["枠線", "ハイライト"], "注意ボックス", {"color": "yellow"}),
]

# 特別記法（目次）
test_cases_special = [
    ("""#目次#
##""", "目次", ""),  # 空内容が唯一許可される記法
]
```

### 11.2 異常系テストケース（v3.0.0対応）

```python
# エラーケース（v3.0.0で検出対象）
error_test_cases = [
    ("#太字# 内容", "InlineNotationError"),  # 単一行記法使用（廃止済み）
    ("#太字 内容#", "InlineNotationError"),  # 単一行記法使用（廃止済み）
    ("#太字 混在＃", "MixedMarkerError"),    # マーカー混在
    ("#太字#
内容", "UnclosedBlockError"),  # 終了マーカー##なし
    ("#無効キーワード#
内容
##", "InvalidKeywordError"),
    ("#太字+無効#
内容
##", "InvalidCompoundError"),
]
```

## 12. 実装上の注意事項

### 8.1 パーサー要件
- UTF-8エンコーディング必須
- 半角・全角の区別なし（`+`と`＋`両対応）
- 大文字・小文字の区別なし（将来的な英語対応）

### 8.2 HTML出力要件
- W3C HTML5準拠
- アクセシビリティ対応（適切なタグ・セマンティクス使用）
- CSSクラス名の一貫性

### 8.3 互換性
- 既存のMarkdown記法との混在は非推奨
- HTMLタグの直接記述は非推奨

## 13. 将来的な拡張

### 9.1 検討中の機能
- テーブル記法
- 数式記法
- コードブロック記法
- 注釈機能の拡張

### 9.2 特殊記法（後日実装予定）
- 脚注記法: `((内容))` （基本検証のみ実装済み）
- ルビ記法: `#ルビ 内容(読み)#` （Issue #661で実装済み）

## 14. バージョン管理

### 10.1 記法バージョン
- **Current**: v3.0.0 (ブロック記法統一・単一行記法完全廃止)
- **Previous**: v2.2.0-alpha (混在禁止・新キーワード対応)
- **Legacy**: v2.0.0-alpha, v1.0.0-alpha (全て廃止済み)
- **Target**: v3.0.0-stable (正式リリース時)

### 10.2 後方互換性
- **v3.0.0**: 破壊的変更・後方互換性完全破棄
- **v2.x以前**: 全て無効化・即時移行必須
- **v3.0.0以降**: 厳格なブロック記法のみサポート

## 15. 改訂履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|------------|------|----------|--------|
| 2.1.0-alpha | 2025-01-30 | Issue #679対応 Phase 1: 記法仕様の明確化、パターン定義追加、実装ガイドライン作成、エラーパターン詳細化 | Claude Code |
| 2.0.0-alpha | 2025-01-30 | #記法への全面移行、スマホ入力対応 | Claude Code |
| 1.0.0-alpha | 2025-01-29 | 初版作成、#記法採用（削除済み） | Claude Code |