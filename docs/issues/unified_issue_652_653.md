# 記法バリデーションシステムの包括的再設計

## 📋 Issue概要

Issue #652とIssue #653で報告された記法バリデーションの問題は、同一の根本原因から発生している技術的負債です。現在の`syntax_validator.py`における新旧記法の混在した複雑なロジックが、正しい記法でも誤ったエラーを発生させています。

## 🚨 現在の問題

### 1. 新記法のバリデーション不具合
**現象**: 正しいブロック形式でエラーが発生
```
#見出し1#
内容
#
```
**エラー**: `ブロック開始マーカーなしに # が見つかりました`

### 2. 旧記法の同一行記法未対応
**現象**: `;;;キーワード 内容;;;` 形式が未サポート
**エラー**: `ブロック内で新しいブロックが開始されています`

### 3. コメント行の誤判定  
**現象**: `# コメント` がマーカーとして誤認識
**エラー**: `未完了のマーカー: 終了マーカー # が見つかりません`

## 🔍 技術的根本原因

### 現状実装の問題
- **複雑な状態管理**: `in_block`, `in_new_block` による状態競合
- **記法判定の矛盾**: 新旧記法の判定ロジックが重複・競合
- **パターンマッチングの不備**: コメント行と記法マーカーの区別ができない

### 影響範囲
- `kumihan_formatter/core/syntax/syntax_validator.py` - メインバリデーター
- `kumihan_formatter/core/syntax/syntax_rules.py` - 記法ルール定義
- CLI変換機能全般の信頼性低下

## 🎯 求められる解決策

### 1. 記法仕様の明確化
**新記法 (# 記法)**:
- インライン: `#キーワード 内容#`
- ブロック: `#キーワード#\n内容\n#`
- コメント: `# コメント` (記法として扱わない)

**旧記法 (;;; 記法) - 削除済み (Phase 1完了)**:
- インライン: `;;;キーワード 内容;;;`
- ブロック: `;;;キーワード\n内容\n;;;`

### 2. バリデーターの全面再設計
- **単純化されたロジック**: 記法ごとの独立した処理
- **明確な優先順位**: 記法判定の競合解決
- **包括的なテストカバレッジ**: 全パターンの検証

### 3. 後方互換性の保証
- 既存コンテンツへの影響を最小化
- 段階的な移行サポート

## 📊 現状の実装状況

### サポート済み記法キーワード
```
太字, イタリック, 枠線, ハイライト, 見出し1-5, 
折りたたみ, ネタバレ, 目次, 画像
```

### 現在の判定ロジック構造
```python
# 新記法判定 (_validate_syntax L188-214)
if stripped == '#':           # 単独#の処理
elif re.match(r'^[#]+[^#\s]+$', stripped):  # ブロック開始

# 旧記法判定 (_validate_syntax L225-262)  
if stripped.startswith(";;;"):  # ブロック/インライン判定
```

## 🔧 技術的要件

### 修正対象ファイル
1. `kumihan_formatter/core/syntax/syntax_validator.py`
   - `_validate_syntax()` メソッドの全面再設計
   - `_validate_new_notation()` の改善
   - `_is_inline_notation()` の拡張

2. `kumihan_formatter/core/syntax/syntax_rules.py`
   - 記法パターンの明確化
   - 判定ロジックの単純化

### テスト要件
- 新旧記法の全パターン検証
- エッジケースの網羅的テスト
- 回帰テストの充実

## 📈 期待される成果

### 機能面
- ✅ 正しい記法でのエラー解消
- ✅ 同一行記法の完全サポート
- ✅ コメント行の適切な処理

### 品質面  
- ✅ バリデーションロジックの単純化
- ✅ 保守性の向上
- ✅ テストカバレッジの向上

## 🚀 実装計画

### Phase 1: 仕様策定 (1-2日)
- 記法仕様書の作成
- パターン定義の明確化

### Phase 2: コア実装 (3-5日)
- バリデーターの再設計
- テストスイートの充実

### Phase 3: 統合テスト (1-2日)
- 既存コンテンツでの動作確認
- 回帰テストの実行

## 📋 関連Issue
- Issue #652: 記法仕様の根本的見直し
- Issue #653: CLI変換機能の dict属性エラー (一部解決済み)

## 💡 備考
この統合対応により、Kumihan-Formatterの記法システムが安定し、ユーザーが記法を安心して使用できる環境が実現されます。