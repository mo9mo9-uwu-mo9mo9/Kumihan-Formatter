# 機能仕様書 - Kumihan-Formatter

## 1. 概要

このドキュメントは、Kumihan-Formatterの機能仕様を詳細に定義します。システム全体の機能要件、技術仕様、インターフェース設計を包括的に記述しています。

### 1.1 システム概要

Kumihan-Formatterは、独自のKumihan記法で書かれたテキストファイルを美しいHTML文書に変換するオフライン完結型のアプリケーションです。

### 1.2 設計原則

- **オフライン完結**: インターネット接続不要
- **非技術者向け**: 直感的で分かりやすいインターフェース
- **高品質出力**: 商用レベルの美しい組版
- **軽量・高速**: 最小限のリソースで高速処理

## 2. システムアーキテクチャ

### 2.1 コンポーネント構成

```
Kumihan-Formatter
├── CLI Interface          # コマンドライン インターフェース
├── GUI Interface          # グラフィカル ユーザーインターフェース
├── Core Engine           # コア変換エンジン
│   ├── Parser            # 記法解析器
│   ├── Validator         # 構文検証器
│   ├── Renderer          # HTML生成器
│   └── Template Engine   # テンプレート処理
├── File System           # ファイル操作
└── Error Handler         # エラー処理・メッセージ生成
```

### 2.2 データフロー

```
[入力テキスト] → [構文解析] → [検証] → [AST構築] → [HTML生成] → [出力ファイル]
     ↓              ↓         ↓         ↓           ↓
   [ファイル読込] → [エラー検出] → [警告生成] → [テンプレート適用] → [ファイル書込]
```

## 3. コア機能仕様

### 3.1 テキスト変換機能

#### 3.1.1 基本変換

**機能概要**: Kumihan記法テキストをHTMLに変換

**入力仕様**:
- ファイル形式: .txt
- エンコーディング: UTF-8
- 最大ファイルサイズ: 10MB
- 最大行数: 50,000行

**出力仕様**:
- ファイル形式: .html
- 文字エンコーディング: UTF-8
- CSS: インライン埋め込み
- JavaScript: 必要最小限（折りたたみ、ネタバレ機能のみ）

**処理フロー**:
1. ファイル読み込み・エンコーディング検証
2. 行単位での構文解析
3. AST（抽象構文木）構築
4. 構文検証・エラーチェック
5. HTML要素への変換
6. テンプレート適用
7. ファイル出力

#### 3.1.2 記法処理

**基本記法処理**:
```
入力: ;;;太字;;; 重要な情報
処理: KeywordParser → ASTNode(type="bold", content="重要な情報")
出力: <strong>重要な情報</strong>
```

**複合記法処理**:
```
入力: ;;;太字+枠線;;; 最重要情報
処理: 
  1. KeywordParser → ["太字", "枠線"]
  2. ASTNode(type="compound", keywords=["bold","border"], content="最重要情報")
  3. HTMLRenderer → <div class="box-border"><strong>最重要情報</strong></div>
```

**属性処理**:
```
入力: ;;;ハイライト color=#ffe6e6;;; 警告
処理:
  1. AttributeParser → keyword="ハイライト", attributes={"color": "#ffe6e6"}
  2. StyleGenerator → style="background-color: #ffe6e6"
  3. HTMLRenderer → <mark style="background-color: #ffe6e6">警告</mark>
```

### 3.2 構文検証機能

#### 3.2.1 リアルタイム検証

**検証対象**:
- 記法の基本構文（セミコロン、スペースなど）
- キーワードの有効性
- 属性の形式・値
- 複合記法の組み合わせ規則

**検証レベル**:
- **エラー**: 変換を停止する致命的な問題
- **警告**: 変換は継続するが改善を推奨する問題
- **情報**: 最適化のための提案

#### 3.2.2 構造検証

**階層構造チェック**:
- 見出しの論理的順序（見出し1→見出し2→見出し3）
- 目次の配置位置
- ブロック要素のネスト規則

**一貫性チェック**:
- カラーコードの形式統一
- 画像ファイルの存在確認
- リンク切れの検出

### 3.3 出力生成機能

#### 3.3.1 HTML生成

**基本HTML構造**:
```html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{document_title}}</title>
    <style>{{embedded_css}}</style>
</head>
<body>
    <div class="container">
        {{content}}
    </div>
    <script>{{minimal_javascript}}</script>
</body>
</html>
```

**CSS設計思想**:
- **レスポンシブ対応**: モバイル・タブレット・デスクトップ
- **印刷最適化**: A4サイズでの美しい印刷
- **アクセシビリティ**: 色覚多様性・スクリーンリーダー対応
- **カスタマイズ性**: CSS変数による色彩・フォント調整

#### 3.3.2 テンプレートシステム

**テンプレート種類**:
- `base.html.j2`: 標準テンプレート
- `base-with-source-toggle.html.j2`: ソース表示機能付き
- `docs.html.j2`: ドキュメント専用

**テンプレート変数**:
```python
template_context = {
    "document_title": str,
    "content": str,
    "toc_content": str,
    "css_styles": str,
    "javascript_code": str,
    "meta_info": dict,
    "custom_styles": dict
}
```

### 3.4 ファイル操作機能

#### 3.4.1 入力ファイル処理

**サポート形式**:
- プライマリ: .txt（UTF-8）
- 将来対応: .md（Markdown互換モード）

**ファイル検証**:
- エンコーディング自動検出・警告
- ファイルサイズ制限チェック
- 読み取り権限確認

**ディレクトリ構造**:
```
project/
├── scenario.txt          # 入力ファイル
├── images/               # 画像フォルダ
│   ├── map.jpg
│   └── npc.png
└── config.yaml          # 設定ファイル（オプション）
```

#### 3.4.2 出力ファイル処理

**出力ディレクトリ構造**:
```
dist/
├── index.html           # メインHTML
├── images/              # 画像ファイル（コピー）
│   ├── map.jpg
│   └── npc.png
└── metadata.json        # 変換情報（オプション）
```

**ファイル命名規則**:
- デフォルト: `index.html`
- カスタム: `{input_filename}.html`
- 競合回避: `{filename}_1.html`, `{filename}_2.html`

## 4. ユーザーインターフェース仕様

### 4.1 コマンドラインインターフェース（CLI）

#### 4.1.1 基本コマンド

```bash
# 基本変換
kumihan convert input.txt

# 出力先指定
kumihan convert input.txt -o output_dir/

# 監視モード
kumihan convert input.txt --watch

# 設定指定
kumihan convert input.txt --config custom.yaml
```

#### 4.1.2 コマンドオプション

| オプション | 短縮形 | 説明 | デフォルト値 |
|------------|--------|------|-------------|
| `--output` | `-o` | 出力ディレクトリ | `./dist` |
| `--no-preview` | | ブラウザプレビューを無効化 | False |
| `--watch` | `-w` | ファイル監視モード | False |
| `--config` | `-c` | 設定ファイルのパス | なし |
| `--template` | `-t` | テンプレート名 | `base` |
| `--no-syntax-check` | | 構文チェックをスキップ | False |
| `--verbose` | `-v` | 詳細ログ出力 | False |
| `--quiet` | `-q` | 最小限のログ出力 | False |

#### 4.1.3 進捗表示

```
変換を開始しています...
[████████████████████████████████] 100% 完了 (1.2秒)

変換結果:
✓ scenario.txt → dist/scenario.html
✓ 画像ファイル: 3個コピー
⚠ 警告: 2件（詳細はログを確認）
```

### 4.2 グラフィカルユーザーインターフェース（GUI）

#### 4.2.1 メインウィンドウ

**レイアウト構成**:
```
┌─────────────────────────────────────────┐
│ File  Edit  View  Help                  │ ← メニューバー
├─────────────────────────────────────────┤
│ [ファイルを選択] [設定] [変換実行]        │ ← ツールバー
├─────────────────────────────────────────┤
│ 入力ファイル: scenario.txt              │
│ 出力先: ./dist/                        │
│                                         │
│ ┌─ プレビュー ─────────────────────────┐ │
│ │ ;;;見出し1;;; 第1章                 │ │
│ │ 本文の内容がここに表示されます...     │ │
│ │                                     │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 変換状況: 待機中                        │ ← ステータスバー
└─────────────────────────────────────────┘
```

#### 4.2.2 ドラッグ&ドロップ対応

**操作フロー**:
1. テキストファイルをウィンドウにドロップ
2. 自動的にファイルパス設定
3. プレビュー表示更新
4. 変換ボタンが有効化

**対応ファイル形式**:
- `.txt`: プライマリ対応
- `.md`: 将来対応予定

### 4.3 エラー・警告表示

#### 4.3.1 CLI表示

```bash
❌ エラー: 15行目 - セミコロンが不足しています
   問題のある記法: ;;太字;;
   正しい記法: ;;;太字;;;

⚠️  警告: 画像ファイル「map.jpg」が見つかりません
   探索場所: images/map.jpg

ℹ️  情報: 見出し階層をスキップしています（見出し1→見出し3）
```

#### 4.3.2 GUI表示

**エラーダイアログ**:
- 重要度別の色分け（エラー:赤、警告:黄、情報:青）
- 行番号クリックで該当箇所へジャンプ
- 修正方法の詳細表示
- 「無視して続行」オプション

## 5. 設定・カスタマイズ機能

### 5.1 設定ファイル仕様

#### 5.1.1 YAML形式設定

```yaml
# kumihan-config.yaml
output:
  directory: "./dist"
  filename_pattern: "{input_name}.html"
  open_browser: true

template:
  name: "base"
  custom_css: "./custom.css"
  
colors:
  primary: "#333333"
  secondary: "#666666"
  accent: "#007bff"
  
validation:
  strict_mode: false
  warn_on_hierarchy_skip: true
  
images:
  max_width: 800
  quality: 85
  format: "original"
```

#### 5.1.2 設定項目詳細

**出力設定**:
- `directory`: 出力ディレクトリ
- `filename_pattern`: ファイル名パターン
- `open_browser`: 変換後の自動ブラウザ起動

**テンプレート設定**:
- `name`: 使用するテンプレート名
- `custom_css`: カスタムCSSファイルのパス

**検証設定**:
- `strict_mode`: 厳密検証モード
- `warn_on_hierarchy_skip`: 見出し階層スキップ警告

### 5.2 テーマ・スタイルカスタマイズ

#### 5.2.1 内蔵テーマ

1. **デフォルト**: 汎用的な読みやすいスタイル
2. **TRPG**: TRPGシナリオに特化したスタイル
3. **ミニマル**: 最小限の装飾
4. **プリント**: 印刷最適化スタイル

#### 5.2.2 カスタムCSS

**CSS変数によるカスタマイズ**:
```css
:root {
  --primary-color: #333333;
  --secondary-color: #666666;
  --accent-color: #007bff;
  --background-color: #ffffff;
  --text-color: #333333;
  --border-color: #dddddd;
  
  --font-family-sans: "Noto Sans JP", sans-serif;
  --font-family-serif: "Noto Serif JP", serif;
  --font-size-base: 16px;
  --line-height-base: 1.6;
}
```

## 6. パフォーマンス要件

### 6.1 処理速度

| ファイルサイズ | 行数 | 処理時間目標 | メモリ使用量 |
|----------------|------|-------------|-------------|
| ~100KB | ~500行 | 1秒以内 | 50MB以下 |
| ~500KB | ~2,500行 | 3秒以内 | 100MB以下 |
| ~2MB | ~10,000行 | 10秒以内 | 200MB以下 |
| ~10MB | ~50,000行 | 30秒以内 | 500MB以下 |

### 6.2 最適化戦略

**パフォーマンス最適化**:
1. **ストリーミング処理**: 大きなファイルのチャンク処理
2. **並列処理**: CPU多重化による高速化
3. **キャッシュ機能**: 部分的な再変換時の最適化
4. **メモリ管理**: ガベージコレクション最適化

**スケーラビリティ**:
- バッチ処理機能（複数ファイル一括変換）
- 監視モード（ファイル変更自動検出）
- プログレス表示（長時間処理の進捗表示）

## 7. セキュリティ・信頼性

### 7.1 セキュリティ要件

**ファイルアクセス制御**:
- 読み取り専用アクセス（入力ファイル）
- 指定ディレクトリ外へのアクセス禁止
- 実行可能ファイルの生成禁止

**入力検証**:
- ファイルサイズ制限
- パス・トラバーサル攻撃防止
- HTMLインジェクション防止

### 7.2 エラー処理・回復

**エラー分類と対応**:
1. **回復可能エラー**: 警告表示後に処理継続
2. **回復不可能エラー**: 適切なメッセージ表示後に終了
3. **システムエラー**: ログ記録とユーザー通知

**ログ管理**:
- エラーログの自動記録
- デバッグ情報の詳細出力（開発モード）
- ユーザープライバシー保護（個人情報除外）

## 8. 拡張性・保守性

### 8.1 プラグインアーキテクチャ

**将来的な拡張**:
- カスタムキーワード定義
- 外部レンダラー対応
- テーマパッケージシステム

### 8.2 国際化対応

**多言語サポート準備**:
- UIメッセージの外部化
- 右から左（RTL）レイアウト対応準備
- Unicode正規化処理

## 9. テスト仕様

### 9.1 テスト戦略

**テストレベル**:
1. **単体テスト**: 各コンポーネントの個別テスト
2. **統合テスト**: コンポーネント間の連携テスト
3. **システムテスト**: エンドツーエンドのテスト
4. **受け入れテスト**: ユーザーシナリオベーステスト

### 9.2 テストカバレッジ目標

**カバレッジ目標**:
- コードカバレッジ: 80%以上
- 機能カバレッジ: 100%
- エラーケースカバレッジ: 90%以上

## 10. デプロイメント・配布

### 10.1 配布形式

**対象プラットフォーム**:
- Windows: .exe（PyInstaller）
- macOS: .app（PyInstaller）
- Linux: AppImage
- クロスプラットフォーム: Python Wheel

### 10.2 インストール要件

**最小システム要件**:
- RAM: 2GB以上
- ストレージ: 100MB以上の空き容量
- Python: 3.12以上（開発者向け）

## 11. 改訂履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|------------|------|----------|--------|
| 1.0.0-alpha | 2025-01-29 | 初版作成、オフライン完結型仕様確定 | Claude Code |