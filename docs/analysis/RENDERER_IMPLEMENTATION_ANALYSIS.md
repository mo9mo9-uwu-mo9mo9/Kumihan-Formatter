# Renderer実装レンダリング分析レポート

> **Issue #93 Phase 1調査結果** - renderer.py実装レンダリング機能の完全マッピング

---

## 📋 レンダラーが対応するノードタイプ

### 1. 基本HTMLタグ

#### 1.1 ブロック要素
- **`p`** - 段落（`<p>content</p>`）
- **`div`** - 汎用ブロック（class属性サポート）
- **`h1-h5`** - 見出し（自動ID付与）
- **`ul`** - 順序なしリスト
- **`ol`** - 順序ありリスト
- **`li`** - リスト項目

#### 1.2 インライン要素
- **`strong`** - 太字（`<strong>content</strong>`）
- **`em`** - イタリック（`<em>content</em>`）

#### 1.3 自己完結型タグ
- **`br`** - 改行（`<br />`）
- **`hr`** - 水平線（`<hr />`）
- **`img`** - 画像（`<img />`）

### 2. 特殊ノードタイプ

#### 2.1 画像ノード（`image`）
```html
<img src="images/filename.jpg" alt="alt-text" />
```

**処理ロジック:**
- ファイルパスを `images/` プレフィックス付きで生成
- alt属性は自動またはマニュアル指定

#### 2.2 目次ノード（`toc`）
- パース時に検出されるが、レンダリング時は除外
- 見出し情報から自動で目次HTML生成
- 条件: 目次マーカーまたは見出し2つ以上

#### 2.3 エラーノード（`error`）
```html
<div style="background-color:#ffe6e6; padding: 10px; margin: 5px 0;">
    [ERROR: message] (行: line_number)
    content
</div>
```

---

## 🎯 ブロックキーワード定義（レンダラー内）

```python
block_keywords = {
    "太字": {"tag": "strong"},
    "イタリック": {"tag": "em"},
    "枠線": {"tag": "div", "class": "box"},
    "ハイライト": {"tag": "div", "class": "highlight"},
    "見出し1": {"tag": "h1"},
    "見出し2": {"tag": "h2"},
    "見出し3": {"tag": "h3"},
    "見出し4": {"tag": "h4"},
    "見出し5": {"tag": "h5"},
}
```

**⚠️ 重要**: パーサーの `DEFAULT_BLOCK_KEYWORDS` と**完全に同一**

---

## 🔗 複合記法のレンダリング処理

### ネスト順序（外側→内側）
1. **div系** (枠線、ハイライト)
2. **見出し系** (h1-h5)
3. **strong** (太字)
4. **em** (イタリック)

### 色属性処理
- **ハイライト専用**: `color=#hex` → `style="background-color:#hex"`
- **適用位置**: 最内側のハイライト要素のみ

---

## 🚀 高度な機能

### 1. ブロック内リスト処理（`_render_block_with_list`）
```kumihan
;;;枠線
テキスト内容
- リスト項目1
- リスト項目2
;;;
```

**処理特徴:**
- ブロック内のリスト記法を自動検出
- 混在コンテンツ（テキスト + リスト）を適切に分離
- キーワード付きリスト項目もサポート

### 2. キーワード付きリスト項目処理（`_process_keyword_in_text`）
```kumihan
- ;;;太字+ハイライト color=#ff0000;;; テキスト
```

**出力:**
```html
<li><div class="highlight" style="background-color:#ff0000"><strong>テキスト</strong></div></li>
```

### 3. 目次自動生成（`_generate_toc_html`）
- 見出しレベルに応じた階層構造
- 自動リンク生成（`href="#heading-N"`）
- 空の目次でもHTMLスケルトン生成

### 4. テンプレート切り替え
- **標準**: `base.html.j2`
- **ソース表示付き**: `base-with-source-toggle.html.j2`
- **カスタム**: 任意テンプレート指定可能

---

## 📊 属性処理とCSSクラス

### サポートされる属性
- **`class`** - CSSクラス名
- **`style`** - インラインスタイル
- **`id`** - 要素ID（見出しで自動付与）
- **`color`** - 背景色（style属性に変換）

### CSSクラス一覧
- **`.box`** - 枠線ブロック
- **`.highlight`** - ハイライトブロック
- **`.toc-list`** - 目次リスト

---

## ⚠️ エラーハンドリング

### 1. 未知キーワードエラー
```html
<span style="background-color:#ffe6e6">[ERROR: 未知のキーワード: keyword] content</span>
```

### 2. 空キーワードエラー
```html
<span style="background-color:#ffe6e6">[ERROR: キーワードが指定されていません] content</span>
```

### 3. パースエラー
```html
<div style="background-color:#ffe6e6; padding: 10px; margin: 5px 0;">
    [ERROR: message] (行: line)
    content
</div>
```

---

## 🔄 レンダリングフロー

### メインレンダリング
1. **見出し収集** - 目次生成用
2. **目次判定** - マーカーまたは見出し2つ以上
3. **ノード変換** - ASTをHTML変換
4. **テンプレート適用** - 最終HTML生成

### ノード個別処理
1. **エラーノード** - 特別なエラー表示
2. **画像ノード** - images/パス処理
3. **ブロック内リスト** - 混在コンテンツ処理
4. **通常ノード** - 標準HTML変換

---

## 📋 実装品質評価

| 機能カテゴリ | 実装状況 | 品質 |
|-------------|----------|------|
| 基本タグ生成 | ✅ 完全実装 | 高 |
| 複合記法 | ✅ 完全実装 | 高 |
| エラー処理 | ✅ 完全実装 | 高 |
| 目次生成 | ✅ 完全実装 | 中 |
| 画像処理 | ✅ 完全実装 | 高 |
| ブロック内リスト | ✅ 完全実装 | 中 |
| テンプレート | ✅ 完全実装 | 高 |

---

## 🎯 パーサーとの整合性

### ✅ 一致している部分
- ブロックキーワード定義
- 複合記法のネスト順序
- 色属性処理ロジック
- エラーメッセージフォーマット

### ⚠️ 実装上の依存関係
- レンダラーはパーサーのNode構造に依存
- パーサーの `attributes` 構造をそのまま利用
- エラーノードの構造が固定

---

このレポートは Issue #93 の Phase 1 調査結果（renderer.py部分）です。
次は Phase 2 のドキュメント記載内容精査に進みます。