# Parser実装記法分析レポート

> **Issue #93 Phase 1調査結果** - parser.py実装記法の完全マッピング

---

## 📋 実装されている記法一覧

### 1. ブロックマーカー記法

#### 1.1 単一行記法（;;;keyword;;;）
```kumihan
;;;太字;;;
;;;イタリック;;;
;;;枠線;;;
;;;ハイライト;;;
;;;ハイライト color=#ff0000;;;
;;;見出し1;;;
;;;見出し2;;;
;;;見出し3;;;
;;;見出し4;;;
;;;見出し5;;;
```

**特徴:**
- 内容が空の場合に使用
- 単一行で完結
- color属性サポート（ハイライトのみ）

#### 1.2 ブロック記法（;;;keyword\n内容\n;;;）
```kumihan
;;;太字
内容テキスト
;;;

;;;枠線+ハイライト color=#ffffcc
複合ブロック内容
;;;
```

**特徴:**
- 複数行の内容を持つ
- 複合キーワード対応（`+`または`＋`で連結）
- ネスト内にリスト埋め込み可能

### 2. 特殊記法

#### 2.1 目次記法（単一行のみ）
```kumihan
;;;目次;;;
```

**実装詳細:**
- 行112-118: 最優先で処理
- 見出しから自動生成
- ブロック形式は**非対応**

#### 2.2 画像記法（2パターン）

**パターンA: シンプル記法（単一行）**
```kumihan
;;;filename.jpg;;;
;;;screenshot.png;;;
;;;diagram.svg;;;
```

**対応拡張子:** png, jpg, jpeg, gif, webp, svg

**パターンB: 詳細記法（ブロック形式）**
```kumihan
;;;画像 alt=説明文
filename.jpg
;;;
```

### 3. リスト記法

#### 3.1 通常リスト
```kumihan
- 項目1
- 項目2
- 項目3
```

#### 3.2 番号付きリスト
```kumihan
1. 項目1
2. 項目2
3. 項目3
```

#### 3.3 キーワード付きリスト
```kumihan
- ;;;太字;;; テキスト
- ;;;枠線;;; テキスト
- ;;;太字+ハイライト color=#ff0000;;; テキスト
```

### 4. 段落・改行記法

#### 4.1 段落（空行区切り）
```kumihan
段落1の内容

段落2の内容
```

#### 4.2 改行（連続行）
```kumihan
1行目
2行目
3行目
```
→ `1行目<br>2行目<br>3行目`

### 5. エスケープ・コメント記法

#### 5.1 エスケープ記法
```kumihan
### ← これは ;;; として表示される
```

#### 5.2 コメント記法
```kumihan
# これはコメント行（無視される）
```

---

## 🎯 デフォルトキーワード定義

```python
DEFAULT_BLOCK_KEYWORDS = {
    "太字": {"tag": "strong"},
    "イタリック": {"tag": "em"},
    "枠線": {"tag": "div", "class": "box"},
    "ハイライト": {"tag": "div", "class": "highlight"},
    "見出し1": {"tag": "h1"},
    "見出し2": {"tag": "h2"},
    "見出し3": {"tag": "h3"},
    "見出し4": {"tag": "h4"},
    "見出し5": {"tag": "h5"},
}
```

---

## 🔗 複合記法の実装詳細

### 複合キーワード処理
- **連結文字**: `+` または `＋`
- **ネスト順序**: 外側→内側
  1. div系（枠線、ハイライト）
  2. 見出し系（h1-h5）
  3. strong（太字）
  4. em（イタリック）

### 色指定処理
- **パターン**: `color=#hex`
- **対象**: ハイライトのみ
- **記述位置**: キーワードの後
- **例**: `;;;ハイライト color=#ff0000;;;`

---

## ⚠️ 重要な実装上の制約

### 1. 目次記法
- ✅ `;;;目次;;;` （単一行）
- ❌ `;;;目次\n内容\n;;;` （ブロック形式）

### 2. 画像記法
- ✅ `;;;filename.jpg;;;` （自動alt）
- ✅ `;;;画像 alt=説明\nfilename.jpg\n;;;` （手動alt）
- ❌ `;;;画像 alt=説明;;;filename` （ドキュメント記載の形式）

### 3. エラーハンドリング
- 未知キーワード → 候補提案付きエラー
- 閉じマーカー不足 → 行番号付きエラー
- 空キーワード → エラーメッセージ

---

## 📊 実装状況サマリー

| 記法カテゴリ | 実装状況 | 備考 |
|-------------|----------|------|
| ブロック記法 | ✅ 完全実装 | 単一行・ブロック両対応 |
| 複合記法 | ✅ 完全実装 | ネスト順序制御あり |
| 目次記法 | ✅ 単一行のみ | ブロック形式は非対応 |
| 画像記法 | ✅ 2パターン対応 | シンプル・詳細両対応 |
| リスト記法 | ✅ 完全実装 | キーワード付き対応 |
| エスケープ | ✅ 実装済み | ### → ;;; 変換 |
| コメント | ✅ 実装済み | # 行頭コメント |

---

このレポートは Issue #93 の Phase 1 調査結果です。
次は renderer.py のサポートタグ確認に進みます。