# SYNTAX_REFERENCE.md 乖離分析レポート

> **Issue #93 Phase 2調査結果** - ドキュメントと実装の**深刻な乖離**発見

---

## 🚨 **重大な乖離一覧**

### 1. 目次記法【超重要】

#### ❌ ドキュメント記載（誤り）
```kumihan
;;;目次
;;;
```

#### ✅ 実装（正しい）
```kumihan
;;;目次;;;
```

**問題点**: ドキュメントは**ブロック形式**を記載しているが、実装は**単一行形式のみ**対応。ユーザーが間違った記法を学習してしまう。

### 2. 画像記法【重要】

#### ❌ ドキュメント記載（不完全）
```kumihan
;;;画像 alt=画像の説明
ファイル名.jpg
;;;
```

#### ✅ 実装（より柔軟）
```kumihan
# パターン1: シンプル記法（ドキュメントに記載なし）
;;;filename.jpg;;;

# パターン2: 詳細記法（ドキュメント記載）
;;;画像 alt=説明文
filename.jpg
;;;
```

**問題点**: シンプル記法がドキュメントに一切記載されていない。

### 3. エスケープ記法【中程度】

#### ❌ ドキュメント記載（大幅に誤り）
```kumihan
;;;マーカーを文字として表示したい場合
###;;;###
この部分は ;;; がそのまま表示されます
###;;;###
```

#### ✅ 実装（正しい）
```kumihan
### ← これは ;;; として表示される
```

**問題点**: 実装は単純な行頭 `###` → `;;;` 変換だが、ドキュメントは複雑なブロック記法を記載。

---

## 📊 **正誤対照表**

| 記法 | ドキュメント | 実装 | 状況 |
|------|-------------|------|------|
| **目次** | `;;;目次\n;;;` | `;;;目次;;;` | ❌ **完全に誤り** |
| **画像（シンプル）** | 記載なし | `;;;file.jpg;;;` | ❌ **記載漏れ** |
| **画像（詳細）** | `;;;画像 alt=\nfile\n;;;` | 同じ | ✅ 正しい |
| **エスケープ** | `###;;;###` | `###` | ❌ **大幅に誤り** |
| **太字** | `;;;太字\n内容\n;;;` | 同じ | ✅ 正しい |
| **複合記法** | `;;;太字＋イタリック;;;` | `;;;太字+イタリック;;;` | ⚠️ **連結文字** |
| **リスト** | `- ;;;太字;;; テキスト` | 同じ | ✅ 正しい |
| **見出し** | `;;;見出し1\n内容\n;;;` | 同じ | ✅ 正しい |

---

## 🔍 **詳細分析**

### 目次記法の深刻な問題

**実装解析**:
```python
# parser.py 行112-118
if marker_line == ";;;目次;;;":
    self.current += 1
    return Node(type="toc", content="", attributes={})
```

**結論**: 実装は単一行 `;;;目次;;;` のみ認識。ブロック形式は**一切サポートされていない**。

### 画像記法の実装ギャップ

**実装解析**:
```python
# parser.py 行120-130
if re.match(r'^[^/\\]+\.(png|jpg|jpeg|gif|webp|svg)$', content, re.IGNORECASE):
    self.current += 1
    return Node(type="image", content=content, attributes={"alt": content})
```

**結論**: `;;;filename.jpg;;;` 形式が完全実装されているが、ドキュメントに記載なし。

### 連結文字の微細な違い

**ドキュメント**: `;;;太字＋イタリック;;;` （全角プラス）
**実装**: 両方対応 `;;;太字+イタリック;;;` または `;;;太字＋イタリック;;;`

---

## 📋 **その他の問題点**

### 1. カスタムマーカーの記載

ドキュメント333-352行に以下の記載：
```kumihan
;;;警告
;;;重要
;;;注釈
;;;コード
```

**実装確認**: これらは標準では実装されておらず、設定ファイル使用時のみ利用可能。しかし、設定ファイルの実装詳細は調査が必要。

### 2. alt属性の必須性

**ドキュメント記載**: "alt属性は必須（アクセシビリティ対応）"
**実装**: シンプル記法では自動でファイル名をalt属性に設定

---

## 🎯 **修正優先度**

### 🔴 **緊急修正（即座対応）**
1. **目次記法**: `;;;目次;;;` （単一行）に修正
2. **画像シンプル記法**: `;;;filename.jpg;;;` の記載追加
3. **エスケープ記法**: `###` の正しい説明に修正

### 🟡 **重要修正（近日対応）**
1. **カスタムマーカー**: 実装状況の調査と記載修正
2. **連結文字**: 全角・半角両対応の明記
3. **alt属性**: 自動設定の説明追加

### 🟢 **軽微修正（余裕あるとき）**
1. **サンプルコード**: 実際の動作に合わせた修正
2. **説明文**: より正確な表現への修正

---

## 📈 **影響度評価**

| 項目 | 影響度 | 理由 |
|------|-------|------|
| **ユーザビリティ** | **超高** | 間違った記法を学習してしまう |
| **品質** | **高** | ドキュメントの信頼性が損なわれる |
| **開発効率** | **中** | 開発者も混乱する可能性 |
| **保守性** | **高** | 不整合により保守が困難 |

---

## 🛠️ **推奨対応アクション**

### 即座実行
1. **SYNTAX_REFERENCE.md の緊急修正**
2. **実装との整合性確認**
3. **他ドキュメントの類似問題調査**

### 中期対応
1. **CI/CDでのドキュメント整合性チェック追加**
2. **自動テストでの記法検証強化**
3. **ドキュメント更新プロセスの見直し**

---

**結論**: SYNTAX_REFERENCE.md には複数の重大な乖離があり、**緊急修正が必要**です。特に目次記法の誤りは、ユーザーが正しく動作しない記法を学習してしまう深刻な問題です。