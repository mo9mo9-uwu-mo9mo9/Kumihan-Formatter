# リファクタリングガイドライン

> **Kumihan-Formatter リファクタリング基準と手順**  
> **目的**: コード品質を維持し、技術的負債を管理するための明確な基準を提供  
> **対象**: 開発者、メンテナー、コントリビューター

## 🎯 概要

このガイドラインは、Kumihan-Formatterプロジェクトにおけるリファクタリングの判断基準、優先度、実施手順を明文化したものです。

## 📊 リファクタリング判断基準

### ファイルレベル基準

| 優先度 | 行数 | 複雑度 | 対応 |
|--------|------|--------|------|
| 🚨 **緊急** | 300行超過 | 15以上 | 即座にリファクタリング |
| 🔴 **高** | 250行超過 | 12以上 | 次回作業時に対応 |
| 🟡 **中** | 200行超過 | 10以上 | 機能追加時に考慮 |
| 🟢 **低** | 150行以下 | 8以下 | 現状維持 |

### 関数レベル基準

| 優先度 | 行数 | 複雑度 | 対応 |
|--------|------|--------|------|
| 🚨 **緊急** | 50行超過 | 8以上 | 即座に分割 |
| 🔴 **高** | 40行超過 | 6以上 | 次回作業時に分割 |
| 🟡 **中** | 30行超過 | 5以上 | 機能追加時に検討 |
| 🟢 **低** | 20行以下 | 3以下 | 現状維持 |

### クラスレベル基準

| 優先度 | 行数 | 責任 | 結合度 | 対応 |
|--------|------|------|--------|------|
| 🚨 **緊急** | 200行超過 | 過多 | 高 | 即座に分割 |
| 🔴 **高** | 150行超過 | 多い | 中高 | 次回作業時に分割 |
| 🟡 **中** | 100行超過 | 普通 | 中 | 機能追加時に検討 |
| 🟢 **低** | 80行以下 | 単一 | 低 | 現状維持 |

## 🎯 リファクタリング優先度マトリックス

### 緊急対応が必要な指標

以下の条件を満たすコードは **即座にリファクタリング** を実施：

1. **巨大ファイル**: 300行を超える単一ファイル
2. **複雑な関数**: 50行または複雑度8を超える関数
3. **責任過多クラス**: 200行を超える単一クラス
4. **深いネスト**: 4階層を超えるネスト構造
5. **重複コード**: 同一ロジックが3箇所以上に出現

### 高優先度指標

以下の条件を満たすコードは **次回作業時に対応**：

1. **大きなファイル**: 250行を超える単一ファイル
2. **複雑な関数**: 40行または複雑度6を超える関数
3. **大きなクラス**: 150行を超える単一クラス
4. **結合度の高いモジュール**: 多数の外部依存を持つモジュール

## 🔧 リファクタリング手順

### Phase 1: 事前準備

1. **テストの確認**
   ```bash
   # 既存テストの実行
   make test
   
   # カバレッジ確認
   make coverage
   ```

2. **品質チェック**
   ```bash
   # 静的解析実行
   make lint
   
   # アーキテクチャ検証
   make arch-check
   ```

3. **Issue作成**
   - リファクタリング対象と理由を明記
   - ラベル `リファクタリング` を付与

### Phase 2: リファクタリング実施

1. **小さな単位での実施**
   - 1つの関数・クラスずつ対応
   - 機能変更とリファクタリングを分離

2. **テスト駆動リファクタリング**
   ```bash
   # 各変更後にテスト実行
   make test
   
   # 品質チェック
   make pre-commit
   ```

3. **コミット単位の最適化**
   - 1つのリファクタリング = 1つのコミット
   - 明確なコミットメッセージ

### Phase 3: 検証・完了

1. **品質確認**
   ```bash
   # 全品質チェック実行
   make pre-commit
   
   # 統合テスト実行
   make integration-test
   ```

2. **レビュー準備**
   - Before/After の比較
   - 性能への影響確認

3. **ドキュメント更新**
   - 必要に応じてAPIドキュメント更新
   - アーキテクチャ図の更新

## 🛠️ 自動化ツール

### リファクタリング候補検出

```bash
# 複雑度チェック
make complexity-check

# 重複コード検出
make duplication-check

# 技術的負債スコア算出
make tech-debt-score
```

### 継続的監視

```bash
# 定期的な品質チェック
make refactor-check

# 品質トレンド分析
make quality-trend
```

## 📋 チェックリスト

### リファクタリング前
- [ ] 既存テストが全て通る
- [ ] 対象コードの理解完了
- [ ] リファクタリング計画策定
- [ ] Issue作成・ラベル付与

### リファクタリング中
- [ ] 小さな単位で実施
- [ ] 各変更後にテスト実行
- [ ] 機能変更との分離
- [ ] 適切なコミットメッセージ

### リファクタリング後
- [ ] 全テストが通る
- [ ] 品質チェックが通る
- [ ] 性能劣化がない
- [ ] ドキュメント更新完了

## 🎯 期待効果

1. **客観的判断**: 数値基準による明確な判断
2. **効率的改善**: 優先度に基づく効率的なリファクタリング
3. **品質向上**: 継続的な技術的負債の解消
4. **保守性向上**: 読みやすく変更しやすいコードベース

## 🔗 関連ドキュメント

- [ARCHITECTURE_PRINCIPLES.md](ARCHITECTURE_PRINCIPLES.md) - アーキテクチャ原則
- [REFACTORING_SUMMARY.md](REFACTORING_SUMMARY.md) - 過去のリファクタリング実績
- [TESTING.md](TESTING.md) - テスト戦略
- [STYLE_GUIDE.md](STYLE_GUIDE.md) - コーディング規約

---

**最終更新**: 2025-07-01  
**バージョン**: 1.0.0