# Kumihan-Formatter ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ v2.0

> **å“è³ªã‚’ä¿ã¡ãªãŒã‚‰åŠ¹ç‡çš„ãªãƒ†ã‚¹ãƒˆè¨­è¨ˆ** - ã‚¼ãƒ­ã‹ã‚‰ã®æ ¹æœ¬çš„è¦‹ç›´ã—
> **ä½œæˆæ—¥**: 2025-01-28
> **å¯¾è±¡**: Issue #630 æŠ€è¡“çš„è² å‚µè§£æ¶ˆãƒ»ãƒ†ã‚¹ãƒˆæˆ¦ç•¥è¦‹ç›´ã—

---

## ğŸ¯ æˆ¦ç•¥æ¦‚è¦

### ç¾çŠ¶èªè­˜
- **ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆè³‡ç”£**: æ©Ÿèƒ½ã—ãªã„ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å›°é›£
- **é–‹ç™ºé˜»å®³è¦å› **: ãƒ†ã‚¹ãƒˆä¿®æ­£ã«é–‹ç™ºæ™‚é–“ã®å¤§åŠã‚’æ¶ˆè²»
- **å“è³ªç›®æ¨™**: é«˜åº¦ãªå“è³ªã‚’ç¶­æŒã—ã¤ã¤ã€é–‹ç™ºåŠ¹ç‡ã‚’åŠ‡çš„æ”¹å–„

### åŸºæœ¬æ–¹é‡
**ã€ŒContract-First Testingã€** - é‡è¦ãªå¥‘ç´„ã®ã¿ãƒ†ã‚¹ãƒˆã—ã€å®Ÿè£…è©³ç´°ã¯ãƒ†ã‚¹ãƒˆã—ãªã„

---

## ğŸ“Š ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ†æ

### ã‚³ã‚¢ä¾¡å€¤ãƒ•ãƒ­ãƒ¼ç‰¹å®š

```mermaid
graph TD
    A[å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«] --> B[æ§‹æ–‡è§£æ]
    B --> C[ASTç”Ÿæˆ]
    C --> D[ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°]
    D --> E[HTMLå‡ºåŠ›]

    F[CLI] --> B
    G[GUI] --> B

    H[ã‚­ãƒ£ãƒƒã‚·ãƒ¥] -.-> C
    I[ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°] -.-> B
    J[è¨­å®šç®¡ç†] -.-> D
```

### é‡è¦åº¦ãƒãƒˆãƒªã‚¯ã‚¹

| æ©Ÿèƒ½é ˜åŸŸ | ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤ | æŠ€è¡“ãƒªã‚¹ã‚¯ | ãƒ†ã‚¹ãƒˆå„ªå…ˆåº¦ |
|---------|-------------|-----------|------------|
| **æ§‹æ–‡è§£æ** | ğŸ”´ Critical | ğŸ”´ High | **P0** |
| **ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°** | ğŸ”´ Critical | ğŸŸ¡ Medium | **P0** |
| **CLI Interface** | ğŸŸ¡ High | ğŸŸ¢ Low | **P1** |
| **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°** | ğŸŸ¡ High | ğŸŸ¡ Medium | **P1** |
| **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½** | ğŸŸ¢ Medium | ğŸ”´ High | **P2** |
| **GUI** | ğŸŸ¢ Medium | ğŸŸ¡ Medium | **P3** |
| **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹** | ğŸŸ¢ Low | ğŸŸ¡ Medium | **P3** |

---

## ğŸ—ï¸ 3å±¤ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### Layer 1: Contract Tests (30%)
**ç›®çš„**: é‡è¦ãªå…¬é–‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®å¥‘ç´„ã‚’ä¿è¨¼

```python
# ä¾‹: æ§‹æ–‡è§£æã®å¥‘ç´„ãƒ†ã‚¹ãƒˆ
def test_parser_contract():
    """åŸºæœ¬çš„ãªæ§‹æ–‡ãŒæ­£ã—ãè§£æã•ã‚Œã‚‹ã“ã¨ã‚’ä¿è¨¼"""
    input_text = ";;;å¤ªå­—;;;å¼·èª¿ãƒ†ã‚­ã‚¹ãƒˆ;;;"
    result = KumihanParser().parse(input_text)

    assert result.type == "bold"
    assert result.content == "å¼·èª¿ãƒ†ã‚­ã‚¹ãƒˆ"
    # å®Ÿè£…è©³ç´°ã¯ãƒ†ã‚¹ãƒˆã—ãªã„
```

**å¯¾è±¡**:
- `KumihanParser.parse()` - æ§‹æ–‡è§£æå¥‘ç´„
- `HTMLRenderer.render()` - ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¥‘ç´„
- `ConvertCommand.execute()` - CLIå¥‘ç´„
- `FileOperations.read/write()` - ãƒ•ã‚¡ã‚¤ãƒ«IOå¥‘ç´„

### Layer 2: Integration Tests (60%)
**ç›®çš„**: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã®é€£æºã¨ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ•ãƒ­ãƒ¼ã‚’æ¤œè¨¼

```python
def test_full_conversion_pipeline():
    """å…¥åŠ›â†’è§£æâ†’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°â†’å‡ºåŠ›ã®å…¨ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ"""
    input_file = create_test_file("sample.txt")
    output_file = "output.html"

    # å®Ÿéš›ã®ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
    result = subprocess.run([
        "python", "-m", "kumihan_formatter",
        "convert", input_file, output_file
    ])

    assert result.returncode == 0
    assert Path(output_file).exists()

    # å‡ºåŠ›å“è³ªã®æœ€å°é™ãƒã‚§ãƒƒã‚¯
    content = Path(output_file).read_text()
    assert "<html>" in content
    assert "å¤ªå­—" in content
```

**ã‚¹ã‚³ãƒ¼ãƒ—**:
- åŸºæœ¬å¤‰æ›ãƒ•ãƒ­ãƒ¼
- ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼å¯¾å¿œ
- CLI/GUIã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

### Layer 3: Property-Based Tests (10%)
**ç›®çš„**: å¤§é‡ã®ãƒ©ãƒ³ãƒ€ãƒ å…¥åŠ›ã§ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã‚’ç™ºè¦‹

```python
from hypothesis import given, strategies as st

@given(st.text(min_size=1, max_size=1000))
def test_parser_never_crashes(input_text):
    """ã©ã‚“ãªå…¥åŠ›ã§ã‚‚ãƒ‘ãƒ¼ã‚µãƒ¼ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãªã„"""
    try:
        result = KumihanParser().parse(input_text)
        # çµæœã®è©³ç´°ã¯å•ã‚ãªã„ã€ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãªã‘ã‚Œã°OK
        assert result is not None
    except KnownParsingError:
        # æ—¢çŸ¥ã®ã‚¨ãƒ©ãƒ¼ã¯è¨±å®¹
        pass
```

---

## ğŸš€ å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚ºè¨ˆç”»

### Phase 1: åŸºç›¤æ•´å‚™ (Week 1)
**ç›®æ¨™**: æœ€å°é™ã®CI/CDç’°å¢ƒæ§‹ç¯‰

```yaml
# æ–°ã—ã„ .github/workflows/test-v2.yml
name: Test Strategy v2.0
on: [push, pull_request]

jobs:
  contract-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Contract Tests
        run: pytest tests/contracts/ -v --timeout=30

  integration-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Integration Tests
        run: pytest tests/integration/ -v --timeout=120
```

**æˆæœç‰©**:
- [ ] æ–°ãƒ†ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
- [ ] åŸºæœ¬CIè¨­å®š
- [ ] æœ€åˆã®Contract Test

### Phase 2: Contract Testså®Ÿè£… (Week 2)
**é‡ç‚¹**: P0æ©Ÿèƒ½ã®å¥‘ç´„ãƒ†ã‚¹ãƒˆä½œæˆ

```
tests/
â”œâ”€â”€ contracts/           # Contract Tests
â”‚   â”œâ”€â”€ test_parser_contract.py      # æ§‹æ–‡è§£æå¥‘ç´„
â”‚   â”œâ”€â”€ test_renderer_contract.py    # ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¥‘ç´„
â”‚   â””â”€â”€ test_cli_contract.py         # CLIå¥‘ç´„
â”œâ”€â”€ integration/         # Integration Tests
â”‚   â”œâ”€â”€ test_full_pipeline.py       # E2Eãƒ•ãƒ­ãƒ¼
â”‚   â””â”€â”€ test_error_scenarios.py     # ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹
â””â”€â”€ properties/          # Property-based Tests
    â””â”€â”€ test_robustness.py          # å …ç‰¢æ€§ãƒ†ã‚¹ãƒˆ
```

**å“è³ªåŸºæº–**:
- Contract Tests: 30ãƒ†ã‚¹ãƒˆä»¥å†…
- å®Ÿè¡Œæ™‚é–“: 30ç§’ä»¥å†…
- å¤±æ•—ç‡: 0%

### Phase 3: Integration Testså®Ÿè£… (Week 3-4)
**é‡ç‚¹**: å®Ÿç”¨çš„ãªã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ

**ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªä¾‹**:
```python
scenarios = [
    # åŸºæœ¬æ©Ÿèƒ½
    "basic_formatting",      # åŸºæœ¬çš„ãªè£…é£¾
    "complex_document",      # è¤‡é›‘ãªæ–‡æ›¸æ§‹é€ 
    "japanese_content",      # æ—¥æœ¬èªå‡¦ç†

    # ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹
    "malformed_syntax",      # ä¸æ­£ãªæ§‹æ–‡
    "large_file",           # å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«
    "encoding_issues",      # ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å•é¡Œ

    # ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
    "windows_paths",        # Windowsãƒ‘ã‚¹å‡¦ç†
    "macos_unicode",        # macOS Unicodeå‡¦ç†
]
```

### Phase 4: æ—§ãƒ†ã‚¹ãƒˆå‰Šé™¤ãƒ»ç§»è¡Œ (Week 5)
**å®‰å…¨ãªç§»è¡Œæ‰‹é †**:

1. **æ–°ãƒ†ã‚¹ãƒˆå“è³ªç¢ºèª**
   ```bash
   # æ–°ãƒ†ã‚¹ãƒˆã§ã®å“è³ªç¢ºèª
   pytest tests/contracts tests/integration -v
   coverage run --source=kumihan_formatter -m pytest
   coverage report --show-missing
   ```

2. **æ®µéšçš„å‰Šé™¤**
   ```bash
   # æ—§ãƒ†ã‚¹ãƒˆã‚’æ®µéšçš„ã«ç„¡åŠ¹åŒ–
   git mv tests/unit tests/_old_unit
   git mv tests/legacy tests/_old_legacy

   # CIè¨­å®šæ›´æ–°
   # pytest tests/ â†’ pytest tests/contracts tests/integration
   ```

3. **æ¤œè¨¼æœŸé–“** (1é€±é–“)
   - æ–°ãƒ†ã‚¹ãƒˆã§ã®CIæˆåŠŸç‡ç¢ºèª
   - å®Ÿéš›ã®ãƒã‚°ç™ºè¦‹èƒ½åŠ›ç¢ºèª
   - å®Ÿè¡Œæ™‚é–“ãƒ»ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§è©•ä¾¡

---

## ğŸ“ˆ å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹

### æˆåŠŸåŸºæº–

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | ç¾åœ¨ | ç›®æ¨™ | æ¸¬å®šæ–¹æ³• |
|-----------|------|------|---------|
| **CIå®Ÿè¡Œæ™‚é–“** | 15-20åˆ† | 3åˆ†ä»¥å†… | GitHub Actions |
| **ãƒ†ã‚¹ãƒˆæˆåŠŸç‡** | 60-80% | 99%+ | 7æ—¥é–“å¹³å‡ |
| **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“** | é€±20æ™‚é–“ | é€±2æ™‚é–“ | ä½œæ¥­ãƒ­ã‚° |
| **ãƒã‚°ç™ºè¦‹ç‡** | ä½ | é«˜ | Issueè¿½è·¡ |
| **é–‹ç™ºé€Ÿåº¦** | ä½ä¸‹ | å‘ä¸Š | æ©Ÿèƒ½å®Ÿè£…æ™‚é–“ |

### å“è³ªã‚²ãƒ¼ãƒˆ

```yaml
# å“è³ªåŸºæº–ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯
quality_gates:
  contract_tests:
    max_execution_time: 30s
    min_success_rate: 100%
    max_test_count: 30

  integration_tests:
    max_execution_time: 120s
    min_success_rate: 95%
    max_test_count: 50

  property_tests:
    max_execution_time: 60s
    min_success_rate: 90%
    hypothesis_examples: 100
```

---

## ğŸ› ï¸ æŠ€è¡“é¸æŠ

### ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- **pytest**: ä¸»è¦ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- **hypothesis**: Property-based testing
- **subprocess**: Integration testing
- **tempfile**: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç®¡ç†

### CI/CDæœ€é©åŒ–
```yaml
# ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
cache:
  paths:
    - ~/.cache/pip
    - ~/.hypothesis
    - .pytest_cache

# ä¸¦åˆ—å®Ÿè¡Œ
parallel:
  contract_tests: ã‚·ãƒ¼ã‚±ãƒ³ã‚·ãƒ£ãƒ«å®Ÿè¡Œ (é€Ÿåº¦é‡è¦–)
  integration_tests: OSåˆ¥ä¸¦åˆ—å®Ÿè¡Œ
  property_tests: ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿å®Ÿè¡Œ
```

### ã‚³ãƒ¼ãƒ‰å“è³ª
```python
# ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰å“è³ªåŸºæº–
def good_test():
    """âœ… è‰¯ã„ãƒ†ã‚¹ãƒˆä¾‹"""
    # Given: æ˜ç¢ºãªå‰ææ¡ä»¶
    input_text = ";;;å¤ªå­—;;;å†…å®¹;;;"

    # When: ä¸€ã¤ã®æ“ä½œ
    result = parser.parse(input_text)

    # Then: æ˜ç¢ºãªæœŸå¾…çµæœ
    assert result.type == "bold"
    assert result.content == "å†…å®¹"
    # å®Ÿè£…è©³ç´°ã¯ãƒ†ã‚¹ãƒˆã—ãªã„

def bad_test():
    """âŒ é¿ã‘ã‚‹ã¹ããƒ†ã‚¹ãƒˆä¾‹"""
    # è¤‡æ•°ã®æ“ä½œã€å®Ÿè£…è©³ç´°ã®ãƒ†ã‚¹ãƒˆã€è¤‡é›‘ãªå‰ææ¡ä»¶
    pass
```

---

## ğŸ¯ æœŸå¾…åŠ¹æœ

### çŸ­æœŸåŠ¹æœ (1ãƒ¶æœˆ)
- CIå®Ÿè¡Œæ™‚é–“: 20åˆ† â†’ 3åˆ†
- ãƒ†ã‚¹ãƒˆå¤±æ•—ã«ã‚ˆã‚‹é–‹ç™ºé˜»å®³: å¤§å¹…å‰Šæ¸›
- æ–°æ©Ÿèƒ½é–‹ç™ºé€Ÿåº¦: å‘ä¸Š

### ä¸­æœŸåŠ¹æœ (3ãƒ¶æœˆ)
- ãƒã‚°ç™ºè¦‹ç‡å‘ä¸Š
- ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®¹æ˜“æ€§å‘ä¸Š
- æ–°ãƒ¡ãƒ³ãƒãƒ¼ã®é–‹ç™ºå‚åŠ éšœå£ä½ä¸‹

### é•·æœŸåŠ¹æœ (6ãƒ¶æœˆ+)
- å®‰å®šã—ãŸãƒªãƒªãƒ¼ã‚¹ã‚µã‚¤ã‚¯ãƒ«ç¢ºç«‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å ±å‘Šãƒã‚°ã®å‰Šæ¸›
- æŒç¶šå¯èƒ½ãªé–‹ç™ºä½“åˆ¶æ§‹ç¯‰

---

## ğŸš¨ ãƒªã‚¹ã‚¯ç®¡ç†

### ä¸»è¦ãƒªã‚¹ã‚¯

1. **æ–°ãƒ†ã‚¹ãƒˆå“è³ªä¸è¶³**
   - å¯¾ç­–: Property-based testingã§ç¶²ç¾…æ€§ç¢ºä¿
   - å¯¾ç­–: æ®µéšçš„ç§»è¡Œã§æ¤œè¨¼æœŸé–“è¨­å®š

2. **ç§»è¡ŒæœŸé–“ã®å“è³ªä½ä¸‹**
   - å¯¾ç­–: ä¸¡æ–¹ã®ãƒ†ã‚¹ãƒˆã‚’ä¸¦è¡Œå®Ÿè¡Œ
   - å¯¾ç­–: é‡è¦æ©Ÿèƒ½ã¯æ‰‹å‹•ãƒ†ã‚¹ãƒˆã§è£œå®Œ

3. **ãƒãƒ¼ãƒ æ…£ã‚Œã®èª²é¡Œ**
   - å¯¾ç­–: è©³ç´°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ»ä¾‹ç¤º
   - å¯¾ç­–: ãƒšã‚¢ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã§ã®çŸ¥è­˜å…±æœ‰

### å›é¿æˆ¦ç•¥
- **æ®µéšçš„å®Ÿè£…**: ä¸€åº¦ã«å…¨ã¦ã‚’å¤‰æ›´ã—ãªã„
- **æ¤œè¨¼æœŸé–“**: å„ãƒ•ã‚§ãƒ¼ã‚ºã§å“è³ªç¢ºèª
- **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»**: å•é¡Œæ™‚ã®æ—§ã‚·ã‚¹ãƒ†ãƒ å¾©å¸°æ‰‹é †

---

## ğŸ“‹ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³

### å³åº§ã«å®Ÿè¡Œ (ä»Šé€±)
- [ ] æ–°ãƒ†ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
- [ ] æœ€åˆã®Contract Testå®Ÿè£…
- [ ] æ–°CIè¨­å®šä½œæˆ

### 1é€±é–“ä»¥å†…
- [ ] Phase 1å®Œäº†: åŸºç›¤æ•´å‚™
- [ ] ä¸»è¦Contract Testså®Ÿè£…
- [ ] ãƒãƒ¼ãƒ ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»èª¿æ•´

### 1ãƒ¶æœˆä»¥å†…
- [ ] å…¨Phaseå®Œäº†
- [ ] æ—§ãƒ†ã‚¹ãƒˆå‰Šé™¤
- [ ] æˆæœæ¸¬å®šãƒ»æ–‡æ›¸åŒ–

---

**ã“ã®æˆ¦ç•¥ã«ã‚ˆã‚Šã€å“è³ªã‚’ä¿ã¡ãªãŒã‚‰é–‹ç™ºåŠ¹ç‡ã‚’åŠ‡çš„ã«æ”¹å–„ã—ã€æŒç¶šå¯èƒ½ãªãƒ†ã‚¹ãƒˆä½“åˆ¶ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚**
