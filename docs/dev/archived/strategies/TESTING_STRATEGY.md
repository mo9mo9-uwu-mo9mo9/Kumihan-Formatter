# Kumihan-Formatter テスト戦略

## 基本方針

Kumihan-Formatterは**純粋な変換処理**を行うツールであり、複雑なE2Eテストは不要。
代わりに以下の3層テスト戦略を採用する。

## テスト階層

### 1. ユニットテスト (最重要)
**対象:** 各モジュールの個別機能
**カバレッジ:** parser.py, renderer.py, config.py, cli.py

```
dev/tests/test_parser.py      - パース機能
dev/tests/test_renderer.py    - レンダリング機能
dev/tests/test_cli.py         - CLI機能
dev/tests/test_config.py      - 設定管理
```

**利点:**
- 高速実行 (< 5秒)
- 環境非依存
- 問題の特定が容易
- リファクタリング安全性

### 2. 統合テスト (重要)
**対象:** モジュール間連携
**カバレッジ:** parser + renderer の結合

```
dev/tests/integration/test_core_functionality.py  - パース→レンダリング統合
dev/tests/integration/test_compound_block.py      - 複合記法処理
```

**利点:**
- モジュール境界の問題検出
- 実際の使用パターンに近い
- ユニットテストより実用的

### 3. CLI統合テスト (最小限)
**対象:** CLI経由の基本動作のみ
**カバレッジ:** CLIが正常にHTMLを生成する

```python
def test_cli_basic_conversion():
    """CLI経由での基本変換のみテスト"""
    result = subprocess.run([
        "python", "-m", "kumihan_formatter.cli",
        "input.txt", "-o", "output"
    ])
    assert result.returncode == 0
    assert Path("output/input.html").exists()
```

**利点:**
- 最小限で実用的
- 環境差異の影響を最小化
- メンテナンス負荷が軽い

## 削除したE2Eテストの問題点

### 過剰な複雑性
- BeautifulSoupパーサー依存による環境差異
- ファイルシステム・エンコーディング依存
- プラットフォーム固有のテストケース
- 複雑なHTML解析とアサーション

### 低い費用対効果
- 実行時間が長い (数分)
- CI環境での不安定性
- デバッグの困難さ
- メンテナンス負荷の高さ

### 誤った品質指標
- HTML構造の詳細検証は不要
- エンドユーザーにとって重要でない内部実装詳細
- プラットフォーム差異による偽陽性

## 推奨テスト戦略

### フォーカスすべき品質指標
1. **機能正確性** - 記法が正しく変換される
2. **エラー処理** - 不正入力での適切なエラー
3. **パフォーマンス** - 大きなファイルでも適切な速度
4. **文字エンコーディング** - 日本語文字の正確な保持

### 実装方針
1. **ユニットテストを最優先** - 全て通ることを必須条件
2. **統合テストで実用性確保** - 実際の使用パターンをカバー
3. **CLI統合テストは最小限** - 基本的な動作確認のみ
4. **E2Eテストは廃止** - 費用対効果が低い

## メリット

### 開発効率向上
- テスト実行時間の大幅短縮 (分単位 → 秒単位)
- CI環境での安定性向上
- 問題特定の高速化

### 保守性向上
- テストコードの簡素化
- 環境依存問題の排除
- リファクタリング安全性の向上

### 品質保証の向上
- 実際に重要な品質指標に集中
- 偽陽性の排除
- 開発者の生産性向上

## 結論

Kumihan-Formatterのような純粋変換ツールにおいて、
複雑なE2Eテストは**過剰エンジニアリング**である。

シンプルで効果的なテスト戦略により、
より高い品質と開発効率を実現する。
