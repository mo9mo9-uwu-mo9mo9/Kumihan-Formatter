# フォーマット仕様書

> **Kumihan-Formatter のテキスト変換仕様**

---

## 📋 基本構文

| 入力構文 | 出力 HTML |
|--------------|---------------|
| 空行区切り | `<p>` 段落 |
| `- ` リスト | `<ul><li>` |
| `- ;;;キーワード;;; テキスト` | **キーワード付きリスト項目** |
| `- ;;;キー1＋キー2;;; テキスト` | **複合キーワード付きリスト項目** |
| `;;;キーワード\n内容\n;;;` | 単一ブロックタグ |
| `;;;キー1＋キー2\n内容\n;;;` | **複合ブロックタグ**（順不同・全適用） |

---

## 🏷️ ブロックキーワード → タグ対照表

| キーワード | HTML | 備考 |
|---------|------|-------|
| 太字 | `<strong>` | ブロック全体 |
| イタリック | `<em>` | |
| 枠線 | `<div class="box">` | 標準枠線 + padding |
| ハイライト＋color=#hex | `<div class="highlight" style="background-color:#hex">` | 色指定可（属性は＋で連結） |
| 見出しN | `<hN>` | N = 1–5 |
| 目次 | `<div class="toc">` | 見出しから自動生成される目次 |

---

## 🔗 複合キーワードのルール

* **連結記号**: 半角 `+` **または** 全角 `＋` のいずれでも認識
* **複数適用**: 連結されたキーワードをすべて適用した HTML を生成
* **順序**: キーワードの並び順は不問（パーサ側で正規化）
* **重複**: 同一カテゴリの重複は先頭を優先し、警告出力
* **エラー**: 未知キーワードや矛盾組み合わせは `[ERROR:invalid-combination]` で背景色 `#ffe6e6` 表示
* **ネスト**: **内側に "高レベル → 低レベル"** の順でネスト（例: 見出し → 強調）

### ネスト順序ルール

1. **見出し**（`見出し1`〜`見出し5`）- 最外側
2. **ハイライト**（`ハイライト`）
3. **枠線**（`枠線`）
4. **太字**（`太字`）
5. **イタリック**（`イタリック`）- 最内側

**例**: `見出し2＋ハイライト＋枠線＋太字` → `<h2><div class="highlight"><div class="box"><strong>…</strong></div></div></h2>`

---

## 📝 構文例

### 複合ブロック例
```
;;;見出し2＋太字
こんにちは
;;;
```
↓
```html
<h2><strong>こんにちは</strong></h2>
```

### キーワード付きリスト例
```
- ;;;太字＋枠線;;; 複合スタイル項目
```
↓
```html
<ul><li><div class="box"><strong>複合スタイル項目</strong></div></li></ul>
```

---

## 🛡️ エスケープ・誤認識対策

- **エスケープ**: `###` で `;;;` を文字として表示
- **誤認識対策**: `;;;` は行頭のみ有効
- **空ブロック**: エラーメッセージ表示（「内容を入力してください」等）

無効なマーカーは `[ERROR:<msg>]` として出力し、背景色 #ffe6e6 で強調表示します。

## ❌ 非サポート記法

以下の記法は**公式にサポートしていません**：

- **行頭 `#` 記法**: `# 見出し` は無視されます（Markdown形式は非対応）
- **インライン記法**: `**太字**` 等のMarkdown記法は非対応
- **コメント記法**: `//` や `<!-- -->` 等のコメント機能は非対応

これらの記法を使用した場合、テキストとして扱われるか無視されます。

### よくある間違いと対処法

| 間違った記法 | 正しい記法 | 説明 |
|-------------|-----------|-------|
| `# 見出し` | `;;;見出し1\n見出し\n;;;` | Markdown記法は非サポート |
| `**太字**` | `;;;太字\n太字\n;;;` | インライン記法は非サポート |
| `;;;ハイライト color=#ff0000+太字;;;` | `;;;太字+ハイライト color=#ff0000;;;` | color属性は最後に配置 |
| `;;;目次;;;` | （マーカー不要） | 目次は自動生成されます |
| `;;;見出し1\n内容` | `;;;見出し1\n内容\n;;;` | 閉じマーカーを忘れずに |

### 記法検証ツール

記法の正しさを自動でチェックできます：

```bash
# 単一ファイルの検証
python dev/tools/syntax_validator.py examples/sample.txt

# 複数ファイルの一括検証
python dev/tools/syntax_validator.py examples/*.txt

# テストスイートによる検証
python -m pytest dev/tests/test_syntax_validation.py -v
```

---

## 🎯 実装指針

* 複合キーワードは `"＋"` で分割し、一つずつ標準キーワードとして解釈
* 変換時に **タグのネスト順** を `['見出し', 'div系', 'strong', 'em']` の優先度で決定
* テストケースを `tests/test_parser.py::test_combined_markers` に追加し、パターン毎に期待 HTML を検証すること