# フォーマット仕様書

> **Kumihan-Formatter のテキスト変換仕様**

---

## 📋 基本構文

| 入力構文 | 出力 HTML |
|--------------|---------------|
| 空行区切り | `<p>` 段落 |
| 改行のみ | `<br>` 改行 |
| `- ` リスト | `<ul><li>` |
| `1. ` 番号リスト | `<ol><li>` |
| `- ;;;キーワード;;; テキスト` | **キーワード付きリスト項目** |
| `- ;;;キー1＋キー2;;; テキスト` | **複合キーワード付きリスト項目** |
| `;;;キーワード\n内容\n;;;` | 単一ブロックタグ |
| `;;;キー1＋キー2\n内容\n;;;` | **複合ブロックタグ**（順不同・全適用） |
| `;;;目次;;;` | 目次マーカー（見出しから自動生成） |
| `;;;画像 alt=説明;;;filename` | `<img src="images/filename" alt="説明">` |

---

## 🏷️ ブロックキーワード → タグ対照表

| キーワード | HTML | 備考 |
|---------|------|-------|
| 太字 | `<strong>` | ブロック全体 |
| イタリック | `<em>` | |
| 枠線 | `<div class="box">` | 標準枠線 + padding |
| ハイライト | `<div class="highlight">` | デフォルト色 |
| ハイライト color=#hex | `<div class="highlight" style="background-color:#hex">` | 色指定可 |
| 見出しN | `<hN>` | N = 1–5 |
| 目次 | `<div class="toc">` | 見出しから自動生成される目次 |
| 画像 alt=説明 | `<img src="images/filename" alt="説明">` | ファイル名はコンテンツ部分 |

---

## 🔗 複合キーワードのルール

* **連結記号**: 半角 `+` **または** 全角 `＋` のいずれでも認識
* **複数適用**: 連結されたキーワードをすべて適用した HTML を生成
* **順序**: キーワードの並び順は不問（パーサ側で正規化）
* **重複**: 同一カテゴリの重複は先頭を優先し、警告出力
* **エラー**: 未知キーワードや矛盾組み合わせは `[ERROR:invalid-combination]` で背景色 `#ffe6e6` 表示
* **ネスト**: **内側に "高レベル → 低レベル"** の順でネスト（例: 見出し → 強調）

### ネスト順序ルール

実装による自動ネスト順序（外側から内側）：

1. **div系**（`枠線`, `ハイライト`）- 最外側
2. **見出し**（`見出し1`〜`見出し5`）
3. **太字**（`太字`）
4. **イタリック**（`イタリック`）- 最内側

**実装例**: `見出し2＋太字＋ハイライト color=#ffe6e6` → `<div class="highlight" style="background-color:#ffe6e6"><h2><strong>…</strong></h2></div>`

---

## 📝 構文例

### 基本ブロック例
```
;;;見出し2
見出しテキスト
;;;
```
↓
```html
<h2>見出しテキスト</h2>
```

### 複合ブロック例
```
;;;見出し2+太字
こんにちは
;;;
```
↓
```html
<h2><strong>こんにちは</strong></h2>
```

### 色付きハイライト例
```
;;;ハイライト color=#ffe6e6
注意事項
;;;
```
↓
```html
<div class="highlight" style="background-color:#ffe6e6">注意事項</div>
```

### 番号付きリスト例
```
1. 最初の項目
2. 2番目の項目
3. 3番目の項目
```
↓
```html
<ol>
<li>最初の項目</li>
<li>2番目の項目</li>
<li>3番目の項目</li>
</ol>
```

### キーワード付きリスト例
```
- ;;;太字+枠線;;; 複合スタイル項目
```
↓
```html
<ul><li><div class="box"><strong>複合スタイル項目</strong></div></li></ul>
```

### 画像埋め込み例
```
;;;画像 alt=サンプル画像
sample.png
;;;
```
↓
```html
<img src="images/sample.png" alt="サンプル画像" />
```

### 目次マーカー例
```
;;;目次;;;

;;;見出し1
第1章
;;;

;;;見出し2
第1節
;;;
```
↓ 目次が自動生成され、見出しのIDとリンクが作成されます。

---

## 🛡️ エラーハンドリング・検証

### エラー表示
無効なマーカーは `[ERROR:<msg>]` として出力し、背景色 #ffe6e6 で強調表示します。

### エラーの種類
- **未知キーワード**: 定義されていないキーワードの使用
- **不完全ブロック**: 閉じマーカー `;;;` の欠落
- **構文エラー**: 複合キーワードの不正な組み合わせ
- **属性エラー**: color属性の記述位置ミス

### 記法の制限
- `;;;` は行頭のみ有効（行の途中では無効）
- 空ブロックはエラーメッセージを表示
- 目次マーカー `;;;目次;;;` は手動使用禁止（自動生成専用）

## ❌ 非サポート記法

以下の記法は**公式にサポートしていません**：

- **行頭 `#` 記法**: `# 見出し` は無視されます（Markdown形式は非対応）
- **インライン記法**: `**太字**` 等のMarkdown記法は非対応
- **コメント記法**: `//` や `<!-- -->` 等のコメント機能は非対応

これらの記法を使用した場合、テキストとして扱われるか無視されます。

### よくある間違いと対処法

| 間違った記法 | 正しい記法 | 説明 |
|-------------|-----------|-------|
| `# 見出し` | `;;;見出し1\n見出し\n;;;` | Markdown記法は非サポート |
| `**太字**` | `;;;太字\n太字\n;;;` | インライン記法は非サポート |
| `;;;ハイライト color=#ff0000+太字;;;` | `;;;太字+ハイライト color=#ff0000;;;` | color属性は最後に配置 |
| `;;;目次;;;` 手動記述 | （目次マーカーは自動検出） | 見出しがあれば自動生成 |
| `;;;見出し1\n内容` | `;;;見出し1\n内容\n;;;` | 閉じマーカーを忘れずに |
| `;;;太字;;;` 空ブロック | 内容を記述する | 空ブロックはエラー |

### 記法検証ツール

記法の正しさを自動でチェックできます：

```bash
# 単一ファイルの検証
python dev/tools/syntax_validator.py examples/sample.txt

# 複数ファイルの一括検証
python dev/tools/syntax_validator.py examples/*.txt

# テストスイートによる検証
python -m pytest dev/tests/test_syntax_validation.py -v
```

---

---

## 🔄 動作フロー

### パース処理
1. **行単位解析**: テキストを行ごとに解析
2. **ブロック検出**: `;;;` マーカーでブロック開始・終了を検出
3. **キーワード解析**: マーカー内のキーワードと属性を分離
4. **リスト処理**: `- ` および `1. ` でリスト項目を検出
5. **目次マーカー**: `;;;目次;;;` を検出（手動記述は警告）

### レンダリング処理
1. **AST構築**: パース結果からASTを構築
2. **見出し収集**: 目次生成用に見出しを収集
3. **HTML変換**: ASTを順次HTMLに変換
4. **目次生成**: 見出しリストから目次HTMLを生成
5. **テンプレート適用**: Jinja2テンプレートで最終HTML生成

### ネスト処理
複合キーワードのネスト順序（renderer.py内の実装）：
1. `div`系（枠線、ハイライト）
2. `見出し`系（見出し1-5）  
3. `strong`（太字）
4. `em`（イタリック）

---

## 🎯 実装指針

* 複合キーワードは `+` または `＋` で分割し、一つずつ標準キーワードとして解釈
* 変換時に **タグのネスト順** を renderer.py 内の `nesting_order` で決定
* 目次マーカーは手動使用禁止、見出しの存在から自動生成
* テストケースを `dev/tests/test_parser.py` に追加し、パターン毎に期待 HTML を検証すること