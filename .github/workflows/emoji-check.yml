name: Code Quality / Emoji Check

on:
  pull_request:
    branches: [ main ]
    paths:
      # Phase2æœ€é©åŒ–: ã‚ˆã‚Šå…·ä½“çš„ãªpathãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      - 'kumihan_formatter/**/*.py'
      - 'dev/tools/**/*.py'
      - 'dev/tests/**/*.py'
      - 'setup_*.sh'
      - 'setup_*.command'
      - 'setup_*.bat'
      - 'CLAUDE.md'
      - 'SPEC.md'
      - 'CONTRIBUTING.md'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹

jobs:
  emoji-check:
    name: Check for Emoji Usage
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # emoji_checker.py ã¯æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã¿ä½¿ç”¨
    
    - name: Run emoji checker on project files
      run: |
        echo "[æ¤œè¨¼] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®çµµæ–‡å­—ä½¿ç”¨ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
        
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆ.venvã¨emoji_checker.pyè‡ªä½“ã‚’é™¤å¤–ï¼‰
        find . -name "*.py" -not -path "./.venv/*" -not -path "./dev/tools/emoji_checker.py" -exec python dev/tools/emoji_checker.py {} \; || HAS_EMOJI_PY=1
        find . -name "*.sh" -not -path "./.venv/*" -exec python dev/tools/emoji_checker.py {} \; || HAS_EMOJI_SH=1  
        find . -name "*.command" -not -path "./.venv/*" -exec python dev/tools/emoji_checker.py {} \; || HAS_EMOJI_CMD=1
        find . -name "*.bat" -not -path "./.venv/*" -exec python dev/tools/emoji_checker.py {} \; || HAS_EMOJI_BAT=1
        
        # çµµæ–‡å­—ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã¯ã‚¨ãƒ©ãƒ¼ã§çµ‚äº†
        if [ "${HAS_EMOJI_PY:-0}" -eq 1 ] || [ "${HAS_EMOJI_SH:-0}" -eq 1 ] || [ "${HAS_EMOJI_CMD:-0}" -eq 1 ] || [ "${HAS_EMOJI_BAT:-0}" -eq 1 ]; then
          echo ""
          echo "[ã‚¨ãƒ©ãƒ¼] çµµæ–‡å­—ä½¿ç”¨ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          echo "ä¿®æ­£æ–¹æ³•: docs/dev/EMOJI_POLICY.md ã‚’å‚ç…§"
          exit 1
        fi
        
        echo "[å®Œäº†] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«çµµæ–‡å­—ä½¿ç”¨ãªã—"
    
    - name: Check changed files only (PR only)
      if: github.event_name == 'pull_request'
      run: |
        echo "[æ¤œè¨¼] å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®çµµæ–‡å­—ãƒã‚§ãƒƒã‚¯..."
        
        # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\\.(py|sh|command|bat)$' || true)
        
        if [ -z "$CHANGED_FILES" ]; then
          echo "[å®Œäº†] å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãªã—"
          exit 0
        fi
        
        echo "ãƒã‚§ãƒƒã‚¯å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: $CHANGED_FILES"
        
        # å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å€‹åˆ¥ã«ãƒã‚§ãƒƒã‚¯
        HAS_VIOLATIONS=0
        for file in $CHANGED_FILES; do
          if [ -f "$file" ]; then
            echo "[å‡¦ç†] $file ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
            if ! python dev/tools/emoji_checker.py "$file"; then
              HAS_VIOLATIONS=1
            fi
          fi
        done
        
        if [ $HAS_VIOLATIONS -eq 1 ]; then
          echo ""
          echo "[ã‚¨ãƒ©ãƒ¼] çµµæ–‡å­—ä½¿ç”¨ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          echo ""
          echo "ä¿®æ­£æ–¹æ³•:"
          echo "  1. æ¤œå‡ºã•ã‚ŒãŸçµµæ–‡å­—ã‚’ [ã‚¿ã‚°] å½¢å¼ã«ç½®æ›ã—ã¦ãã ã•ã„"
          echo "  2. è©³ç´°ã¯ docs/dev/EMOJI_POLICY.md ã‚’å‚ç…§"
          echo "  3. æ¨å¥¨ä»£æ›¿è¡¨ç¾: ğŸ”â†’[æ¤œè¨¼], âœ…â†’[å®Œäº†], âŒâ†’[ã‚¨ãƒ©ãƒ¼]"
          exit 1
        fi
        
        echo "[å®Œäº†] çµµæ–‡å­—ä½¿ç”¨é•åãªã—"

  markdown-emoji-advisory:
    name: Markdown Emoji Advisory Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Check markdown files for emoji usage
      run: |
        echo "[æ¤œè¨¼] Markdownãƒ•ã‚¡ã‚¤ãƒ«ã®çµµæ–‡å­—ä½¿ç”¨ã‚’ãƒã‚§ãƒƒã‚¯..."
        
        # å¤‰æ›´ã•ã‚ŒãŸMarkdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ï¼ˆREADME.mdé™¤ãï¼‰
        CHANGED_MD_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\\.md$' | grep -v 'README.md' || true)
        
        if [ -z "$CHANGED_MD_FILES" ]; then
          echo "[å®Œäº†] å¯¾è±¡Markdownãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãªã—"
          exit 0
        fi
        
        echo "ãƒã‚§ãƒƒã‚¯å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: $CHANGED_MD_FILES"
        
        # å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è­¦å‘Šãƒ¬ãƒ™ãƒ«ã§ãƒã‚§ãƒƒã‚¯
        HAS_VIOLATIONS=0
        for file in $CHANGED_MD_FILES; do
          if [ -f "$file" ]; then
            echo "[å‡¦ç†] $file ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
            if ! python dev/tools/emoji_checker.py "$file"; then
              HAS_VIOLATIONS=1
            fi
          fi
        done
        
        if [ $HAS_VIOLATIONS -eq 1 ]; then
          echo ""
          echo "[è­¦å‘Š] æŠ€è¡“æ–‡æ›¸ã§çµµæ–‡å­—ä½¿ç”¨ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          echo ""
          echo "æ¨å¥¨äº‹é …:"
          echo "  - æŠ€è¡“æ–‡æ›¸ã§ã¯çµµæ–‡å­—ã®ä½¿ç”¨ã‚’é¿ã‘ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™"
          echo "  - README.md ä»¥å¤–ã§ã¯ [ã‚¿ã‚°] å½¢å¼ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„"
          echo "  - è©³ç´°: docs/dev/EMOJI_POLICY.md"
          echo ""
          echo "ã“ã®ãƒã‚§ãƒƒã‚¯ã¯è­¦å‘Šã®ã¿ã§ã€ãƒ“ãƒ«ãƒ‰ã¯ç¶™ç¶šã•ã‚Œã¾ã™"
        fi
        
        echo "[å®Œäº†] Markdownãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯å®Œäº†"