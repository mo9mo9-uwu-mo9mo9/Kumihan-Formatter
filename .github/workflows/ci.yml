# çµ±åˆCI - Issue #602å¯¾å¿œ
name: quality-check
run-name: âœ… CI Pipeline - ${{ github.event.pull_request.title || github.ref }}

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # å¿…é ˆå“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆé«˜é€Ÿãƒ»è»½é‡ï¼‰
  essential-checks:
    name: ğŸš€ å¿…é ˆå“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: ã‚³ãƒ¼ãƒ‰å½¢å¼ãƒã‚§ãƒƒã‚¯
      run: |
        echo "=== Blackå½¢å¼ãƒã‚§ãƒƒã‚¯ ==="
        black --check kumihan_formatter/
        echo "=== isort importé †åºãƒã‚§ãƒƒã‚¯ ==="
        isort --check-only kumihan_formatter/
        echo "=== flake8æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ ==="
        flake8 kumihan_formatter/ --select=E9,F63,F7,F82 --count

    - name: ãƒ†ã‚£ã‚¢åˆ¥å“è³ªã‚²ãƒ¼ãƒˆå®Ÿè¡Œ
      run: |
        echo "=== Tiered Quality Gate ==="
        python scripts/tiered_quality_gate.py

    - name: å‹ãƒã‚§ãƒƒã‚¯ï¼ˆè­¦å‘Šã®ã¿ï¼‰
      run: |
        echo "=== mypyå‹ãƒã‚§ãƒƒã‚¯ ==="
        python -m mypy --strict kumihan_formatter/ || echo "âš ï¸ å‹ãƒã‚§ãƒƒã‚¯æ”¹å–„æ¨å¥¨äº‹é …ãŒã‚ã‚Šã¾ã™"

    - name: CIçµæœã‚µãƒãƒªãƒ¼
      if: always()
      run: |
        echo "## âœ… CIå®Ÿè¡Œå®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "Issue #583å¯¾å¿œ: ãƒ†ã‚£ã‚¢åˆ¥å“è³ªã‚²ãƒ¼ãƒˆã«ã‚ˆã‚‹æ®µéšçš„æ”¹å–„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### å®Ÿè¡Œé …ç›®:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Blackå½¢å¼ãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… isort importé †åºãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… flake8æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ãƒ†ã‚£ã‚¢åˆ¥å“è³ªã‚²ãƒ¼ãƒˆï¼ˆCritical/Important/Supportive/Specialï¼‰" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… mypyå‹ãƒã‚§ãƒƒã‚¯ï¼ˆè­¦å‘Šã®ã¿ï¼‰" >> $GITHUB_STEP_SUMMARY

  # Status Checkç”¨ï¼ˆãƒ–ãƒ©ãƒ³ãƒä¿è­·ã¨ã®äº’æ›æ€§ï¼‰
  status-check:
    name: quality-check
    runs-on: ubuntu-latest
    needs: [essential-checks]
    if: always()
    steps:
    - name: Status Check
      run: |
        if [ "${{ needs.essential-checks.result }}" == "success" ]; then
          echo "âœ… å¿…é ˆå“è³ªãƒã‚§ãƒƒã‚¯æˆåŠŸ"
          exit 0
        else
          echo "âŒ å¿…é ˆå“è³ªãƒã‚§ãƒƒã‚¯å¤±æ•—"
          exit 1
        fi

  # ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ†ã‚¹ãƒˆï¼ˆPRæ™‚ã®ã¿ï¼‰
  cross-platform-test:
    name: ğŸŒ ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ†ã‚¹ãƒˆ
    if: github.event_name == 'pull_request'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    needs: essential-checks
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest]

    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        python scripts/tiered_quality_gate.py
        python -m pytest --cov=kumihan_formatter --cov-report=xml

    - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆmacOSã®ã¿ï¼‰
      if: matrix.os == 'macos-latest'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
