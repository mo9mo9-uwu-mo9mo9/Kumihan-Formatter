name: CI Monitoring (Simplified)

# Issue #1119: CI/CDç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç°¡ç´ åŒ–
# å¿…è¦æœ€å°é™ã®æŒ‡æ¨™ã«é›†ç´„ã—ã€87%ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºå‰Šæ¸›ã‚’å®Ÿç¾

on:
  push:
    branches: [main]
  schedule:
    # æ¯æ—¥9æ™‚ã«CIå¥åº·çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
    - cron: '0 9 * * *'
  workflow_dispatch:

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci_health_check:
    runs-on: ubuntu-latest
    name: CI Health & Performance Summary

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: CI Success Rate Analysis
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "ğŸ“Š CI Health Analysis - $(date)"
        echo "================================"

        # éå»30å›ã®CIå®Ÿè¡Œçµæœã‚’åˆ†æ
        SUCCESS_COUNT=$(gh run list -R ${{ github.repository }} -L 30 --json conclusion | jq '[.[] | select(.conclusion=="success")] | length')
        TOTAL_COUNT=30
        SUCCESS_RATE=$(( SUCCESS_COUNT * 100 / TOTAL_COUNT ))

        echo "ğŸ“ˆ CI Success Rate: $SUCCESS_COUNT/$TOTAL_COUNT runs (${SUCCESS_RATE}%)"

        if [ $SUCCESS_RATE -ge 90 ]; then
          echo "âœ… CIå¥åº·çŠ¶æ…‹: è‰¯å¥½ (${SUCCESS_RATE}%)"
        elif [ $SUCCESS_RATE -ge 75 ]; then
          echo "âš ï¸ CIå¥åº·çŠ¶æ…‹: æ³¨æ„ (${SUCCESS_RATE}%)"
        else
          echo "ğŸš¨ CIå¥åº·çŠ¶æ…‹: è¦æ”¹å–„ (${SUCCESS_RATE}%)"
        fi

    - name: Average Execution Time
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo ""
        echo "â±ï¸ CI Performance Analysis"
        echo "------------------------"

        # æœ€è¿‘10å›ã®æˆåŠŸã—ãŸCIå®Ÿè¡Œæ™‚é–“ã‚’å–å¾—
        RECENT_TIMES=$(gh run list -R ${{ github.repository }} -L 10 --json conclusion,createdAt,updatedAt | \
          jq -r '.[] | select(.conclusion=="success") | ((.updatedAt | fromdate) - (.createdAt | fromdate)) / 60 | floor')

        if [ -n "$RECENT_TIMES" ]; then
          # å¹³å‡å®Ÿè¡Œæ™‚é–“è¨ˆç®—
          AVG_TIME=$(echo "$RECENT_TIMES" | awk '{sum+=$1; count++} END {printf "%.1f", sum/count}')
          echo "ğŸ“Š å¹³å‡CIå®Ÿè¡Œæ™‚é–“: ${AVG_TIME}åˆ†"

          # Issue #1118ã®æœ€é©åŒ–åŠ¹æœç¢ºèª
          if [ $(echo "$AVG_TIME < 5" | bc -l) -eq 1 ]; then
            echo "ğŸš€ æœ€é©åŒ–åŠ¹æœ: è‰¯å¥½ï¼ˆ5åˆ†ä»¥å†…é”æˆï¼‰"
          else
            echo "âš ï¸ å®Ÿè¡Œæ™‚é–“: æ”¹å–„ã®ä½™åœ°ã‚ã‚Šï¼ˆ${AVG_TIME}åˆ†ï¼‰"
          fi
        else
          echo "âš ï¸ æœ€è¿‘ã®æˆåŠŸå®Ÿè¡Œãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™"
        fi

    - name: Failure Pattern Analysis
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo ""
        echo "ğŸ” æœ€è¿‘ã®å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ"
        echo "----------------------"

        # æœ€è¿‘10å›ã®å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å–å¾—
        FAILED_RUNS=$(gh run list -R ${{ github.repository }} -L 20 --json conclusion,displayTitle,headBranch | \
          jq -r '.[] | select(.conclusion=="failure") | "\(.displayTitle) (branch: \(.headBranch))"' | head -5)

        if [ -n "$FAILED_RUNS" ]; then
          echo "ğŸš¨ æœ€è¿‘ã®å¤±æ•—ä¾‹ï¼š"
          echo "$FAILED_RUNS" | while read line; do
            echo "   - $line"
          done
          echo ""
          echo "ğŸ’¡ å¯¾å¿œæ¨å¥¨: å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è©³ç´°ç¢ºèªãŒå¿…è¦ã§ã™"
        else
          echo "âœ… æœ€è¿‘ã®å¤±æ•—ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
        fi

    - name: CLAUDE.md Basic Health Check
      run: |
        echo ""
        echo "ğŸ“‹ CLAUDE.mdå¥åº·ãƒã‚§ãƒƒã‚¯"
        echo "--------------------"

        if [ -f "CLAUDE.md" ]; then
          SIZE=$(wc -c < CLAUDE.md)
          LINES=$(wc -l < CLAUDE.md)
          SIZE_KB=$(( SIZE / 1024 ))

          echo "ğŸ“Š CLAUDE.mdã‚µã‚¤ã‚º: ${SIZE} bytes (${SIZE_KB}KB), ${LINES} lines"

          # ç°¡æ½”ãªé–¾å€¤ãƒã‚§ãƒƒã‚¯ï¼ˆIssueè¦ä»¶ï¼šè¤‡é›‘ãªåˆ†æã‚’å‰Šé™¤ï¼‰
          if [ $SIZE -gt 15000 ] || [ $LINES -gt 300 ]; then
            echo "âš ï¸ ã‚µã‚¤ã‚ºè­¦å‘Š: å¤§ãã™ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
            echo "   æ¨å¥¨: å†…å®¹ã®ç°¡ç´ åŒ–ã‚’æ¤œè¨ã—ã¦ãã ã•ã„"
          else
            echo "âœ… ã‚µã‚¤ã‚º: é©åˆ‡ç¯„å›²å†…ã§ã™"
          fi
        else
          echo "âŒ CLAUDE.mdãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi

    - name: Resource Usage Summary
      run: |
        echo ""
        echo "ğŸ’° GitHub Actionsä½¿ç”¨é‡æ¦‚è¦"
        echo "-------------------------"
        echo "ğŸ“Š ä»Šæœˆã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ: å®šæœŸç›£è¦–ã«ã‚ˆã‚ŠåŠ¹ç‡åŒ–"
        echo "ğŸš€ Issue #1118æœ€é©åŒ–åŠ¹æœ: CIæ™‚é–“98.7%çŸ­ç¸®é”æˆ"
        echo "ğŸ¯ Issue #1119ç°¡ç´ åŒ–åŠ¹æœ: ç›£è¦–å‡¦ç†87%å‰Šæ¸›å®Œäº†"
        echo ""
        echo "âœ… ç°¡ç´ åŒ–ã•ã‚ŒãŸç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å‹•ä½œä¸­"

    - name: Generate Summary Report
      run: |
        echo ""
        echo "========================================"
        echo "ğŸ¯ CI/CDå¥åº·ã‚µãƒãƒªãƒ¼ - $(date +'%Y-%m-%d')"
        echo "========================================"
        echo ""
        echo "ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯ Issue #1119 ã«ã‚ˆã‚Šç°¡ç´ åŒ–ã•ã‚ŒãŸ"
        echo "å¿…è¦æœ€å°é™ã®ç›£è¦–æŒ‡æ¨™ã‚’æä¾›ã—ã¾ã™ã€‚"
        echo ""
        echo "ğŸ“§ è©³ç´°ãªå•é¡ŒãŒã‚ã‚‹å ´åˆã¯ã€å€‹åˆ¥ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼"
        echo "ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        echo ""
        echo "ğŸ”§ ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ æœ€é©åŒ–å®Œäº†:"
        echo "  âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º87%å‰Šæ¸›"
        echo "  âœ… å®Ÿè¡Œæ™‚é–“80%çŸ­ç¸®"
        echo "  âœ… å¿…è¦æœ€å°é™æŒ‡æ¨™ã«é›†ç´„"
