name: Syntax Validation

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'examples/**/*.txt'
      - 'kumihan_formatter/sample_content.py'
      - 'dev/tools/syntax_validator.py'
      - 'dev/tests/test_syntax_validation.py'
  push:
    branches: [ main ]
    paths:
      - 'examples/**/*.txt'
      - 'kumihan_formatter/sample_content.py'

jobs:
  syntax-validation:
    name: Syntax Validation Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # åŸºæœ¬ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        pip install jinja2 click
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè‡ªä½“ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆsample_content ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç”¨ï¼‰
        pip install -e .
    
    - name: Run syntax validation tests
      run: |
        echo "ğŸ” è¨˜æ³•æ¤œè¨¼ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
        python dev/tests/simple_syntax_test.py
    
    - name: Validate example files directly
      run: |
        echo "ğŸ“ ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨˜æ³•ãƒã‚§ãƒƒã‚¯..."
        python dev/tools/syntax_validator.py examples/*.txt
    
    - name: Check for syntax errors in sample content
      run: |
        python dev/tools/sample_content_validator.py

  syntax-quality-check:
    name: Advanced Syntax Quality Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # åŸºæœ¬ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        pip install jinja2 click
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè‡ªä½“ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        pip install -e .
    
    - name: Check for new syntax patterns
      run: |
        echo "ğŸ” æ–°ã—ã„è¨˜æ³•ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
        
        # å¤‰æ›´ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\\.txt$' || true)
        
        if [ -z "$CHANGED_FILES" ]; then
          echo "âœ… ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãªã—"
          exit 0
        fi
        
        echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: $CHANGED_FILES"
        
        # å„ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨˜æ³•ã‚’ãƒã‚§ãƒƒã‚¯
        for file in $CHANGED_FILES; do
          if [ -f "$file" ]; then
            echo "ğŸ“ $file ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
            python dev/tools/syntax_validator.py "$file"
          fi
        done
    
    - name: Report syntax complexity
      run: |
        echo "ğŸ“Š è¨˜æ³•ã®è¤‡é›‘åº¦ã‚’ãƒ¬ãƒãƒ¼ãƒˆ..."
        python dev/tools/complexity_analyzer.py