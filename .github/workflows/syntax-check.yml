name: Syntax Validation

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'examples/**/*.txt'
      - 'kumihan_formatter/sample_content.py'
      - 'dev/tools/syntax_validator.py'
      - 'dev/tests/test_syntax_validation.py'
  push:
    branches: [ main ]
    paths:
      - 'examples/**/*.txt'
      - 'kumihan_formatter/sample_content.py'

jobs:
  syntax-validation:
    name: Syntax Validation Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè‡ªä½“ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆsample_content ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç”¨ï¼‰
        pip install -e .
    
    - name: Run syntax validation tests
      run: |
        echo "ğŸ” è¨˜æ³•æ¤œè¨¼ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
        python -m pytest dev/tests/test_syntax_validation.py -v --tb=short
    
    - name: Validate example files directly
      run: |
        echo "ğŸ“ ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨˜æ³•ãƒã‚§ãƒƒã‚¯..."
        python dev/tools/syntax_validator.py examples/*.txt
    
    - name: Check for syntax errors in sample content
      run: |
        echo "ğŸ“ sample_content.py å†…ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒã‚§ãƒƒã‚¯..."
        # sample_content.py ã‹ã‚‰ SHOWCASE_SAMPLE ã‚’æŠ½å‡ºã—ã¦æ¤œè¨¼
        python -c "
from kumihan_formatter.sample_content import SHOWCASE_SAMPLE
import tempfile
from pathlib import Path
import sys
sys.path.append('dev/tools')
from syntax_validator import SyntaxValidator

# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦æ¤œè¨¼
with tempfile.NamedTemporaryFile(mode='w', suffix='.txt', delete=False, encoding='utf-8') as f:
    f.write(SHOWCASE_SAMPLE)
    temp_path = Path(f.name)

validator = SyntaxValidator()
errors = validator.validate_file(temp_path)

if errors:
    print(f'âŒ SHOWCASE_SAMPLE ã« {len(errors)} å€‹ã®ã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:')
    for error in errors:
        print(f'   Line {error.line_number}: {error.message}')
        if error.suggestion:
            print(f'      ğŸ’¡ {error.suggestion}')
    sys.exit(1)
else:
    print('âœ… SHOWCASE_SAMPLE: è¨˜æ³•ã‚¨ãƒ©ãƒ¼ãªã—')

# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
import os
os.unlink(temp_path)
"

  syntax-quality-check:
    name: Advanced Syntax Quality Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Check for new syntax patterns
      run: |
        echo "ğŸ” æ–°ã—ã„è¨˜æ³•ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
        
        # å¤‰æ›´ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\\.txt$' || true)
        
        if [ -z "$CHANGED_FILES" ]; then
          echo "âœ… ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãªã—"
          exit 0
        fi
        
        echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: $CHANGED_FILES"
        
        # å„ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨˜æ³•ã‚’ãƒã‚§ãƒƒã‚¯
        for file in $CHANGED_FILES; do
          if [ -f "$file" ]; then
            echo "ğŸ“ $file ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
            python dev/tools/syntax_validator.py "$file"
          fi
        done
    
    - name: Report syntax complexity
      run: |
        echo "ğŸ“Š è¨˜æ³•ã®è¤‡é›‘åº¦ã‚’ãƒ¬ãƒãƒ¼ãƒˆ..."
        python -c "
import re
from pathlib import Path

def analyze_syntax_complexity(file_path):
    with open(file_path, 'r', encoding='utf-8') as f:
        content = f.read()
    
    # è¤‡åˆãƒãƒ¼ã‚«ãƒ¼ã®ä½¿ç”¨é »åº¦
    complex_markers = re.findall(r';;;[^;]*\+[^;]*;;;', content)
    
    # colorå±æ€§ã®ä½¿ç”¨é »åº¦  
    color_attrs = re.findall(r'color=#[a-fA-F0-9]{3,6}', content)
    
    # ãƒã‚¹ãƒˆã—ãŸãƒªã‚¹ãƒˆã®æ·±åº¦
    lines = content.splitlines()
    max_indent = 0
    for line in lines:
        if line.strip().startswith('-'):
            indent = len(line) - len(line.lstrip())
            max_indent = max(max_indent, indent)
    
    return {
        'complex_markers': len(complex_markers),
        'color_attributes': len(color_attrs),
        'max_list_depth': max_indent // 2  # 2ã‚¹ãƒšãƒ¼ã‚¹ = 1ãƒ¬ãƒ™ãƒ«
    }

# å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†æ
import subprocess
try:
    result = subprocess.run(['git', 'diff', '--name-only', 'HEAD~1', 'HEAD'], 
                          capture_output=True, text=True)
    changed_files = [f for f in result.stdout.strip().split('\n') 
                    if f.endswith('.txt') and Path(f).exists()]
    
    if not changed_files:
        print('âœ… åˆ†æå¯¾è±¡ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãªã—')
    else:
        for file_path in changed_files:
            stats = analyze_syntax_complexity(file_path)
            print(f'ğŸ“ˆ {file_path}:')
            print(f'   è¤‡åˆãƒãƒ¼ã‚«ãƒ¼: {stats[\"complex_markers\"]} å€‹')
            print(f'   è‰²æŒ‡å®š: {stats[\"color_attributes\"]} å€‹')
            print(f'   ãƒªã‚¹ãƒˆæœ€å¤§æ·±åº¦: {stats[\"max_list_depth\"]} ãƒ¬ãƒ™ãƒ«')
            
            # è¤‡é›‘åº¦ã®è­¦å‘Š
            if stats['complex_markers'] > 10:
                print(f'   âš ï¸  è¤‡åˆãƒãƒ¼ã‚«ãƒ¼ãŒå¤šç”¨ã•ã‚Œã¦ã„ã¾ã™ ({stats[\"complex_markers\"]} å€‹)')
            if stats['max_list_depth'] > 3:
                print(f'   âš ï¸  ãƒªã‚¹ãƒˆã®å…¥ã‚Œå­ãŒæ·±ã™ãã¾ã™ ({stats[\"max_list_depth\"]} ãƒ¬ãƒ™ãƒ«)')
                
except Exception as e:
    print(f'åˆ†æã‚¨ãƒ©ãƒ¼: {e}')
"