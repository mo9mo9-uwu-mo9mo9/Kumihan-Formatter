name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    branches: [main, develop]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get changed files
      id: changed-files
      run: |
        echo "files=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}..HEAD | tr '\n' ' ')" >> $GITHUB_OUTPUT

    - name: Add review labels
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo, number } = context.issue;

          await github.rest.issues.addLabels({
            owner,
            repo,
            issue_number: number,
            labels: ['review-requested', 'claude-review']
          });

    - name: Auto Review Notification
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo, number } = context.issue;
          const changedFiles = "${{ steps.changed-files.outputs.files }}";

          const notificationComment = `## ğŸ¤– è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ

          **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«:** ${changedFiles}

          **ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹:**
          - ã‚³ãƒ¼ãƒ‰å“è³ªï¼ˆå¯èª­æ€§ãƒ»ä¿å®ˆæ€§ï¼‰
          - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æº–æ‹ ï¼ˆ300è¡Œåˆ¶é™ãƒ»Single Responsibilityï¼‰
          - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆæ©Ÿå¯†æƒ…å ±æ¼æ´©ãƒ»è„†å¼±æ€§ï¼‰
          - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆåŠ¹ç‡æ€§ãƒ»æœ€é©åŒ–ï¼‰
          - ãƒ†ã‚¹ãƒˆï¼ˆç¶²ç¾…æ€§ãƒ»å“è³ªï¼‰
          - æ–‡æ›¸åŒ–ï¼ˆé©åˆ‡ãªã‚³ãƒ¡ãƒ³ãƒˆãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰

          **ğŸ·ï¸ ãƒ©ãƒ™ãƒ«ãƒˆãƒªã‚¬ãƒ¼æ–¹å¼:**
          \`claude-review\` ãƒ©ãƒ™ãƒ«ã®ä»˜ä¸ã«ã‚ˆã‚Š Claude Apps ã«ã‚ˆã‚‹è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

          **å€‹äººé–‹ç™ºã«ãŠã‘ã‚‹æ‰‹å‹•ãƒãƒ¼ã‚¸ä½“åˆ¶:**
          - è‡ªå‹•å“è³ªãƒã‚§ãƒƒã‚¯å¼·åŒ–
          - Claudeè‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã€mo9mo9ã«ã‚ˆã‚‹æ‰‹å‹•ãƒãƒ¼ã‚¸
          - æ®µéšçš„ãƒ†ã‚¹ãƒˆå¾©æ—§ï¼ˆPhase 2-4ï¼‰

          **æ³¨æ„**: ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†å¾Œã€mo9mo9ã«ã‚ˆã‚‹æ‰‹å‹•ãƒãƒ¼ã‚¸ãŒå¿…è¦ã§ã™ã€‚`;

          await github.rest.issues.createComment({
            owner,
            repo,
            issue_number: number,
            body: notificationComment
          });

          console.log("Auto review notification posted successfully");
