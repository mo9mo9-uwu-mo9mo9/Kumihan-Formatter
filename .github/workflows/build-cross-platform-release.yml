name: Cross-Platform Release Build

on:
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
        type: string
      create_release:
        description: 'Create GitHub release?'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      prerelease:
        description: 'Mark as pre-release?'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

  # Trigger on release tags
  push:
    tags:
      - 'v*'
    branches:
      - 'feature/issue391-cross-platform-packaging'

jobs:
  build-windows:
    runs-on: windows-latest
    outputs:
      windows-artifact: ${{ steps.upload.outputs.artifact-id }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pyinstaller

    - name: Verify installation
      run: |
        python -c "import kumihan_formatter; print('âœ… Package imported successfully')"
        python -c "import tkinter; print('âœ… tkinter available')"
        pyinstaller --version

    - name: Clean previous builds
      run: |
        if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
        if (Test-Path "build") { Remove-Item -Recurse -Force "build" }

    - name: Build Windows executable
      run: |
        Write-Host "ðŸ”¨ Building Windows executable..."
        pyinstaller --clean --noconfirm kumihan_formatter.spec

    - name: Create Windows distribution package
      run: |
        $version = "${{ github.event.inputs.version || github.ref_name }}"
        $packageName = "Kumihan-Formatter-${version}-Windows"
        $zipPath = "dist/${packageName}.zip"

        # Create README
        echo "Kumihan-Formatter ${version} - Windowsç‰ˆ" > dist/README-Windows.txt
        echo "" >> dist/README-Windows.txt
        echo "ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã€‘" >> dist/README-Windows.txt
        echo "1. ã“ã®ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»»æ„ã®å ´æ‰€ã«å±•é–‹ã—ã¦ãã ã•ã„" >> dist/README-Windows.txt
        echo "2. Kumihan-Formatter.exe ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦èµ·å‹•ã—ã¦ãã ã•ã„" >> dist/README-Windows.txt
        echo "" >> dist/README-Windows.txt
        echo "ã€ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶ã€‘" >> dist/README-Windows.txt
        echo "- Windows 10 / 11 (64-bit)" >> dist/README-Windows.txt
        echo "- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæŽ¥ç¶šä¸è¦" >> dist/README-Windows.txt
        echo "- Pythonã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦" >> dist/README-Windows.txt
        echo "" >> dist/README-Windows.txt
        echo "ã€ä½¿ã„æ–¹ã€‘" >> dist/README-Windows.txt
        echo "1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•" >> dist/README-Windows.txt
        echo "2. ã€Œå‚ç…§ã€ãƒœã‚¿ãƒ³ã‹ã‚‰å¤‰æ›ã—ãŸã„ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠž" >> dist/README-Windows.txt
        echo "3. ã€Œå¤‰æ›å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯" >> dist/README-Windows.txt
        echo "" >> dist/README-Windows.txt
        echo "ã€ã‚µãƒãƒ¼ãƒˆã€‘" >> dist/README-Windows.txt
        echo "- GitHub: https://github.com/mo9mo9-uwu-mo9mo9/Kumihan-Formatter" >> dist/README-Windows.txt
        echo "- Issues: https://github.com/mo9mo9-uwu-mo9mo9/Kumihan-Formatter/issues" >> dist/README-Windows.txt
        echo "" >> dist/README-Windows.txt
        echo "ã€ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã€‘" >> dist/README-Windows.txt
        echo "MIT License - Copyright Â© 2025 mo9mo9-uwu-mo9mo9" >> dist/README-Windows.txt

        # Create ZIP
        Compress-Archive -Path "dist/Kumihan-Formatter.exe", "dist/README-Windows.txt" -DestinationPath $zipPath -Force

        $exeSize = (Get-Item "dist/Kumihan-Formatter.exe").Length / 1MB
        $zipSize = (Get-Item $zipPath).Length / 1MB
        Write-Host "ðŸ“Š Windows Build Summary:"
        Write-Host "   Executable size: $([math]::Round($exeSize, 1)) MB"
        Write-Host "   Package size: $([math]::Round($zipSize, 1)) MB"

    - name: Upload Windows artifacts
      id: upload
      uses: actions/upload-artifact@v4
      with:
        name: kumihan-formatter-windows-${{ github.event.inputs.version || github.ref_name }}
        path: |
          dist/Kumihan-Formatter.exe
          dist/Kumihan-Formatter-*.zip
          dist/README-Windows.txt
        retention-days: 30

  build-macos:
    runs-on: macos-latest
    outputs:
      macos-artifact: ${{ steps.upload.outputs.artifact-id }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pyinstaller

    - name: Verify installation
      run: |
        python -c "import kumihan_formatter; print('âœ… Package imported successfully')"
        python -c "import tkinter; print('âœ… tkinter available')"
        pyinstaller --version
        echo "âœ… macOS version: $(sw_vers -productVersion)"

    - name: Clean previous builds
      run: |
        rm -rf dist/ build/ || true

    - name: Build macOS App
      run: |
        echo "ðŸŽ Building macOS App..."
        pyinstaller --clean --noconfirm kumihan_formatter_macos.spec

    - name: Create macOS distribution package
      run: |
        version="${{ github.event.inputs.version || github.ref_name }}"
        packageName="Kumihan-Formatter-${version}-macOS"
        zipPath="dist/${packageName}.zip"

        # Create README
        cat > dist/README-macOS.txt << 'MACOSEOF'
        Kumihan-Formatter ${version} - macOSç‰ˆ

        ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã€‘
        1. ã“ã®ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å±•é–‹ã—ã¦ãã ã•ã„
        2. Kumihan-Formatter.appã‚’ã€Œã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ•ã‚©ãƒ«ãƒ€ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„
        3. åˆå›žèµ·å‹•æ™‚ã«ã€Œé–‹ç™ºå…ƒã‚’ç¢ºèªã§ãã¾ã›ã‚“ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹å ´åˆï¼š
           - ã‚¢ãƒ—ãƒªã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ ã€Œé–‹ãã€ã‚’é¸æŠž
           - ã¾ãŸã¯ ã‚·ã‚¹ãƒ†ãƒ ç’°å¢ƒè¨­å®š â†’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ â†’ ã€Œã“ã®ã¾ã¾é–‹ãã€

        ã€ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶ã€‘
        - macOS 10.15 (Catalina) ä»¥é™
        - Intel/Apple Silicon Mac å¯¾å¿œ
        - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæŽ¥ç¶šä¸è¦
        - Pythonã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦

        ã€ä½¿ã„æ–¹ã€‘
        1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
        2. ã€Œå‚ç…§ã€ãƒœã‚¿ãƒ³ã‹ã‚‰å¤‰æ›ã—ãŸã„ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠž
        3. ã€Œå¤‰æ›å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

        ã€ã‚µãƒãƒ¼ãƒˆã€‘
        - GitHub: https://github.com/mo9mo9-uwu-mo9mo9/Kumihan-Formatter
        - Issues: https://github.com/mo9mo9-uwu-mo9mo9/Kumihan-Formatter/issues

        ã€ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã€‘
        MIT License - Copyright Â© 2025 mo9mo9-uwu-mo9mo9
        MACOSEOF

        # Create ZIP using ditto (preserves resource forks)
        ditto -c -k --keepParent "dist/Kumihan-Formatter.app" "$zipPath"

        appSize=$(du -sm "dist/Kumihan-Formatter.app" | cut -f1)
        zipSize=$(du -sm "$zipPath" | cut -f1)
        echo "ðŸ“Š macOS Build Summary:"
        echo "   App bundle size: ${appSize} MB"
        echo "   Package size: ${zipSize} MB"

    - name: Upload macOS artifacts
      id: upload
      uses: actions/upload-artifact@v4
      with:
        name: kumihan-formatter-macos-${{ github.event.inputs.version || github.ref_name }}
        path: |
          dist/Kumihan-Formatter.app
          dist/Kumihan-Formatter-*.zip
          dist/README-macOS.txt
        retention-days: 30

  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.create_release == 'true' || startsWith(github.ref, 'refs/tags/') }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Windows artifacts
      uses: actions/download-artifact@v4
      with:
        name: kumihan-formatter-windows-${{ github.event.inputs.version || github.ref_name }}
        path: release-assets/windows/

    - name: Download macOS artifacts
      uses: actions/download-artifact@v4
      with:
        name: kumihan-formatter-macos-${{ github.event.inputs.version || github.ref_name }}
        path: release-assets/macos/

    - name: Prepare release assets
      run: |
        mkdir -p release-final

        # Copy Windows assets
        cp release-assets/windows/Kumihan-Formatter-*.zip release-final/
        cp release-assets/windows/README-Windows.txt release-final/

        # Copy macOS assets
        cp release-assets/macos/Kumihan-Formatter-*.zip release-final/
        cp release-assets/macos/README-macOS.txt release-final/

        # List final assets
        echo "ðŸ“¦ Release assets:"
        ls -la release-final/

    - name: Generate release notes
      id: release-notes
      run: |
        version="${{ github.event.inputs.version || github.ref_name }}"

        cat > release-notes.md << EOF
        # Kumihan-Formatter ${version}

        ## ðŸ“¦ é…å¸ƒãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

        ### Windowsç‰ˆ
        - **Kumihan-Formatter-${version}-Windows.zip** - Windows 10/11 å¯¾å¿œå®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«
        - ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œã™ãã«ä½¿ç”¨å¯èƒ½
        - ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶: Windows 10/11 (64-bit)

        ### macOSç‰ˆ
        - **Kumihan-Formatter-${version}-macOS.zip** - macOS ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
        - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚©ãƒ«ãƒ€ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        - ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶: macOS 10.15 (Catalina) ä»¥é™
        - Intel/Apple Silicon Mac å¯¾å¿œ

        ## ðŸš€ æ–°æ©Ÿèƒ½ãƒ»æ”¹å–„
        - ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é…å¸ƒãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°ã®çµ±åˆå®Ÿè£…
        - Windowså‘ã‘exeå½¢å¼ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°å¯¾å¿œ
        - macOSå‘ã‘.appå½¢å¼ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°å¯¾å¿œ
        - è‡ªå‹•ãƒ“ãƒ«ãƒ‰ãƒ»ãƒªãƒªãƒ¼ã‚¹æ©Ÿèƒ½ã®å®Ÿè£…

        ## ðŸ“‹ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•

        ### Windows
        1. \`Kumihan-Formatter-${version}-Windows.zip\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        2. ä»»æ„ã®å ´æ‰€ã«å±•é–‹
        3. \`Kumihan-Formatter.exe\` ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦èµ·å‹•

        ### macOS
        1. \`Kumihan-Formatter-${version}-macOS.zip\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        2. å±•é–‹å¾Œã€\`Kumihan-Formatter.app\` ã‚’ã€Œã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•
        3. Launchpadã¾ãŸã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰èµ·å‹•

        ## ðŸ”— é–¢é€£ãƒªãƒ³ã‚¯
        - [GitHub Repository](https://github.com/mo9mo9-uwu-mo9mo9/Kumihan-Formatter)
        - [Issues](https://github.com/mo9mo9-uwu-mo9mo9/Kumihan-Formatter/issues)
        - [Wiki](https://github.com/mo9mo9-uwu-mo9mo9/Kumihan-Formatter/wiki)

        ---

        **Issue #391å¯¾å¿œå®Œäº†** - ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é…å¸ƒãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°ã®çµ±åˆå®Ÿè£…
        EOF

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.version || github.ref_name }}
        name: Kumihan-Formatter ${{ github.event.inputs.version || github.ref_name }}
        body_path: release-notes.md
        draft: false
        prerelease: ${{ github.event.inputs.prerelease == 'true' }}
        files: |
          release-final/*
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Build summary
      run: |
        version="${{ github.event.inputs.version || github.ref_name }}"
        echo "## ðŸŽ‰ Cross-Platform Release Complete!"
        echo ""
        echo "### âœ… Successfully built and released:"
        echo "- **Version**: ${version}"
        echo "- **Windows Package**: Kumihan-Formatter-${version}-Windows.zip"
        echo "- **macOS Package**: Kumihan-Formatter-${version}-macOS.zip"
        echo "- **GitHub Release**: Created"
        echo ""
        echo "### ðŸ“Š Build Summary"
        echo "- **Platforms**: Windows, macOS"
        echo "- **CI/CD**: Fully automated"
        echo "- **Package Format**: ZIP with README"
        echo "- **Distribution**: GitHub Releases"
        echo ""
        echo "### ðŸ”— Next Steps"
        echo "1. Test packages on target platforms"
        echo "2. Update documentation"
        echo "3. Announce release"
        echo "4. Close Issue #391"
