# ã‚ªãƒ—ã‚·ãƒ§ãƒ³å“è³ªãƒã‚§ãƒƒã‚¯ - Issue #602å¯¾å¿œ
name: Quality Check (Optional)
run-name: ðŸŽ¯ Optional Quality Check - ${{ github.event.pull_request.title || github.ref }}

on:
  # é€±1å›žã®å®šæœŸå®Ÿè¡Œï¼ˆæ—¥æ›œæ—¥ åˆå‰9æ™‚ JSTï¼‰
  schedule:
    - cron: '0 0 * * 0'  # UTC 0:00 = JST 9:00

  # ãƒªãƒªãƒ¼ã‚¹PRæ™‚ï¼ˆrelease/**ãƒ–ãƒ©ãƒ³ãƒï¼‰
  pull_request:
    branches:
      - 'release/**'

  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      run_full_analysis:
        description: 'å®Œå…¨åˆ†æžã‚’å®Ÿè¡Œ'
        required: false
        default: 'false'
        type: boolean

jobs:
  # ãƒ†ã‚£ã‚¢åˆ¥å“è³ªã‚²ãƒ¼ãƒˆ
  tiered-quality-gate:
    name: ðŸŽ¯ ãƒ†ã‚£ã‚¢åˆ¥å“è³ªã‚²ãƒ¼ãƒˆ
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: ãƒ†ã‚£ã‚¢åˆ¥å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
      run: |
        echo "ðŸ” ãƒ†ã‚£ã‚¢åˆ¥å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
        python scripts/tiered_quality_gate.py > quality_report.txt 2>&1 || true
        cat quality_report.txt

    - name: æ®µéšŽçš„æ”¹å–„ãƒ—ãƒ©ãƒ³
      if: ${{ github.event.inputs.run_full_analysis == 'true' || github.event_name == 'schedule' }}
      run: |
        echo "## ðŸ“Š æ®µéšŽçš„æ”¹å–„ãƒ—ãƒ©ãƒ³" >> $GITHUB_STEP_SUMMARY
        python scripts/gradual_improvement_planner.py --summary >> $GITHUB_STEP_SUMMARY || true

  # ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ†æžï¼ˆé€±æ¬¡ã®ã¿ï¼‰
  architecture-analysis:
    name: ðŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ†æž
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ github.event_name == 'schedule' || github.event.inputs.run_full_analysis == 'true' }}
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: ãƒ¡ãƒˆãƒªã‚¯ã‚¹ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install radon xenon
        pip install -e .

    - name: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒã‚§ãƒƒã‚¯
      run: |
        echo "## ðŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ†æžçµæžœ" >> $GITHUB_STEP_SUMMARY
        python scripts/architecture_check.py --target-dir=kumihan_formatter >> $GITHUB_STEP_SUMMARY || echo "ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ”¹å–„æŽ¨å¥¨" >> $GITHUB_STEP_SUMMARY

    - name: ã‚³ãƒ¼ãƒ‰è¤‡é›‘åº¦åˆ†æž
      run: |
        echo "## ðŸ“Š ã‚³ãƒ¼ãƒ‰è¤‡é›‘åº¦åˆ†æž" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        radon cc kumihan_formatter/ --min=B --show-complexity || true
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹çµ±è¨ˆ
      run: |
        echo "## ðŸ“ˆ ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹çµ±è¨ˆ" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "=== ãƒ•ã‚¡ã‚¤ãƒ«çµ±è¨ˆ ==="
        find kumihan_formatter -name "*.py" | wc -l | xargs echo "Pythonãƒ•ã‚¡ã‚¤ãƒ«æ•°:"
        find kumihan_formatter -name "*.py" -exec wc -l {} + | tail -1 | awk '{print "ç·è¡Œæ•°: " $1}'
        echo ""
        echo "=== Issue #602çµ±åˆåŠ¹æžœ ==="
        echo "Phase 0-2å®Œäº†: 9ãƒ•ã‚¡ã‚¤ãƒ«çµ±åˆã«ã‚ˆã‚‹å“è³ªå‘ä¸Šé”æˆ"
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # çµæžœã‚µãƒžãƒªãƒ¼
  quality-summary:
    name: ðŸ“‹ å“è³ªãƒã‚§ãƒƒã‚¯çµæžœ
    runs-on: ubuntu-latest
    needs: [tiered-quality-gate, architecture-analysis]
    if: always()
    steps:
    - name: çµæžœé›†è¨ˆ
      run: |
        echo "# ðŸŽ¯ ã‚ªãƒ—ã‚·ãƒ§ãƒ³å“è³ªãƒã‚§ãƒƒã‚¯çµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.tiered-quality-gate.result }}" == "success" ]; then
          echo "âœ… **ãƒ†ã‚£ã‚¢åˆ¥å“è³ªã‚²ãƒ¼ãƒˆ**: å®Œäº†" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **ãƒ†ã‚£ã‚¢åˆ¥å“è³ªã‚²ãƒ¼ãƒˆ**: æ”¹å–„æŽ¨å¥¨" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ needs.architecture-analysis.result }}" == "success" ]; then
          echo "âœ… **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ†æž**: å®Œäº†" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.architecture-analysis.result }}" == "skipped" ]; then
          echo "â­ï¸ **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ†æž**: ã‚¹ã‚­ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ†æž**: æ”¹å–„æŽ¨å¥¨" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ’¡ **æ³¨æ„**: ã“ã®ãƒã‚§ãƒƒã‚¯ã¯å‚è€ƒæƒ…å ±ã§ã™ã€‚PRã¯ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã›ã‚“ã€‚" >> $GITHUB_STEP_SUMMARY
