# ä¾å­˜é–¢ä¿‚å›ºå®šåŒ–ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã•ã‚ŒãŸå“è³ªã‚²ãƒ¼ãƒˆ
name: å¼·åˆ¶å“è³ªã‚²ãƒ¼ãƒˆ
run-name: ðŸš« Quality Gate Enforcement - ${{ github.event.pull_request.title || github.ref }}

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
permissions:
  contents: read
  issues: write
  pull-requests: write

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop
      - 'release/**'

jobs:
  token-usage-check:
    name: ðŸ“Š Tokenä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4.1.1  # ãƒãƒ¼ã‚¸ãƒ§ãƒ³å›ºå®šåŒ–
        with:
          fetch-depth: 0

      - name: Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5.0.0  # ãƒãƒ¼ã‚¸ãƒ§ãƒ³å›ºå®šåŒ–
        with:
          python-version: '3.12.1'  # ãƒžã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚‚å›ºå®š

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–: pipã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¨ä¿¡é ¼ã§ãã‚‹ãƒ›ã‚¹ãƒˆã®æŒ‡å®š
          python -m pip install --upgrade pip==23.3.2
          pip install -e . --trusted-host pypi.org --trusted-host pypi.python.org

      - name: Tokenä½¿ç”¨é‡åˆ†æž
        id: token_analysis
        run: |
          echo "ðŸ” PRå·®åˆ†ã®Tokenä½¿ç”¨é‡ã‚’åˆ†æžä¸­..."
          python scripts/token_usage_monitor.py > token_report.txt 2>&1
          exit_code=$?

          # ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
          cat token_report.txt

          # GitHub Actionsã‚µãƒžãƒªãƒ¼ã«è¿½åŠ 
          if [ $exit_code -ne 0 ]; then
            echo "## âŒ Tokenä½¿ç”¨é‡ã‚¨ãƒ©ãƒ¼" >> $GITHUB_STEP_SUMMARY
            echo "ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®Tokenä½¿ç”¨é‡ãŒä¸Šé™ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã‚’æ¤œè¨Žã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Tokenä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯åˆæ ¼" >> $GITHUB_STEP_SUMMARY
          fi

          exit $exit_code

  file-size-check:
    name: ðŸ“„ 300è¡Œåˆ¶é™ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4.1.1  # ãƒãƒ¼ã‚¸ãƒ§ãƒ³å›ºå®šåŒ–

      - name: Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5.0.0  # ãƒãƒ¼ã‚¸ãƒ§ãƒ³å›ºå®šåŒ–
        with:
          python-version: '3.12.1'  # ãƒžã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚‚å›ºå®š

      - name: 300è¡Œåˆ¶é™ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ðŸ” å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã®è¡Œæ•°ãƒã‚§ãƒƒã‚¯ä¸­..."
          python scripts/check_file_size.py --max-lines=300 --strict

  tech-debt-check:
    name: ðŸš¨ æŠ€è¡“çš„è² å‚µãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4.1.1  # ãƒãƒ¼ã‚¸ãƒ§ãƒ³å›ºå®šåŒ–

      - name: ç·Šæ€¥ä¿®æ­£Issueãƒã‚§ãƒƒã‚¯
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸ” æœªè§£æ±ºã®ç·Šæ€¥ä¿®æ­£Issueã‚’ç¢ºèªä¸­..."

          URGENT_ISSUES=$(gh issue list \
            --label "ç·Šæ€¥" \
            --state open \
            --search "in:title 'ç·Šæ€¥ä¿®æ­£ã®æŠ€è¡“çš„è² å‚µè§£æ¶ˆ'" \
            --json number,title,createdAt \
            --jq 'length')

          if [ "$URGENT_ISSUES" -gt 0 ]; then
            echo "âš ï¸  è­¦å‘Š: $URGENT_ISSUES ä»¶ã®æœªè§£æ±ºç·Šæ€¥ä¿®æ­£IssueãŒã‚ã‚Šã¾ã™"
            echo "## âš ï¸  æŠ€è¡“çš„è² å‚µè­¦å‘Š" >> $GITHUB_STEP_SUMMARY
            echo "$URGENT_ISSUES ä»¶ã®æœªè§£æ±ºç·Šæ€¥ä¿®æ­£IssueãŒã‚ã‚Šã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "æ—©æ€¥ã«è§£æ¶ˆã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… æœªè§£æ±ºã®ç·Šæ€¥ä¿®æ­£Issueã¯ã‚ã‚Šã¾ã›ã‚“"
          fi

  tiered-quality-gate:
    name: ðŸŽ¯ ãƒ†ã‚£ã‚¢åˆ¥å“è³ªã‚²ãƒ¼ãƒˆ
    runs-on: ubuntu-latest
    needs: [token-usage-check, file-size-check, tech-debt-check]
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4.1.1
        with:
          fetch-depth: 0

      - name: Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5.0.0
        with:
          python-version: '3.12.1'

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip==23.3.2
          pip install -e . --trusted-host pypi.org --trusted-host pypi.python.org

      - name: ãƒ†ã‚£ã‚¢åˆ¥å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        id: tiered_check
        run: |
          echo "ðŸ” ãƒ†ã‚£ã‚¢åˆ¥å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          python scripts/tiered_quality_gate.py > quality_report.txt 2>&1
          exit_code=$?

          # ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
          cat quality_report.txt

          # GitHub Actionsã‚µãƒžãƒªãƒ¼ã«è¿½åŠ 
          if [ $exit_code -eq 0 ]; then
            echo "## âœ… ãƒ†ã‚£ã‚¢åˆ¥å“è³ªã‚²ãƒ¼ãƒˆåˆæ ¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ ãƒ†ã‚£ã‚¢åˆ¥å“è³ªã‚²ãƒ¼ãƒˆè¦æ”¹å–„" >> $GITHUB_STEP_SUMMARY
          fi

          # æ®µéšŽçš„æ”¹å–„ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼å®Ÿè¡Œï¼ˆæƒ…å ±æä¾›ã®ã¿ï¼‰
          if [ -f "scripts/gradual_improvement_planner.py" ]; then
            echo "## ðŸ“Š æ®µéšŽçš„æ”¹å–„ãƒ—ãƒ©ãƒ³" >> $GITHUB_STEP_SUMMARY
            python scripts/gradual_improvement_planner.py --summary >> $GITHUB_STEP_SUMMARY || true
          fi

          exit $exit_code

  quality-gate-summary:
    name: ðŸŽ¯ å“è³ªã‚²ãƒ¼ãƒˆã‚µãƒžãƒªãƒ¼
    runs-on: ubuntu-latest
    needs: [token-usage-check, file-size-check, tech-debt-check, tiered-quality-gate]
    if: always()
    steps:
      - name: çµæžœé›†è¨ˆ
        run: |
          echo "# ðŸŽ¯ å“è³ªã‚²ãƒ¼ãƒˆçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Tokenä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯
          if [ "${{ needs.token-usage-check.result }}" == "success" ]; then
            echo "âœ… Tokenä½¿ç”¨é‡: åˆæ ¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Tokenä½¿ç”¨é‡: ä¸åˆæ ¼" >> $GITHUB_STEP_SUMMARY
          fi

          # 300è¡Œåˆ¶é™ãƒã‚§ãƒƒã‚¯
          if [ "${{ needs.file-size-check.result }}" == "success" ]; then
            echo "âœ… 300è¡Œåˆ¶é™: åˆæ ¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ 300è¡Œåˆ¶é™: ä¸åˆæ ¼" >> $GITHUB_STEP_SUMMARY
          fi

          # æŠ€è¡“çš„è² å‚µãƒã‚§ãƒƒã‚¯
          if [ "${{ needs.tech-debt-check.result }}" == "success" ]; then
            echo "âœ… æŠ€è¡“çš„è² å‚µ: ãƒã‚§ãƒƒã‚¯å®Œäº†" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  æŠ€è¡“çš„è² å‚µ: è­¦å‘Šã‚ã‚Š" >> $GITHUB_STEP_SUMMARY
          fi

          # ãƒ†ã‚£ã‚¢åˆ¥å“è³ªã‚²ãƒ¼ãƒˆ
          if [ "${{ needs.tiered-quality-gate.result }}" == "success" ]; then
            echo "âœ… ãƒ†ã‚£ã‚¢åˆ¥å“è³ª: åˆæ ¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ ãƒ†ã‚£ã‚¢åˆ¥å“è³ª: è¦æ”¹å–„" >> $GITHUB_STEP_SUMMARY
          fi

          # å…¨ä½“çµæžœï¼ˆãƒ†ã‚£ã‚¢åˆ¥ã¯è­¦å‘Šæ‰±ã„ï¼‰
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.token-usage-check.result }}" == "success" ] && \
             [ "${{ needs.file-size-check.result }}" == "success" ]; then
            echo "## ðŸŽ‰ å“è³ªã‚²ãƒ¼ãƒˆåˆæ ¼" >> $GITHUB_STEP_SUMMARY
            echo "åŸºæœ¬çš„ãªå“è³ªãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ã¾ã—ãŸï¼" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.tiered-quality-gate.result }}" != "success" ]; then
              echo "âš ï¸ ãƒ†ã‚£ã‚¢åˆ¥å“è³ªæ”¹å–„ã®æŽ¨å¥¨äº‹é …ãŒã‚ã‚Šã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## ðŸš« å“è³ªã‚²ãƒ¼ãƒˆä¸åˆæ ¼" >> $GITHUB_STEP_SUMMARY
            echo "å“è³ªåŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“ã€‚ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
