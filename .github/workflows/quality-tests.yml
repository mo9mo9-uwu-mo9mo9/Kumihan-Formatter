name: Quality Tests (Tier 1)

# ðŸ” å“è³ªä¿è¨¼ãƒ†ã‚¹ãƒˆ - é‡è¦ãªå¤‰æ›´æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹è©³ç´°æ¤œè¨¼
# - æ¡ä»¶åˆ¶å¾¡: ã‚³ã‚¢æ©Ÿèƒ½å¤‰æ›´æ™‚ã®ã¿å®Ÿè¡Œ
# - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå¤‰æ›´ã®ã¿ã§ã¯å®Ÿè¡Œã—ãªã„
# - å®Ÿè¡Œæ™‚é–“: 5-10åˆ†ç¨‹åº¦

on:
  push:
    branches: [ main ]
    # Phase2-Aæœ€é©åŒ–: mainãƒ–ãƒ©ãƒ³ãƒã§ã¯ã‚³ã‚¢æ©Ÿèƒ½å¤‰æ›´æ™‚ã®ã¿å®Ÿè¡Œ
    paths:
      - 'kumihan_formatter/**/*.py'
      - 'dev/tests/**/*.py'
      - 'pyproject.toml'
      - '.github/workflows/quality-tests.yml'  # è‡ªèº«ã®å¤‰æ›´æ™‚ã®ã¿
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - 'examples/**'
      - 'setup_*'
  pull_request:
    branches: [ main ]
    types: [ready_for_review, synchronize]
    # PRæ™‚ã¯ã‚µãƒ³ãƒ—ãƒ«ã‚’å«ã‚€å¹…åºƒã„ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
    paths:
      - 'kumihan_formatter/**'
      - 'dev/tests/**'
      - 'pyproject.toml'
      - 'examples/**/*.txt'
      - '.github/workflows/quality-tests.yml'
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - 'README*'
  workflow_dispatch:
    inputs:
      force_run:
        description: 'æ‰‹å‹•å®Ÿè¡Œ'
        required: false
        default: true
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality-tests:
    name: Quality Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: []  # Critical Testsã¨ã¯ç‹¬ç«‹å®Ÿè¡Œ
    
    steps:
      - name: Display execution context
        run: |
          echo "## ðŸ” Quality Tests (Tier 1) Execution" >> $GITHUB_STEP_SUMMARY
          echo "**Purpose**: Extended validation for core changes" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**PR State**: \${{ github.event.pull_request.draft && 'Draft (Skipped)' || 'Ready for Review' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Optimization**: Phase2-A (main branch path filtering)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Coverage (Tier 1)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Syntax Validation**: Complete Kumihan syntax check" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Unit Tests**: Core functionality validation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Integration Tests**: End-to-end conversion tests" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ **Optimization**: Selective execution based on change impact" >> $GITHUB_STEP_SUMMARY
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      
      - name: Enhanced syntax validation
        run: |
          echo "ðŸ” Complete syntax validation..."
          
          # å…¨ä½“çš„ãªæ§‹æ–‡ãƒã‚§ãƒƒã‚¯ï¼ˆè­¦å‘Šå«ã‚€ï¼‰
          flake8 kumihan_formatter --count --max-complexity=15 --max-line-length=100 --statistics
          
          echo "âœ… Enhanced syntax validation completed"
      
      - name: Kumihan syntax validation
        run: |
          echo "ðŸ“ Kumihan syntax validation..."
          
          # ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®Kumihanè¨˜æ³•ãƒã‚§ãƒƒã‚¯
          if ls examples/*.txt >/dev/null 2>&1; then
            python dev/tools/syntax_validator.py examples/*.txt
            echo "âœ… Example files syntax validated"
          else
            echo "âš ï¸ No example files found"
          fi
          
          # ã‚µãƒ³ãƒ—ãƒ«å†…å®¹ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
          if [ -f "dev/tools/sample_content_validator.py" ]; then
            python dev/tools/sample_content_validator.py
            echo "âœ… Sample content validated"
          fi
      
      - name: Unit tests execution
        run: |
          echo "ðŸ§ª Running unit tests..."
          
          # å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆè©³ç´°ãƒ­ã‚°ä»˜ãï¼‰
          pytest dev/tests/ -v --tb=short --durations=10
          
          echo "âœ… Unit tests completed"
      
      - name: Integration tests
        run: |
          echo "ðŸ”— Running integration tests..."
          
          # è¤‡æ•°å½¢å¼ã§ã®å¤‰æ›ãƒ†ã‚¹ãƒˆ
          mkdir -p /tmp/quality_test_output
          
          # åŸºæœ¬å¤‰æ›ãƒ†ã‚¹ãƒˆ
          if [ -f "examples/01-quickstart.txt" ]; then
            echo "n" | python -m kumihan_formatter convert examples/01-quickstart.txt -o /tmp/quality_test_output --no-preview
            echo "âœ… Basic conversion test passed"
          fi
          
          # ã‚½ãƒ¼ã‚¹è¡¨ç¤ºæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
          if [ -f "examples/02-comprehensive.txt" ]; then
            echo "n" | python -m kumihan_formatter convert examples/02-comprehensive.txt -o /tmp/quality_test_output --with-source-toggle --no-preview
            echo "âœ… Source toggle test passed"
          fi
          
          # ã‚µãƒ³ãƒ—ãƒ«ç”Ÿæˆãƒ†ã‚¹ãƒˆ
          echo "n" | python -m kumihan_formatter generate-sample -o /tmp/quality_test_output
          echo "âœ… Sample generation test passed"
      
      - name: Package functionality validation
        run: |
          echo "ðŸ“¦ Package functionality validation..."
          
          # å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
          python -c "
          from kumihan_formatter.parser import Parser
          from kumihan_formatter.renderer import Renderer
          from kumihan_formatter.config import Config
          
          # ãƒ‘ãƒ¼ã‚µãƒ†ã‚¹ãƒˆ
          parser = Parser()
          ast = parser.parse(';;;è¦‹å‡ºã—1\nãƒ†ã‚¹ãƒˆ\n;;;')
          print('âœ… Parser functionality validated')
          
          # ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ†ã‚¹ãƒˆ
          renderer = Renderer()
          html = renderer.render(ast)
          print('âœ… Renderer functionality validated')
          
          # è¨­å®šãƒ†ã‚¹ãƒˆ
          config = Config()
          print('âœ… Config functionality validated')
          "
      
      - name: Performance validation
        run: |
          echo "âš¡ Performance validation..."
          
          # å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã§ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
          python -c "
          import time
          from kumihan_formatter.parser import Parser
          from kumihan_formatter.renderer import Renderer
          
          # å¤§ããªãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ
          large_content = []
          for i in range(100):
              large_content.extend([
                  f';;;è¦‹å‡ºã—2',
                  f'ã‚»ã‚¯ã‚·ãƒ§ãƒ³ {i}',
                  f';;;',
                  f'',
                  f'ã“ã‚Œã¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ {i} ã®å†…å®¹ã§ã™ã€‚',
                  f'',
                  f'- é …ç›®1',
                  f'- é …ç›®2',
                  f'- é …ç›®3',
                  f''
              ])
          
          content = '\n'.join(large_content)
          
          # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æ¸¬å®š
          start_time = time.time()
          parser = Parser()
          ast = parser.parse(content)
          renderer = Renderer()
          html = renderer.render(ast)
          end_time = time.time()
          
          duration = end_time - start_time
          print(f'âœ… Performance test completed in {duration:.2f}s')
          
          if duration > 5.0:
              print(f'âš ï¸ Performance warning: took {duration:.2f}s (>5s)')
          else:
              print(f'âœ… Performance acceptable: {duration:.2f}s (<5s)')
          "
      
      - name: Quality tests summary
        if: always()
        run: |
          echo ""
          echo "ðŸ” Quality Tests (Tier 1) completed"
          echo ""
          echo "âœ… Extended validation ensures:"
          echo "  - Complete syntax and style compliance"
          echo "  - Kumihan markup syntax integrity"
          echo "  - Unit and integration test coverage"
          echo "  - Package functionality validation"
          echo "  - Performance within acceptable limits"
          echo ""
          echo "ðŸ“ˆ Next level:"
          echo "  - Full Tests (Tier 2): Complete cross-platform matrix"
          echo "  - Coverage Report: Detailed code coverage analysis"