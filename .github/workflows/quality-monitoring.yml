name: Quality Monitoring

on:
  workflow_dispatch:
    inputs:
      check_gates:
        description: 'å“è³ªã‚²ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ'
        required: false
        default: 'true'
        type: boolean
  # Phase 2: æ®µéšçš„å¾©æ—§ãƒ†ã‚¹ãƒˆ
  push:
    branches: [ 
      fix/github-actions-phase1-emergency,
      feature/github-actions-phase2-config
    ]

env:
  PYTHON_VERSION: '3.9'

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  quality-metrics:
    name: å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ãƒ»åˆ†æ
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å±¥æ­´å–å¾—ï¼ˆå“è³ªãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æç”¨ï¼‰
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
        pip install pyyaml safety bandit  # å“è³ªç›£è¦–ãƒ„ãƒ¼ãƒ«ç”¨
    
    - name: Create temp directories
      run: |
        mkdir -p /tmp/quality_test
        mkdir -p quality-reports
    
    - name: Run syntax validation (strict mode)
      run: |
        echo "ğŸ” å³æ ¼ãƒ¢ãƒ¼ãƒ‰ã§ã®è¨˜æ³•æ¤œè¨¼ã‚’å®Ÿè¡Œ..."
        python dev/tools/syntax_validator.py examples/*.txt --mode=strict || true
    
    - name: Run syntax validation (error samples)
      run: |
        echo "ğŸ” ã‚¨ãƒ©ãƒ¼ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼ã‚’å®Ÿè¡Œ..."
        if ls è¨˜æ³•ãƒ„ãƒ¼ãƒ«/**/ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«/è¨˜æ³•ã‚¨ãƒ©ãƒ¼ã‚µãƒ³ãƒ—ãƒ«.txt 2>/dev/null; then
          python dev/tools/syntax_validator.py è¨˜æ³•ãƒ„ãƒ¼ãƒ«/**/ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«/è¨˜æ³•ã‚¨ãƒ©ãƒ¼ã‚µãƒ³ãƒ—ãƒ«.txt --mode=error-sample || true
        else
          echo "ã‚¨ãƒ©ãƒ¼ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi
    
    - name: Run unit tests with coverage
      run: |
        echo "ğŸ§ª ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
        python -m pytest dev/tests/ -v --tb=short || true
    
    - name: Run performance tests
      run: |
        echo "âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
        # ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã§ã®å¤‰æ›ãƒ†ã‚¹ãƒˆ
        for file in examples/*.txt; do
          if [ -f "$file" ]; then
            echo "Testing: $file"
            timeout 30s python -m kumihan_formatter.cli convert "$file" --no-preview -o /tmp/quality_test || echo "Failed: $file"
          fi
        done
    
    - name: Collect quality metrics
      run: |
        echo "ğŸ“Š å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†..."
        python dev/tools/quality_metrics.py . --format=json --output=quality-reports/metrics.json
        python dev/tools/quality_metrics.py . --format=detailed --output=quality-reports/metrics.txt
    
    - name: Check quality gates
      if: github.event.inputs.check_gates == 'true' || github.event_name == 'push'
      run: |
        echo "ğŸšª å“è³ªã‚²ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ..."
        # Phase 2: èª¿æ•´ã•ã‚ŒãŸå“è³ªã‚²ãƒ¼ãƒˆã§ãƒã‚§ãƒƒã‚¯
        python dev/tools/quality_gates.py --config=.validation-config.yml --ci-mode || echo "âš ï¸ å“è³ªã‚²ãƒ¼ãƒˆå¤±æ•—ï¼ˆPhase 2èª¿æ•´ä¸­ï¼‰"
    
    - name: Generate quality report
      run: |
        echo "ğŸ“„ å“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ..."
        cat > quality-reports/summary.md << 'EOF'
        # ğŸ“Š å“è³ªç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆ
        
        **ç”Ÿæˆæ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S UTC')
        **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
        **ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref_name }}
        
        ## ğŸ“ˆ å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹
        
        ```
        $(cat quality-reports/metrics.txt)
        ```
        
        ## ğŸ”— é–¢é€£ãƒªãƒ³ã‚¯
        
        - [è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ (JSON)](./metrics.json)
        - [GitHub Actions ãƒ­ã‚°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        
        ---
        
        ğŸ¤– Generated by GitHub Actions
        EOF
    
    - name: Upload quality reports
      uses: actions/upload-artifact@v4
      with:
        name: quality-reports-${{ github.run_number }}
        path: quality-reports/
        retention-days: 30
    
    - name: Comment PR with quality metrics
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          try {
            const metricsText = fs.readFileSync('quality-reports/metrics.txt', 'utf8');
            const metricsJson = JSON.parse(fs.readFileSync('quality-reports/metrics.json', 'utf8'));
            
            const qualityScore = metricsJson.overall_quality_score;
            const emoji = qualityScore >= 90 ? 'ğŸŒŸ' : qualityScore >= 80 ? 'âœ…' : qualityScore >= 70 ? 'âš ï¸' : 'ğŸš¨';
            
            const comment = `## ${emoji} å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ ãƒ¬ãƒãƒ¼ãƒˆ
            
            **ç·åˆå“è³ªã‚¹ã‚³ã‚¢**: ${qualityScore}/100
            **è¨˜æ³•åˆæ ¼ç‡**: ${metricsJson.syntax_pass_rate.toFixed(1)}%
            **ãƒ†ã‚¹ãƒˆåˆæ ¼ç‡**: ${metricsJson.test_pass_rate.toFixed(1)}%
            **å¹³å‡å¤‰æ›æ™‚é–“**: ${metricsJson.conversion_time_avg.toFixed(2)}ç§’
            
            <details>
            <summary>ğŸ“„ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ</summary>
            
            \`\`\`
            ${metricsText}
            \`\`\`
            
            </details>
            
            ğŸ“¥ [è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã«å¤±æ•—:', error);
          }

  quality-trend-analysis:
    name: å“è³ªãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
    runs-on: ubuntu-latest
    needs: quality-metrics
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 100  # éå»100ã‚³ãƒŸãƒƒãƒˆã®å±¥æ­´
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Download quality reports
      uses: actions/download-artifact@v4
      with:
        name: quality-reports-${{ github.run_number }}
        path: quality-reports/
    
    - name: Analyze quality trends
      run: |
        echo "ğŸ“ˆ å“è³ªãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ..."
        # éå»ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨æ¯”è¼ƒï¼ˆç°¡æ˜“ç‰ˆï¼‰
        current_score=$(cat quality-reports/metrics.json | grep -o '"overall_quality_score": [0-9.]*' | grep -o '[0-9.]*')
        echo "ç¾åœ¨ã®å“è³ªã‚¹ã‚³ã‚¢: $current_score"
        
        # ãƒˆãƒ¬ãƒ³ãƒ‰åˆ¤å®šï¼ˆç°¡æ˜“ç‰ˆï¼‰
        if (( $(echo "$current_score > 85.0" | bc -l) )); then
          echo "âœ… å“è³ªã¯è‰¯å¥½ã§ã™"
        elif (( $(echo "$current_score > 70.0" | bc -l) )); then
          echo "âš ï¸ å“è³ªæ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™"
        else
          echo "ğŸš¨ å“è³ªãŒä½ä¸‹ã—ã¦ã„ã¾ã™ - ç·Šæ€¥æ”¹å–„ãŒå¿…è¦"
        fi

  quality-alerts:
    name: å“è³ªã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥
    runs-on: ubuntu-latest
    needs: quality-metrics
    if: failure() && github.ref == 'refs/heads/main'
    
    steps:
    - name: Send Slack notification
      if: env.SLACK_WEBHOOK_URL != ''
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        curl -X POST -H 'Content-type: application/json' \
          --data '{
            "text": "ğŸš¨ Kumihan-Formatter å“è³ªãƒã‚§ãƒƒã‚¯å¤±æ•—",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ğŸš¨ å“è³ªãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¾ã—ãŸ*\n\n*ãƒªãƒã‚¸ãƒˆãƒª*: ${{ github.repository }}\n*ãƒ–ãƒ©ãƒ³ãƒ*: ${{ github.ref_name }}\n*ã‚³ãƒŸãƒƒãƒˆ*: ${{ github.sha }}\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|è©³ç´°ã‚’ç¢ºèª>"
                }
              }
            ]
          }' \
          $SLACK_WEBHOOK_URL || echo "Slacké€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ"
    
    - name: Create GitHub Issue
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸš¨ å“è³ªãƒã‚§ãƒƒã‚¯å¤±æ•— - ç·Šæ€¥å¯¾å¿œãŒå¿…è¦',
            body: `## å“è³ªãƒã‚§ãƒƒã‚¯å¤±æ•—ãƒ¬ãƒãƒ¼ãƒˆ
            
            **å®Ÿè¡Œæ—¥æ™‚**: ${new Date().toISOString()}
            **ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref_name }}
            **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
            **å®Ÿè¡ŒID**: ${{ github.run_id }}
            
            ## ğŸ”— è©³ç´°æƒ…å ±
            
            [GitHub Actions ãƒ­ã‚°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ## ğŸ“‹ å¯¾å¿œæ‰‹é †
            
            1. ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦å¤±æ•—åŸå› ã‚’ç‰¹å®š
            2. å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã‚’å®Ÿè£…
            3. å“è³ªã‚²ãƒ¼ãƒˆãŒé€šéã™ã‚‹ã“ã¨ã‚’ç¢ºèª
            4. æœ¬Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
            
            ## ğŸ·ï¸ ãƒ©ãƒ™ãƒ«
            
            ç·Šæ€¥, ãƒã‚°
            `,
            labels: ['ç·Šæ€¥', 'ãƒã‚°']
          });

  dependency-vulnerability-scan:
    name: ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit
    
    - name: Run security scan
      run: |
        echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ..."
        safety check --json --output safety-report.json || true
        bandit -r kumihan_formatter/ -f json -o bandit-report.json || true
    
    - name: Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports-${{ github.run_number }}
        path: "*-report.json"
        retention-days: 30