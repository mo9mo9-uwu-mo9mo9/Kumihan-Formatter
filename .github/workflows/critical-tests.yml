name: Critical Tests (Tier 0)

# ğŸš¨ å¿…é ˆãƒ†ã‚¹ãƒˆ - å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹æœ€å°é™ã®æ¤œè¨¼ã‚»ãƒƒãƒˆ
# - ãƒ‘ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãªã—ï¼ˆã™ã¹ã¦ã®å¤‰æ›´ã§å®Ÿè¡Œï¼‰
# - GitHub branch protection ã®å¿…é ˆãƒã‚§ãƒƒã‚¯ã¨ã—ã¦è¨­å®š
# - å®Ÿè¡Œæ™‚é–“: 2-3åˆ†ä»¥å†…ã‚’ç›®æ¨™

on:
  push:
    branches: [ main ]
    # Phase2-Aæœ€é©åŒ–: mainãƒ–ãƒ©ãƒ³ãƒã§ã¯æœ€å°é™ã®ãƒˆãƒªã‚¬ãƒ¼ã®ã¿
    paths:
      - 'kumihan_formatter/**'
      - 'pyproject.toml'
      - '.github/workflows/critical-tests.yml'
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - 'examples/**'
  pull_request:
    branches: [ main ]
    # PRæ™‚ã¯å…¨å¤‰æ›´ã§å®Ÿè¡Œï¼ˆå“è³ªä¿è¨¼ï¼‰
    types: [opened, synchronize, ready_for_review]
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œ

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  critical-tests:
    name: Critical Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5  # é«˜é€Ÿå®Ÿè¡Œã‚’ä¿è¨¼
    
    steps:
      - name: Display execution context
        run: |
          echo "## ğŸš¨ Critical Tests (Tier 0) Execution" >> $GITHUB_STEP_SUMMARY
          echo "**Purpose**: Mandatory checks for critical changes" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target**: Fast validation (< 3 min)" >> $GITHUB_STEP_SUMMARY
          echo "**Optimization**: Phase2-A (main branch path filtering)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Coverage (Tier 0)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Syntax Check**: Critical syntax errors only" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Import Test**: Package importability" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Quick Test**: Basic functionality smoke test" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ **Optimization**: Skipped for docs/examples changes on main" >> $GITHUB_STEP_SUMMARY
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'  # å˜ä¸€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§é«˜é€ŸåŒ–
      
      - name: Install minimal dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      
      - name: Critical syntax check
        run: |
          echo "ğŸ” Critical syntax errors only..."
          # E9: ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼, F63: ç„¡åŠ¹ãªå¤‰æ•°æ¯”è¼ƒ, F7: æ§‹æ–‡ã‚¨ãƒ©ãƒ¼, F82: æœªå®šç¾©å¤‰æ•°
          flake8 kumihan_formatter --count --select=E9,F63,F7,F82 --show-source --statistics
          echo "âœ… Critical syntax check passed"
      
      - name: Package import test
        run: |
          echo "ğŸ“¦ Testing package importability..."
          python -c "
          import sys
          try:
              import kumihan_formatter
              import kumihan_formatter.cli
              import kumihan_formatter.parser
              import kumihan_formatter.renderer
              import kumihan_formatter.config
              print('âœ… All core modules imported successfully')
          except ImportError as e:
              print(f'âŒ Import error: {e}')
              sys.exit(1)
          "
      
      - name: CLI availability test
        run: |
          echo "ğŸ–¥ï¸ Testing CLI availability..."
          python -m kumihan_formatter --help > /dev/null
          echo "âœ… CLI is accessible"
      
      - name: Quick functionality test
        run: |
          echo "âš¡ Quick functionality smoke test..."
          
          # æœ€å°é™ã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
          echo ";;;è¦‹å‡ºã—1
          ãƒ†ã‚¹ãƒˆè¦‹å‡ºã—
          ;;;
          
          ã“ã‚Œã¯æ®µè½ãƒ†ã‚¹ãƒˆã§ã™ã€‚
          
          - ãƒªã‚¹ãƒˆé …ç›®1
          - ãƒªã‚¹ãƒˆé …ç›®2" > /tmp/quick_test.txt
          
          # åŸºæœ¬å¤‰æ›ãƒ†ã‚¹ãƒˆï¼ˆå¯¾è©±ãªã—ï¼‰
          echo "n" | python -m kumihan_formatter convert /tmp/quick_test.txt -o /tmp/quick_output --no-preview
          
          # å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
          if [ -f "/tmp/quick_output/quick_test.html" ]; then
            echo "âœ… Basic conversion successful"
          else
            echo "âŒ Basic conversion failed"
            exit 1
          fi
          
          # HTMLå†…å®¹ã®æœ€å°æ¤œè¨¼ï¼ˆã‚ˆã‚Šå®Ÿç”¨çš„ãªãƒã‚§ãƒƒã‚¯ï¼‰
          if grep -q "ãƒ†ã‚¹ãƒˆè¦‹å‡ºã—" /tmp/quick_output/quick_test.html && \
             grep -q "æ®µè½ãƒ†ã‚¹ãƒˆ" /tmp/quick_output/quick_test.html && \
             grep -q "ãƒªã‚¹ãƒˆé …ç›®" /tmp/quick_output/quick_test.html; then
            echo "âœ… HTML structure validation passed"
          else
            echo "âŒ HTML structure validation failed - checking actual content:"
            echo "--- Generated HTML content ---"
            cat /tmp/quick_output/quick_test.html
            echo "--- End of HTML content ---"
            exit 1
          fi
      
      - name: Critical tests summary
        if: always()
        run: |
          echo ""
          echo "ğŸš¨ Critical Tests (Tier 0) completed"
          echo ""
          echo "âœ… These tests ensure:"
          echo "  - No critical syntax errors that prevent execution"
          echo "  - Package can be imported without dependency issues"
          echo "  - CLI is accessible and responsive"  
          echo "  - Basic conversion functionality works"
          echo ""
          echo "ğŸ“ˆ For comprehensive testing, see:"
          echo "  - Quality Tests (Tier 1): Extended validation"
          echo "  - Full Tests (Tier 2): Complete test matrix"
          echo "  - Coverage Report: Detailed code coverage"