name: Test Quality Gate

# Issue #1120: ãƒ†ã‚¹ãƒˆå“è³ªã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ç­–å®š
# ãƒ†ã‚¹ãƒˆè‚¥å¤§åŒ–é˜²æ­¢ã®ãŸã‚ã®è‡ªå‹•å“è³ªãƒã‚§ãƒƒã‚¯

on:
  pull_request:
    paths:
      - 'tests/**'
      - 'scripts/test_quality_checker.py'
      - 'docs/TESTING_GUIDELINES.md'
  push:
    branches: [main]
    paths:
      - 'tests/**'
  schedule:
    # æ¯é€±æœˆæ›œ9æ™‚ã«ãƒ†ã‚¹ãƒˆå“è³ªãƒ¬ãƒ“ãƒ¥ãƒ¼
    - cron: '0 9 * * 1'
  workflow_dispatch:

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test_quality_check:
    runs-on: ubuntu-latest
    name: Test Quality Analysis

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Make test quality checker executable
      run: chmod +x scripts/test_quality_checker.py

    - name: Run Test Quality Check
      id: quality_check
      run: |
        echo "ğŸ“Š ãƒ†ã‚¹ãƒˆå“è³ªè‡ªå‹•ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
        # è­¦å‘Šãƒ¢ãƒ¼ãƒ‰: å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ãŒã€CI/CDã‚’å¤±æ•—ã•ã›ãªã„
        if python3 scripts/test_quality_checker.py --verbose; then
          echo "QUALITY_RESULT=success" >> $GITHUB_OUTPUT
        else
          echo "QUALITY_RESULT=warning" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true

    - name: Generate Quality Report
      run: |
        echo "ğŸ“‹ è©³ç´°å“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
        python3 scripts/test_quality_checker.py --verbose > test_quality_report.txt

    - name: Upload Quality Report
      uses: actions/upload-artifact@v4
      with:
        name: test-quality-report-${{ github.run_number }}
        path: test_quality_report.txt
        retention-days: 30

    - name: Test Count Analysis
      run: |
        echo ""
        echo "ğŸ“Š ãƒ†ã‚¹ãƒˆæ•°è©³ç´°åˆ†æ"
        echo "=================="

        # ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆæ•°
        TOTAL_TESTS=$(find tests -name 'test_*.py' -exec grep -h 'def test_' {} \; | wc -l)
        TOTAL_FILES=$(find tests -name 'test_*.py' | wc -l)

        echo "ğŸ“ˆ ç¾åœ¨ã®çŠ¶æ³:"
        echo "  ç·ãƒ†ã‚¹ãƒˆæ•°: ${TOTAL_TESTS}"
        echo "  ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${TOTAL_FILES}"
        echo "  å¹³å‡ãƒ†ã‚¹ãƒˆå¯†åº¦: $((TOTAL_TESTS / TOTAL_FILES))å€‹/ãƒ•ã‚¡ã‚¤ãƒ«"

        # Issue #1120åŸºæº–ã¨ã®æ¯”è¼ƒ
        LIMIT=1500
        PERCENTAGE=$((TOTAL_TESTS * 100 / LIMIT))

        echo ""
        echo "ğŸ¯ ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³åŸºæº–ã¨ã®æ¯”è¼ƒ:"
        echo "  ä¸Šé™: ${LIMIT}å€‹"
        echo "  ç¾åœ¨: ${TOTAL_TESTS}å€‹"
        echo "  ä½¿ç”¨ç‡: ${PERCENTAGE}%"

        if [ $TOTAL_TESTS -gt $LIMIT ]; then
          echo "âŒ ãƒ†ã‚¹ãƒˆæ•°ä¸Šé™è¶…é - æ”¹å–„å¿…è¦"
        elif [ $PERCENTAGE -gt 90 ]; then
          echo "âš ï¸ ä¸Šé™ã«æ¥è¿‘ - æ³¨æ„ãŒå¿…è¦"
        else
          echo "âœ… é©æ­£ç¯„å›²å†…"
        fi

    - name: Category Distribution Check
      run: |
        echo ""
        echo "ğŸ“Š ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ†ã‚¹ãƒˆåˆ†å¸ƒ"
        echo "===================="

        # ä¸»è¦ã‚«ãƒ†ã‚´ãƒªã®åˆ†æ
        echo "ğŸ“‹ ä¸»è¦ã‚«ãƒ†ã‚´ãƒª:"

        if [ -d "tests/unit" ]; then
          UNIT_TESTS=$(find tests/unit -name 'test_*.py' -exec grep -h 'def test_' {} \; 2>/dev/null | wc -l)
          echo "  unit: ${UNIT_TESTS}å€‹ (ä¸Šé™: 1450)"
        fi

        if [ -d "tests/integration" ]; then
          INTEGRATION_TESTS=$(find tests/integration -name 'test_*.py' -exec grep -h 'def test_' {} \; 2>/dev/null | wc -l)
          echo "  integration: ${INTEGRATION_TESTS}å€‹ (ä¸Šé™: 100)"
        fi

        if [ -d "tests/performance" ]; then
          PERFORMANCE_TESTS=$(find tests/performance -name 'test_*.py' -exec grep -h 'def test_' {} \; 2>/dev/null | wc -l)
          echo "  performance: ${PERFORMANCE_TESTS}å€‹ (ä¸Šé™: 50)"
        fi

        # ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªåˆ†æ
        echo ""
        echo "ğŸ“‹ unit ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª:"
        for subdir in tests/unit/*/; do
          if [ -d "$subdir" ]; then
            SUBCAT_TESTS=$(find "$subdir" -name 'test_*.py' -exec grep -h 'def test_' {} \; 2>/dev/null | wc -l)
            SUBCAT_NAME=$(basename "$subdir")
            echo "  unit/${SUBCAT_NAME}: ${SUBCAT_TESTS}å€‹"
          fi
        done

    - name: Test Growth Analysis (PR only)
      if: github.event_name == 'pull_request'
      run: |
        echo ""
        echo "ğŸ“ˆ ãƒ†ã‚¹ãƒˆå¢—åŠ åˆ†æ (PR)"
        echo "==================="

        # PRã§ã®å¤‰æ›´åˆ†æ
        git diff --name-only origin/${{ github.base_ref }}...HEAD | grep "^tests/" | grep "test_.*\.py$" || echo "ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãªã—"

        # æ–°è¦è¿½åŠ ãƒ†ã‚¹ãƒˆæ•°
        NEW_TEST_FILES=$(git diff --name-only --diff-filter=A origin/${{ github.base_ref }}...HEAD | grep "^tests/" | grep "test_.*\.py$" | wc -l)

        if [ $NEW_TEST_FILES -gt 0 ]; then
          echo "ğŸ“ æ–°è¦ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: ${NEW_TEST_FILES}å€‹"
          git diff --name-only --diff-filter=A origin/${{ github.base_ref }}...HEAD | grep "^tests/" | grep "test_.*\.py$" | while read file; do
            if [ -f "$file" ]; then
              NEW_TESTS=$(grep -c 'def test_' "$file")
              echo "  ${file}: ${NEW_TESTS}å€‹ã®ãƒ†ã‚¹ãƒˆ"
            fi
          done
        fi

        # ä¿®æ­£ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
        MODIFIED_TEST_FILES=$(git diff --name-only --diff-filter=M origin/${{ github.base_ref }}...HEAD | grep "^tests/" | grep "test_.*\.py$" | wc -l)

        if [ $MODIFIED_TEST_FILES -gt 0 ]; then
          echo "ğŸ“ ä¿®æ­£ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: ${MODIFIED_TEST_FILES}å€‹"
        fi

    - name: Quality Gate Decision
      run: |
        echo ""
        echo "ğŸšª å“è³ªã‚²ãƒ¼ãƒˆåˆ¤å®š"
        echo "================"

        # å“è³ªãƒã‚§ãƒƒã‚¯çµæœã®ç¢ºèª
        QUALITY_RESULT="${{ steps.quality_check.outputs.QUALITY_RESULT }}"
        echo "å“è³ªãƒã‚§ãƒƒã‚¯çµæœ: ${QUALITY_RESULT}"

        if [ "${QUALITY_RESULT}" = "warning" ]; then
          echo "âš ï¸ å“è³ªæ”¹å–„æ¨å¥¨äº‹é …ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ˆè­¦å‘Šãƒ¢ãƒ¼ãƒ‰ï¼‰"
          echo ""
          echo "ğŸ“‹ æ¨å¥¨å¯¾å¿œï¼ˆå¿…é ˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰:"
          echo "1. ãƒ†ã‚¹ãƒˆå“è³ªãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèª"
          echo "2. docs/TESTING_GUIDELINES.md ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’å‚ç…§"
          echo "3. python3 scripts/test_quality_checker.py ã§è©³ç´°ç¢ºèª"
          echo "4. æ™‚é–“ãŒã‚ã‚‹ã¨ãã«æ”¹å–„ã‚’å®Ÿæ–½"
          echo ""
          echo "ğŸ”— è©³ç´°: https://github.com/${{ github.repository }}/blob/main/docs/TESTING_GUIDELINES.md"
          echo "âœ… CI/CDã¯ç¶™ç¶šï¼ˆè­¦å‘Šãƒ¢ãƒ¼ãƒ‰ï¼‰"
        else
          echo "âœ… å…¨å“è³ªåŸºæº–ã‚’ã‚¯ãƒªã‚¢"
          echo ""
          echo "ğŸ‰ ãƒ†ã‚¹ãƒˆå“è³ªãŒé©åˆ‡ã«ç¶­æŒã•ã‚Œã¦ã„ã¾ã™ã€‚"
          echo "ğŸ“Š å®šæœŸçš„ãªå“è³ªç›£è¦–ã«ã‚ˆã‚Šã€æŒç¶šå¯èƒ½ãªé–‹ç™ºç’°å¢ƒã‚’å®Ÿç¾ã€‚"
          echo ""
          echo "ğŸ’¡ ç¶™ç¶šæ”¹å–„:"
          echo "- æœˆæ¬¡: ãƒ†ã‚¹ãƒˆå“è³ªæŒ‡æ¨™ãƒ¬ãƒ“ãƒ¥ãƒ¼"
          echo "- å››åŠæœŸ: ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³åŸºæº–è¦‹ç›´ã—"
        fi

    - name: Weekly Quality Summary (Schedule only)
      if: github.event_name == 'schedule'
      run: |
        echo ""
        echo "ğŸ“… é€±æ¬¡å“è³ªã‚µãƒãƒªãƒ¼"
        echo "=================="

        # éå»1é€±é–“ã®ãƒ†ã‚¹ãƒˆå¤‰æ›´çŠ¶æ³
        SINCE_DATE=$(date -d '1 week ago' +%Y-%m-%d)
        echo "ğŸ“Š éå»1é€±é–“ã®å¤‰æ›´ (${SINCE_DATE}ä»¥é™):"

        # Gitãƒ­ã‚°ã‹ã‚‰ãƒ†ã‚¹ãƒˆé–¢é€£ã®å¤‰æ›´ã‚’åˆ†æ
        git log --since="${SINCE_DATE}" --oneline --grep="test" --grep="ãƒ†ã‚¹ãƒˆ" | head -10 | while read line; do
          echo "  ${line}"
        done || echo "  ãƒ†ã‚¹ãƒˆé–¢é€£ã®å¤‰æ›´ãªã—"

        echo ""
        echo "ğŸ”„ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:"
        echo "- å“è³ªãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèª"
        echo "- ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³é©ç”¨çŠ¶æ³ã®è©•ä¾¡"
        echo "- å¿…è¦ã«å¿œã˜ã¦ãƒ†ã‚¹ãƒˆæ•´ç†ã®å®Ÿæ–½"

    - name: Comment PR (PR only)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          try {
            const report = fs.readFileSync('test_quality_report.txt', 'utf8');
            const comment = `## ğŸ“Š ãƒ†ã‚¹ãƒˆå“è³ªãƒã‚§ãƒƒã‚¯çµæœ

          ã“ã®PRã®ãƒ†ã‚¹ãƒˆå“è³ªã‚’è‡ªå‹•åˆ†æã—ã¾ã—ãŸã€‚

          <details>
          <summary>ğŸ“‹ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ</summary>

          \`\`\`
          ${report}
          \`\`\`

          </details>

          ### ğŸ“– å‚è€ƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
          - [ãƒ†ã‚¹ãƒˆå“è³ªã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³](https://github.com/${{ github.repository }}/blob/main/docs/TESTING_GUIDELINES.md)
          - [è‡ªå‹•ãƒã‚§ãƒƒã‚«ãƒ¼ã®ä½¿ç”¨æ–¹æ³•](https://github.com/${{ github.repository }}/blob/main/scripts/test_quality_checker.py)

          ### ğŸ”§ ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ç¢ºèªæ–¹æ³•
          \`\`\`bash
          python3 scripts/test_quality_checker.py --verbose
          \`\`\`

          ---
          ğŸ¤– Issue #1120: ãƒ†ã‚¹ãƒˆå“è³ªã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ç­–å®š`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—: ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æœªç”Ÿæˆ');
          }
