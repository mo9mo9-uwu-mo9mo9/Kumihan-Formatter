name: Build Windows EXE (Experimental)

on:
  # Manual trigger only for experimental branch
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build from'
        required: true
        default: 'experimental/windows-exe-packaging'
        type: choice
        options:
          - 'experimental/windows-exe-packaging'
      commit_results:
        description: 'Commit results back to branch?'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

  # Trigger on push to experimental branch only
  push:
    branches:
      - 'experimental/windows-exe-packaging'
    paths:
      - 'kumihan_formatter/**'
      - 'build_windows.py'
      - 'kumihan_formatter.spec'
      - 'version_info.txt'

jobs:
  build-windows-exe:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.branch || github.ref }}
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pyinstaller

    - name: Verify installation
      run: |
        python -c "import kumihan_formatter; print('âœ… Package imported successfully')"
        python -c "import tkinter; print('âœ… tkinter available')"
        pyinstaller --version

    - name: Clean previous builds
      run: |
        if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
        if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
        Write-Host "âœ… Cleaned previous builds"

    - name: Build Windows executable
      run: |
        Write-Host "ğŸ”¨ Starting Windows EXE build..."
        pyinstaller --clean --noconfirm kumihan_formatter.spec
        Write-Host "âœ… Build completed"

    - name: Create distribution package
      run: |
        Write-Host "ğŸ“¦ Creating distribution package..."

        # Check if executable exists
        if (-not (Test-Path "dist/Kumihan-Formatter.exe")) {
          Write-Host "âŒ Executable not found"
          exit 1
        }

        $exeSize = (Get-Item "dist/Kumihan-Formatter.exe").Length / 1MB
        Write-Host "ğŸ“Š Executable size: $([math]::Round($exeSize, 1)) MB"

        # Create ZIP package using PowerShell
        $packageName = "Kumihan-Formatter-v1.0-Windows"
        $zipPath = "dist/$packageName.zip"

        # Create README content
        $readmeContent = @'
Kumihan-Formatter v1.0 - Windowsç‰ˆ

ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã€‘
1. ã“ã®ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»»æ„ã®å ´æ‰€ã«å±•é–‹ã—ã¦ãã ã•ã„
2. Kumihan-Formatter.exe ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦èµ·å‹•ã—ã¦ãã ã•ã„

ã€ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶ã€‘
- Windows 10 / 11 (64-bit)
- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šä¸è¦
- Pythonã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦

ã€ä½¿ã„æ–¹ã€‘
1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
2. ã€Œå‚ç…§ã€ãƒœã‚¿ãƒ³ã‹ã‚‰å¤‰æ›ã—ãŸã„ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
3. ã€Œå¤‰æ›å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

ã€ã‚µãƒãƒ¼ãƒˆã€‘
- GitHub: https://github.com/mo9mo9-uwu-mo9mo9/Kumihan-Formatter
- Issues: https://github.com/mo9mo9-uwu-mo9mo9/Kumihan-Formatter/issues

ã€ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã€‘
MIT License - Copyright Â© 2025 mo9mo9-uwu-mo9mo9
'@

        # Save README
        $readmeContent | Out-File -FilePath "dist/README.txt" -Encoding UTF8

        # Create ZIP
        Compress-Archive -Path "dist/Kumihan-Formatter.exe", "dist/README.txt" -DestinationPath $zipPath -Force

        $zipSize = (Get-Item $zipPath).Length / 1MB
        Write-Host "ğŸ“¦ Package size: $([math]::Round($zipSize, 1)) MB"
        Write-Host "âœ… Distribution package created: $zipPath"

    - name: Verify build output
      run: |
        if (Test-Path "dist/Kumihan-Formatter.exe") {
          Write-Host "âœ… Windows executable created successfully"
          $size = (Get-Item "dist/Kumihan-Formatter.exe").Length / 1MB
          Write-Host "ğŸ“Š Executable size: $([math]::Round($size, 1)) MB"
        } else {
          Write-Host "âŒ Executable not found"
          exit 1
        }

        if (Test-Path "dist/Kumihan-Formatter-v1.0-Windows.zip") {
          Write-Host "âœ… Distribution package created"
          $zipSize = (Get-Item "dist/Kumihan-Formatter-v1.0-Windows.zip").Length / 1MB
          Write-Host "ğŸ“¦ Package size: $([math]::Round($zipSize, 1)) MB"
        } else {
          Write-Host "âŒ Distribution package not found"
          exit 1
        }

    - name: Test executable (basic check)
      run: |
        Write-Host "ğŸ§ª Testing executable..."
        try {
          # Try to run executable with timeout (it's a GUI app)
          $process = Start-Process -FilePath "dist/Kumihan-Formatter.exe" -ArgumentList "--help" -Wait -PassThru -WindowStyle Hidden -RedirectStandardOutput "test_output.txt" -RedirectStandardError "test_error.txt"
          Write-Host "âš ï¸  Process exited with code: $($process.ExitCode) (expected for GUI app)"
        } catch {
          Write-Host "âš ï¸  GUI app test - normal behavior: $($_.Exception.Message)"
        }

        # Check if file is executable
        $fileInfo = Get-Item "dist/Kumihan-Formatter.exe"
        Write-Host "âœ… File type verification passed"
        Write-Host "   File: $($fileInfo.Name)"
        Write-Host "   Size: $([math]::Round($fileInfo.Length / 1MB, 1)) MB"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kumihan-formatter-windows-exe-${{ github.run_number }}
        path: |
          dist/Kumihan-Formatter.exe
          dist/Kumihan-Formatter-v1.0-Windows.zip
          dist/README.txt
        retention-days: 30

    - name: Commit results to experimental branch
      if: ${{ github.event.inputs.commit_results == 'true' || github.event_name == 'push' }}
      run: |
        Write-Host "ğŸ’¾ Committing results to experimental branch..."

        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Add Windows build results
        git add -f dist/Kumihan-Formatter.exe
        git add -f dist/Kumihan-Formatter-v1.0-Windows.zip
        git add -f dist/README.txt

        # Check if there are changes to commit
        $changes = git diff --cached --name-only
        if ($changes) {
          Write-Host "ğŸ“‹ Files to commit:"
          $changes | ForEach-Object { Write-Host "   - $_" }

          # Commit changes
          git commit -m "feat: Windows EXEè‡ªå‹•ç”Ÿæˆå®Œäº† (GitHub Actions)

- Windows 10/11å¯¾å¿œã®EXEãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆå®Œäº†
- ã‚µã‚¤ã‚º: $([math]::Round((Get-Item 'dist/Kumihan-Formatter.exe').Length / 1MB, 1)) MB
- é…å¸ƒãƒ‘ãƒƒã‚±ãƒ¼ã‚¸: Kumihan-Formatter-v1.0-Windows.zip
- PyInstaller 6.xä½¿ç”¨ã€å…¨ä¾å­˜é–¢ä¿‚ãƒãƒ³ãƒ‰ãƒ«æ¸ˆã¿

ğŸ¤– Generated by GitHub Actions
Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

          # Push to experimental branch
          git push origin HEAD
          Write-Host "âœ… Successfully committed and pushed Windows EXE to experimental branch"
        } else {
          Write-Host "â„¹ï¸  No new changes to commit"
        }
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Build summary
      run: |
        Write-Host "## ğŸ—ï¸ Windows Build Summary"
        Write-Host ""
        Write-Host "### âœ… Successfully built Windows executable"
        Write-Host ""
        Write-Host "- **Branch**: ${{ github.ref_name }}"
        Write-Host "- **Python Version**: 3.11"
        Write-Host "- **Build OS**: Windows Latest"
        Write-Host "- **PyInstaller**: $(pyinstaller --version)"
        Write-Host "- **Run Number**: ${{ github.run_number }}"
        Write-Host ""
        Write-Host "### ğŸ“¦ Artifacts Created"
        Write-Host "- ``Kumihan-Formatter.exe`` - Windows executable"
        Write-Host "- ``Kumihan-Formatter-v1.0-Windows.zip`` - Distribution package"
        Write-Host "- ``README.txt`` - Installation instructions"
        Write-Host ""
        Write-Host "### ğŸ”— Next Steps"
        Write-Host "1. Download artifacts from GitHub Actions"
        Write-Host "2. Test on different Windows versions"
        Write-Host "3. Verify all GUI functionality works"
        Write-Host "4. Test file conversion and sample generation"
