name: Technical Debt Monitoring
# Issue #1258: æŠ€è¡“çš„è² å‚µç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - ç¶™ç¶šç›£è¦–ãƒ»è‡ªå‹•å ±å‘Š

on:
  # æ¯é€±é‡‘æ›œæ—¥ 10:00 JST ã«å®Ÿè¡Œ
  schedule:
    - cron: '0 1 * * FRI'  # UTC 1:00 = JST 10:00
  
  # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½
  workflow_dispatch:
  
  # PRãƒãƒ¼ã‚¸æ™‚ã«ã‚‚å®Ÿè¡Œ
  push:
    branches:
      - main

jobs:
  technical-debt-detection:
    name: æŠ€è¡“çš„è² å‚µæ¤œå‡ºãƒ»å ±å‘Š
    runs-on: ubuntu-latest
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest pytest-cov mypy black
        
    - name: æŠ€è¡“çš„è² å‚µæ¤œå‡ºå®Ÿè¡Œ
      run: |
        python3 scripts/technical_debt_manager.py detect
        
    - name: é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      run: |
        python3 scripts/technical_debt_manager.py report
        
    - name: ã‚µãƒãƒªãƒ¼è¡¨ç¤º
      run: |
        python3 scripts/technical_debt_manager.py summary
        
    - name: ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
      uses: actions/upload-artifact@v3
      with:
        name: technical-debt-reports
        path: tmp/technical_debt_report_*.md
        retention-days: 90
        
    - name: Issueä½œæˆ (Criticalè² å‚µç™ºè¦‹æ™‚)
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // æŠ€è¡“çš„è² å‚µãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
          try {
            const debtData = JSON.parse(fs.readFileSync('tmp/technical_debt.json', 'utf8'));
            const criticalDebts = debtData.filter(debt => debt.severity === 'critical' && debt.resolution_status === 'open');
            
            if (criticalDebts.length > 0) {
              const issueTitle = `ğŸ”´ CriticalæŠ€è¡“çš„è² å‚µ ${criticalDebts.length}ä»¶ - ç·Šæ€¥å¯¾å¿œå¿…è¦`;
              const issueBody = `## ğŸš¨ CriticalæŠ€è¡“çš„è² å‚µãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ
              
**æ¤œå‡ºä»¶æ•°**: ${criticalDebts.length}ä»¶
**æ¤œå‡ºæ—¥æ™‚**: ${new Date().toISOString().split('T')[0]}
**ç·è¦‹ç©å·¥æ•°**: ${criticalDebts.reduce((sum, debt) => sum + debt.estimated_effort_hours, 0).toFixed(1)}æ™‚é–“

### æ¤œå‡ºã•ã‚ŒãŸè² å‚µ

${criticalDebts.map(debt => `
- **${debt.title}**
  - ãƒ•ã‚¡ã‚¤ãƒ«: ${debt.file_path}
  - è¦‹ç©å·¥æ•°: ${debt.estimated_effort_hours}æ™‚é–“
  - èª¬æ˜: ${debt.description}
`).join('\n')}

### æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
1. **7æ—¥ä»¥å†…ã®è§£æ±º**ã‚’å¼·ãæ¨å¥¨
2. é–‹ç™ºãƒãƒ¼ãƒ ã§ã®å³åº§ã®å¯¾å¿œè¨ˆç”»ç­–å®š
3. ä»–ã®ä½œæ¥­ã®å„ªå…ˆåº¦èª¿æ•´ã®æ¤œè¨

### é–¢é€£
- æŠ€è¡“çš„è² å‚µç®¡ç†ã‚·ã‚¹ãƒ†ãƒ : scripts/technical_debt_manager.py
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: .github/quality/technical_debt.yml
- Issue #1258: æŠ€è¡“çš„è² å‚µç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

---
*è‡ªå‹•ç”Ÿæˆ - Technical Debt Monitoring System*`;

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['technical-debt', 'critical', 'automated']
              });
              
              console.log('CriticalæŠ€è¡“çš„è² å‚µã®Issueã‚’ä½œæˆã—ã¾ã—ãŸ');
            }
          } catch (error) {
            console.log('æŠ€è¡“çš„è² å‚µãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', error.message);
          }

  branch-monitoring:
    name: ãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥ç›£è¦–
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: é•·æœŸé–“ã®ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯
      run: |
        echo "## ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥ãƒã‚§ãƒƒã‚¯"
        
        # 10æ—¥ä»¥ä¸Šå¤ã„ãƒ–ãƒ©ãƒ³ãƒã‚’æ¤œå‡º
        OLD_BRANCHES=$(git for-each-ref --format='%(refname:short) %(committerdate:relative)' refs/remotes/origin | grep -E '(week|month)' | head -10)
        
        if [ -n "$OLD_BRANCHES" ]; then
          echo "âš ï¸ å¤ã„ãƒ–ãƒ©ãƒ³ãƒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:"
          echo "$OLD_BRANCHES"
          
          # ã‚³ãƒ¡ãƒ³ãƒˆã§ã‚‚è­¦å‘Š
          echo "BRANCH_WARNING<<EOF" >> $GITHUB_ENV
          echo "å¤ã„ãƒ–ãƒ©ãƒ³ãƒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥(.github/quality/branch_strategy.yml)ã®ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        else
          echo "âœ… å…¨ã¦ã®ãƒ–ãƒ©ãƒ³ãƒãŒé©åˆ‡ãªæœŸé–“å†…ã§ã™"
        fi

  notification:
    name: é€šçŸ¥
    needs: [technical-debt-detection, branch-monitoring]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: çµæœé€šçŸ¥
      run: |
        echo "## ğŸ“Š æŠ€è¡“çš„è² å‚µç›£è¦–çµæœ"
        echo "- æŠ€è¡“çš„è² å‚µæ¤œå‡º: ${{ needs.technical-debt-detection.result }}"
        echo "- ãƒ–ãƒ©ãƒ³ãƒç›£è¦–: ${{ needs.branch-monitoring.result }}"
        echo ""
        echo "è©³ç´°ã¯å„ã‚¸ãƒ§ãƒ–ã®ãƒ­ã‚°ã¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"