# ãƒ†ã‚£ã‚¢åˆ¥CIå®Ÿè¡Œ - Issue #610å¯¾å¿œ
name: tiered-ci
run-name: ğŸï¸ Tiered CI Pipeline - ${{ github.event.pull_request.title || github.ref }}

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      test_tier:
        description: 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ†ã‚£ã‚¢'
        required: false
        default: 'critical'
        type: choice
        options:
        - critical
        - important
        - full

jobs:
  # Critical Tier: é«˜é€Ÿå®Ÿè¡Œï¼ˆå…¨PRãƒ»ãƒ—ãƒƒã‚·ãƒ¥ï¼‰
  critical-tier:
    name: ğŸš€ Critical Tier Tests
    runs-on: ubuntu-latest
    timeout-minutes: 8
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          .pytest_cache
        key: ${{ runner.os }}-pytest-${{ hashFiles('**/pyproject.toml') }}-${{ hashFiles('tests/**/*.py') }}
        restore-keys: |
          ${{ runner.os }}-pytest-

    - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Critical Tierãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        echo "=== Critical Tier Tests (ä¸¦åˆ—å®Ÿè¡Œ) ==="
        if [ -f "tests/unit/test_commands_core.py" ] && [ -f "tests/unit/test_core_parser_advanced.py" ]; then
          python -m pytest -n auto tests/unit/test_commands_core.py tests/unit/test_core_parser_advanced.py \
            --durations=5 --maxfail=3 --timeout=60 -v
        else
          echo "âš ï¸ Critical Tierãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…¨unit ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚"
          python -m pytest -n auto tests/unit/ -m "not slow and not gui" \
            --durations=5 --maxfail=3 --timeout=60 -v
        fi

  # Important Tier: PRæ™‚ã®ã¿å®Ÿè¡Œ
  important-tier:
    name: ğŸ“Š Important Tier Tests
    if: github.event_name == 'pull_request' || github.event.inputs.test_tier == 'important' || github.event.inputs.test_tier == 'full'
    runs-on: ubuntu-latest
    timeout-minutes: 12
    needs: critical-tier
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          .pytest_cache
        key: ${{ runner.os }}-pytest-${{ hashFiles('**/pyproject.toml') }}-${{ hashFiles('tests/**/*.py') }}
        restore-keys: |
          ${{ runner.os }}-pytest-

    - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Important Tierãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        echo "=== Important Tier Tests (ä¸¦åˆ—å®Ÿè¡Œ) ==="
        python -m pytest -n auto tests/unit/test_rendering_advanced.py tests/unit/test_validation_advanced.py \
          --cov=kumihan_formatter --cov-fail-under=4 --durations=10 --maxfail=5 --timeout=120 -v

  # Full Tests: mainãƒ–ãƒ©ãƒ³ãƒã€PRã€ã¾ãŸã¯æ‰‹å‹•å®Ÿè¡Œæ™‚
  full-tier:
    name: ğŸ”¬ Full Test Suite
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request' || github.event.inputs.test_tier == 'full'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [critical-tier, important-tier]
    strategy:
      matrix:
        test-group: [unit, integration]
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          .pytest_cache
        key: ${{ runner.os }}-pytest-full-${{ hashFiles('**/pyproject.toml') }}-${{ hashFiles('tests/**/*.py') }}
        restore-keys: |
          ${{ runner.os }}-pytest-

    - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        if [ "${{ matrix.test-group }}" == "unit" ]; then
          echo "=== Unit Tests (ä¸¦åˆ—å®Ÿè¡Œ) ==="
          python -m pytest -n auto tests/unit/ --cov=kumihan_formatter --cov-report=xml \
            --cov-fail-under=4 --durations=10 --maxfail=10 -m "not slow and not gui"
        else
          echo "=== Integration Tests (ä¸¦åˆ—å®Ÿè¡Œ) ==="
          python -m pytest -n auto tests/integration/ --durations=10 --maxfail=5
        fi

    - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      if: matrix.test-group == 'unit'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # Status Checkç”¨
  status-check:
    name: tiered-ci
    runs-on: ubuntu-latest
    needs: [critical-tier, important-tier]
    if: always()
    steps:
    - name: Status Check
      run: |
        if [ "${{ needs.critical-tier.result }}" == "success" ] &&
           [ "${{ needs.important-tier.result }}" == "success" ] || [ "${{ needs.important-tier.result }}" == "skipped" ]; then
          echo "âœ… ãƒ†ã‚£ã‚¢åˆ¥CIæˆåŠŸ"
          exit 0
        else
          echo "âŒ ãƒ†ã‚£ã‚¢åˆ¥CIå¤±æ•—"
          exit 1
        fi
