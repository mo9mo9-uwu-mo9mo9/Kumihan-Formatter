name: Branch Name Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches-ignore:
      - main
      - develop

jobs:
  validate-branch-name:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check branch name for Japanese characters
      run: |
        # PR ã®å ´åˆã¯ head branch ã‚’ã€push ã®å ´åˆã¯ ref ã‹ã‚‰ branch åã‚’å–å¾—
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BRANCH_NAME="${{ github.head_ref }}"
        else
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
        fi
        
        echo "ğŸ” æ¤œè¨¼å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ: $BRANCH_NAME"
        
        # æ—¥æœ¬èªæ–‡å­—ï¼ˆã²ã‚‰ãŒãªã€ã‚«ã‚¿ã‚«ãƒŠã€æ¼¢å­—ï¼‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        # æ—¥æœ¬èªã®æ–‡å­—ç¯„å›²ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆUTF-8å¯¾å¿œï¼‰
        if echo "$BRANCH_NAME" | grep -E '[ã‚-ã‚“ã‚¢-ãƒ¶ä¸€-é¾ ]' > /dev/null; then
          echo "ğŸš¨ ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ãƒ³ãƒåã«æ—¥æœ¬èªãŒå«ã¾ã‚Œã¦ã„ã¾ã™"
          echo "ãƒ–ãƒ©ãƒ³ãƒå: $BRANCH_NAME"
          echo ""
          echo "ğŸ“‹ å¯¾å¿œæ–¹æ³•ï¼š"
          echo "1. è‹±èªã®ãƒ–ãƒ©ãƒ³ãƒåã«å¤‰æ›´ã—ã¦ãã ã•ã„"
          echo "   ä¾‹: feat/issue-{Issueç•ªå·}-{è‹±èªæ¦‚è¦}"
          echo ""
          echo "2. ãƒ–ãƒ©ãƒ³ãƒåå¤‰æ›´ã‚³ãƒãƒ³ãƒ‰ä¾‹ï¼š"
          echo "   git branch -m $BRANCH_NAME feat/issue-XXX-english-description"
          echo "   git push origin feat/issue-XXX-english-description"
          echo "   git push origin --delete $BRANCH_NAME"
          echo ""
          echo "ğŸ”’ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚"
          exit 1
        fi
        
        # æ¨å¥¨å‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯ï¼ˆè­¦å‘Šï¼‰
        if ! echo "$BRANCH_NAME" | grep -E '^(feat|fix|docs|style|refactor|test|chore)/issue-[0-9]+-[a-zA-Z0-9-]+$' > /dev/null; then
          if [ "$BRANCH_NAME" != "main" ] && [ "$BRANCH_NAME" != "develop" ]; then
            echo "âš ï¸  è­¦å‘Š: æ¨å¥¨ãƒ–ãƒ©ãƒ³ãƒå‘½åè¦å‰‡ã«å¾“ã£ã¦ã„ã¾ã›ã‚“"
            echo "ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: $BRANCH_NAME"
            echo "æ¨å¥¨å½¢å¼: {type}/issue-{ç•ªå·}-{è‹±èªæ¦‚è¦}"
            echo "ä¾‹: feat/issue-123-add-new-feature"
            echo ""
            echo "â„¹ï¸  ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ç¶™ç¶šã—ã¾ã™ãŒã€å‘½åè¦å‰‡ã®è¦‹ç›´ã—ã‚’æ¨å¥¨ã—ã¾ã™ã€‚"
          fi
        fi
        
        echo "âœ… ãƒ–ãƒ©ãƒ³ãƒåæ¤œè¨¼å®Œäº†: $BRANCH_NAME"

    - name: Add PR comment for Japanese branch name (if PR)
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const branchName = context.payload.pull_request.head.ref;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸš¨ **ãƒ–ãƒ©ãƒ³ãƒåã‚¨ãƒ©ãƒ¼**
            
ã“ã®PRã®ãƒ–ãƒ©ãƒ³ãƒåã«æ—¥æœ¬èªãŒå«ã¾ã‚Œã¦ã„ã¾ã™: \`${branchName}\`

## ğŸ“‹ å¯¾å¿œæ–¹æ³•
1. è‹±èªã®ãƒ–ãƒ©ãƒ³ãƒåã«å¤‰æ›´ã—ã¦ãã ã•ã„
   - æ¨å¥¨å½¢å¼: \`{type}/issue-{ç•ªå·}-{è‹±èªæ¦‚è¦}\`
   - ä¾‹: \`feat/issue-123-add-new-feature\`

2. ãƒ–ãƒ©ãƒ³ãƒåå¤‰æ›´ã‚³ãƒãƒ³ãƒ‰:
\`\`\`bash
# æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
git checkout -b feat/issue-XXX-english-description

# å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥
git push origin feat/issue-XXX-english-description

# å¤ã„ãƒ–ãƒ©ãƒ³ãƒã‚’å‰Šé™¤
git push origin --delete ${branchName}
\`\`\`

3. PRã®ãƒ–ãƒ©ãƒ³ãƒã‚’æ›´æ–°ã—ã¦ãã ã•ã„

## ğŸ”’ ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶
- æ—¥æœ¬èªãƒ–ãƒ©ãƒ³ãƒåã¯ **ã‚·ã‚¹ãƒ†ãƒ çš„ã«ç¦æ­¢** ã•ã‚Œã¦ã„ã¾ã™
- ã“ã®åˆ¶é™ã¯CLAUDE.mdã§å®šã‚ã‚‰ã‚ŒãŸé–‹ç™ºãƒ«ãƒ¼ãƒ«ã§ã™

å¤‰æ›´å¾Œã€ã“ã®PRã¯è‡ªå‹•çš„ã«æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒåã§æ›´æ–°ã•ã‚Œã¾ã™ã€‚`
          });