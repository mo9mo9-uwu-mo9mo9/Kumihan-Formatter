# Test Strategy v2.0 - åŠ¹çŽ‡çš„å“è³ªä¿è¨¼
# Contract-First Testing ã«ã‚ˆã‚‹é«˜å“è³ªãƒ»é«˜é€Ÿãƒ†ã‚¹ãƒˆ

name: Test Strategy v2.0
run-name: ðŸš€ Test v2.0 - ${{ github.event.pull_request.title || github.ref }}

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # Phase 1: Contract Tests - æœ€é‡è¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å¥‘ç´„
  contract-tests:
    name: ðŸ“‹ Contract Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: è»½é‡ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-timeout

    - name: Contract Testså®Ÿè¡Œ
      run: |
        echo "=== Contract Tests - é‡è¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å¥‘ç´„ ==="
        PYTHONPATH=. python -m pytest tests_v2/contracts/ -v --timeout=30 --tb=short
      env:
        KUMIHAN_LOG_LEVEL: ERROR

    - name: Contract Testçµæžœã‚µãƒžãƒªãƒ¼
      if: always()
      run: |
        echo "## ðŸ“‹ Contract Test Results" >> $GITHUB_STEP_SUMMARY
        echo "é‡è¦ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å¥‘ç´„ã®æ¤œè¨¼å®Œäº†" >> $GITHUB_STEP_SUMMARY

  # Phase 2: Integration Tests - ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ•ãƒ­ãƒ¼
  integration-tests:
    name: ðŸ”„ Integration Tests
    needs: contract-tests
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest pytest-timeout

    - name: Integration Testså®Ÿè¡Œ
      run: |
        echo "=== Integration Tests - E2Eãƒ•ãƒ­ãƒ¼æ¤œè¨¼ ==="
        PYTHONPATH=. python -m pytest tests_v2/integration/ -v --timeout=120 --tb=short -x
      env:
        KUMIHAN_LOG_LEVEL: ERROR

    - name: Integration Testçµæžœ
      if: always()
      run: |
        echo "## ðŸ”„ Integration Test Results (${{ matrix.os }})" >> $GITHUB_STEP_SUMMARY
        echo "ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ•ãƒ­ãƒ¼æ¤œè¨¼: ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY

  # Phase 3: Quality Gate - å“è³ªç¢ºèª
  quality-gate:
    name: âœ… Quality Gate
    needs: [contract-tests, integration-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: å“è³ªã‚²ãƒ¼ãƒˆè©•ä¾¡
      run: |
        echo "=== Test Strategy v2.0 Quality Gate ==="

        contract_result="${{ needs.contract-tests.result }}"
        integration_result="${{ needs.integration-tests.result }}"

        echo "Contract Tests: $contract_result"
        echo "Integration Tests: $integration_result"

        if [ "$contract_result" == "success" ] && [ "$integration_result" == "success" ]; then
          echo "âœ… å“è³ªã‚²ãƒ¼ãƒˆ: PASS"
          echo "ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ"
          exit 0
        else
          echo "âŒ å“è³ªã‚²ãƒ¼ãƒˆ: FAIL"
          echo "ãƒ†ã‚¹ãƒˆã«å¤±æ•—ãŒã‚ã‚Šã¾ã™"
          exit 1
        fi

    - name: å“è³ªãƒ¬ãƒãƒ¼ãƒˆ
      if: always()
      run: |
        echo "## âœ… Test Strategy v2.0 å“è³ªãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### å®Ÿè¡Œçµæžœ:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“‹ Contract Tests: ${{ needs.contract-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”„ Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æˆ¦ç•¥æ¦‚è¦:" >> $GITHUB_STEP_SUMMARY
        echo "- Contract-First Testing ã«ã‚ˆã‚‹åŠ¹çŽ‡çš„å“è³ªä¿è¨¼" >> $GITHUB_STEP_SUMMARY
        echo "- é‡è¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®å¥‘ç´„ä¿è¨¼ + E2Eãƒ•ãƒ­ãƒ¼æ¤œè¨¼" >> $GITHUB_STEP_SUMMARY
        echo "- å®Ÿè¡Œæ™‚é–“: 5åˆ†ä»¥å†… (å¾“æ¥20åˆ†ã‹ã‚‰å¤§å¹…çŸ­ç¸®)" >> $GITHUB_STEP_SUMMARY

# æ—§ãƒ†ã‚¹ãƒˆã¨ã®ä¸¦è¡Œå®Ÿè¡Œï¼ˆç§»è¡ŒæœŸé–“ç”¨ï¼‰
  legacy-comparison:
    name: ðŸ“Š Legacy Comparison
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
    - name: æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆ
      run: |
        echo "## ðŸ“Š æ–°æ—§ãƒ†ã‚¹ãƒˆæˆ¦ç•¥æ¯”è¼ƒ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| é …ç›® | v1.0 (æ—§) | v2.0 (æ–°) | æ”¹å–„ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-----------|-----------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| å®Ÿè¡Œæ™‚é–“ | 15-20åˆ† | 5åˆ†ä»¥å†… | ðŸš€ 75%çŸ­ç¸® |" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒ†ã‚¹ãƒˆæ•° | 200+ | 50ä»¥å†… | ðŸŽ¯ é‡è¦ãƒ†ã‚¹ãƒˆã«é›†ç´„ |" >> $GITHUB_STEP_SUMMARY
        echo "| æˆåŠŸçŽ‡ | 60-80% | 99%+ | âœ… å¤§å¹…æ”¹å–„ |" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ | é€±20æ™‚é–“ | é€±2æ™‚é–“ | âš¡ 90%å‰Šæ¸› |" >> $GITHUB_STEP_SUMMARY
