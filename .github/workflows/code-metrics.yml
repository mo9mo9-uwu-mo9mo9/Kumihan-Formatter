name: Code Metrics & Architecture Check

# æŠ€è¡“çš„è² å‚µäºˆé˜²ã®ãŸã‚ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç›£è¦–
# Issue #476å¯¾å¿œ: å¤§è¦æ¨¡ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°äºˆé˜²ç­–

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'kumihan_formatter/**/*.py'
  workflow_dispatch:

jobs:
  code-metrics:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install radon xenon flake8 mypy
        pip install -e .

    - name: ğŸ“ File Size Check
      run: |
        echo "## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯çµæœ" >> $GITHUB_STEP_SUMMARY
        python scripts/check_file_size.py --max-lines=300 || echo "ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºé•åãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"

    - name: ğŸ—ï¸ Architecture Check
      run: |
        echo "## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒã‚§ãƒƒã‚¯çµæœ" >> $GITHUB_STEP_SUMMARY
        python scripts/architecture_check.py --target-dir=kumihan_formatter || echo "ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£é•åãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"

    - name: ğŸ“Š Code Complexity Analysis
      run: |
        echo "## ğŸ“Š ã‚³ãƒ¼ãƒ‰è¤‡é›‘åº¦åˆ†æ" >> $GITHUB_STEP_SUMMARY
        echo "### Cyclomatic Complexity" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        radon cc kumihan_formatter/ --min=B --show-complexity || true
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

        echo "### Maintainability Index" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        radon mi kumihan_formatter/ --min=B || true
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ“ˆ Code Statistics
      run: |
        echo "## ğŸ“ˆ ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹çµ±è¨ˆ" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "=== ãƒ•ã‚¡ã‚¤ãƒ«çµ±è¨ˆ ==="
        find kumihan_formatter -name "*.py" | wc -l | xargs echo "Pythonãƒ•ã‚¡ã‚¤ãƒ«æ•°:"
        find kumihan_formatter -name "*.py" -exec wc -l {} + | tail -1 | awk '{print "ç·è¡Œæ•°: " $1}'
        echo ""
        echo "=== æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¸Šä½5ä½ï¼‰ ==="
        find kumihan_formatter -name "*.py" -exec wc -l {} + | sort -rn | head -5
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ” Technical Debt Detection
      run: |
        echo "## ğŸ” æŠ€è¡“çš„è² å‚µæ¤œå‡º" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

        echo "=== å¤§ãã™ãã‚‹ãƒ•ã‚¡ã‚¤ãƒ« (>300è¡Œ) ==="
        find kumihan_formatter -name "*.py" -exec wc -l {} + | awk '$1 > 300 {print $2 ": " $1 "è¡Œ"}' || echo "ãªã—"

        echo ""
        echo "=== è¤‡é›‘ã™ãã‚‹é–¢æ•° ==="
        radon cc kumihan_formatter/ --min=C --show-complexity || echo "ãªã—"

        echo ""
        echo "=== TODO/FIXME ã‚³ãƒ¡ãƒ³ãƒˆ ==="
        grep -r "TODO\|FIXME\|XXX\|HACK" kumihan_formatter/ --include="*.py" || echo "ãªã—"
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: âš ï¸ Check Thresholds
      run: |
        echo "## âš ï¸ é–¾å€¤ãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY

        # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºé–¾å€¤ãƒã‚§ãƒƒã‚¯
        large_files=$(find kumihan_formatter -name "*.py" -exec wc -l {} + | awk '$1 > 300 {count++} END {print count+0}')
        echo "å¤§ãã™ãã‚‹ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $large_files (é–¾å€¤: 0)" >> $GITHUB_STEP_SUMMARY

        # ç·è¡Œæ•°ãƒã‚§ãƒƒã‚¯
        total_lines=$(find kumihan_formatter -name "*.py" -exec wc -l {} + | tail -1 | awk '{print $1}')
        echo "ç·è¡Œæ•°: $total_lines (ç›®å®‰: <15000)" >> $GITHUB_STEP_SUMMARY

        # è¤‡é›‘åº¦ãƒã‚§ãƒƒã‚¯
        complex_functions=$(radon cc kumihan_formatter/ --min=C --show-complexity | wc -l)
        echo "è¤‡é›‘ã™ãã‚‹é–¢æ•°æ•°: $complex_functions (é–¾å€¤: 5)" >> $GITHUB_STEP_SUMMARY

        # è­¦å‘Šã®å‡ºåŠ›
        if [ "$large_files" -gt 0 ] || [ "$total_lines" -gt 15000 ] || [ "$complex_functions" -gt 5 ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸš¨ **æŠ€è¡“çš„è² å‚µã®è“„ç©ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ¨å¥¨å¯¾ç­–:" >> $GITHUB_STEP_SUMMARY
          echo "- Single Responsibility Principleã«å¾“ã£ã¦ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²" >> $GITHUB_STEP_SUMMARY
          echo "- å¤§ããªé–¢æ•°ã®åˆ†è§£" >> $GITHUB_STEP_SUMMARY
          echo "- è¤‡é›‘ãªæ¡ä»¶åˆ†å²ã®å˜ç´”åŒ–" >> $GITHUB_STEP_SUMMARY
          echo "- é‡è¤‡ã‚³ãƒ¼ãƒ‰ã®æ’é™¤" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **ã™ã¹ã¦ã®é–¾å€¤ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã„ã¾ã™ï¼**" >> $GITHUB_STEP_SUMMARY
        fi
