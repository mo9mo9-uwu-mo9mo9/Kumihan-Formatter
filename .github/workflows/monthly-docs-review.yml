name: Monthly Documentation Review

on:
  schedule:
    # æ¯Žæœˆç¬¬1æœˆæ›œæ—¥ã®9:00 JST (00:00 UTC)
    - cron: '0 0 * * MON'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  create-review-issue:
    name: Create Monthly Documentation Review Issue
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 # å…¨å±¥æ­´ã‚’å–å¾—
    
    - name: Check if first Monday of month
      id: check_date
      run: |
        # ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
        TODAY=$(date +%d)
        
        # ç¬¬1æœˆæ›œæ—¥ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆ1-7æ—¥ã®é–“ï¼‰
        if [ "$TODAY" -le 7 ]; then
          echo "is_first_monday=true" >> $GITHUB_OUTPUT
          echo "Today is the first Monday of the month"
        else
          echo "is_first_monday=false" >> $GITHUB_OUTPUT
          echo "Today is not the first Monday of the month"
        fi
    
    - name: Get recent commits
      if: steps.check_date.outputs.is_first_monday == 'true'
      id: recent_commits
      run: |
        # éŽåŽ»1ãƒ¶æœˆã®ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—
        MONTH_AGO=$(date -d '1 month ago' +%Y-%m-%d)
        echo "Getting commits since $MONTH_AGO"
        
        # æ©Ÿèƒ½è¿½åŠ ãƒ»ä¿®æ­£ã®ã‚³ãƒŸãƒƒãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿
        FEATURE_COMMITS=$(git log --since="$MONTH_AGO" --pretty=format:"- %s (%h)" --grep="feat:" --grep="fix:" --grep="docs:" | head -20)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã®çµ±è¨ˆ
        CHANGED_FILES=$(git diff --name-only --since="$MONTH_AGO" HEAD | grep -E "\.(py|md|txt|toml)$" | sort | uniq)
        
        # çµæžœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆGitHub Actionsã®å‡ºåŠ›åˆ¶é™å›žé¿ï¼‰
        echo "Recent feature/fix commits:" > /tmp/commits.txt
        echo "$FEATURE_COMMITS" >> /tmp/commits.txt
        echo "" >> /tmp/commits.txt
        echo "Changed files:" >> /tmp/commits.txt
        echo "$CHANGED_FILES" >> /tmp/commits.txt
        
        echo "commits_file=/tmp/commits.txt" >> $GITHUB_OUTPUT
    
    - name: Check documentation freshness
      if: steps.check_date.outputs.is_first_monday == 'true'
      id: doc_check
      run: |
        echo "Checking documentation freshness..."
        
        # å„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æœ€çµ‚æ›´æ–°æ—¥
        README_DATE=$(git log -1 --format="%ad" --date=short README.md)
        SPEC_DATE=$(git log -1 --format="%ad" --date=short SPEC.md)
        CLAUDE_DATE=$(git log -1 --format="%ad" --date=short CLAUDE.md)
        
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
        PYPROJECT_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
        INIT_VERSION=$(grep '__version__ = ' kumihan_formatter/__init__.py | sed 's/__version__ = "\(.*\)"/\1/')
        README_VERSION=$(grep -o 'version-[0-9.]*-blue' README.md | sed 's/version-\(.*\)-blue/\1/')
        
        # ãƒã‚§ãƒƒã‚¯çµæžœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        echo "Documentation Status:" > /tmp/doc_status.txt
        echo "- README.md: Last updated $README_DATE" >> /tmp/doc_status.txt
        echo "- SPEC.md: Last updated $SPEC_DATE" >> /tmp/doc_status.txt
        echo "- CLAUDE.md: Last updated $CLAUDE_DATE" >> /tmp/doc_status.txt
        echo "" >> /tmp/doc_status.txt
        echo "Version Consistency:" >> /tmp/doc_status.txt
        
        if [ "$PYPROJECT_VERSION" = "$INIT_VERSION" ] && [ "$PYPROJECT_VERSION" = "$README_VERSION" ]; then
          echo "âœ… All versions are consistent: $PYPROJECT_VERSION" >> /tmp/doc_status.txt
        else
          echo "âŒ Version inconsistency detected:" >> /tmp/doc_status.txt
          echo "  - pyproject.toml: $PYPROJECT_VERSION" >> /tmp/doc_status.txt
          echo "  - __init__.py: $INIT_VERSION" >> /tmp/doc_status.txt
          echo "  - README.md: $README_VERSION" >> /tmp/doc_status.txt
        fi
        
        echo "doc_status_file=/tmp/doc_status.txt" >> $GITHUB_OUTPUT
    
    - name: Create issue
      if: steps.check_date.outputs.is_first_monday == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # ç¾åœ¨ã®å¹´æœˆã‚’å–å¾—
        YEAR_MONTH=$(date +%Yå¹´%mæœˆ)
        
        # Issueæœ¬æ–‡ã‚’ä½œæˆ
        cat > /tmp/issue_body.md << 'EOF'
# æœˆæ¬¡ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼ - REPLACE_YEAR_MONTH

ã“ã®Issueã¯å®šæœŸçš„ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå“è³ªãƒã‚§ãƒƒã‚¯ã®ãŸã‚ã«è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

## ðŸ“‹ ä»Šæœˆã®ãƒã‚§ãƒƒã‚¯é …ç›®

### 1. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æœ€æ–°æ€§ç¢ºèª
EOF
        
        # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆçŠ¶æ³ã‚’è¿½åŠ 
        echo '```' >> /tmp/issue_body.md
        cat ${{ steps.doc_check.outputs.doc_status_file }} >> /tmp/issue_body.md
        echo '```' >> /tmp/issue_body.md
        
        cat >> /tmp/issue_body.md << 'EOF'

### 2. æœ€è¿‘ã®å¤‰æ›´å†…å®¹ãƒ¬ãƒ“ãƒ¥ãƒ¼

```
EOF
        
        # æœ€è¿‘ã®ã‚³ãƒŸãƒƒãƒˆã‚’è¿½åŠ 
        cat ${{ steps.recent_commits.outputs.commits_file }} >> /tmp/issue_body.md
        
        cat >> /tmp/issue_body.md << 'EOF'
```

### 3. ç¢ºèªã™ã¹ããƒã‚¤ãƒ³ãƒˆ

- [ ] æ–°æ©Ÿèƒ½ãŒREADME.mdã«åæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ä»•æ§˜å¤‰æ›´ãŒSPEC.mdã«åæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ãƒ­ãƒ¼ãƒ‰ãƒžãƒƒãƒ—ãŒå®Ÿæ…‹ã¨åˆã£ã¦ã„ã‚‹ã‹ï¼ˆCLAUDE.mdï¼‰
- [ ] ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒæœ€æ–°ã®æ©Ÿèƒ½ã‚’åæ˜ ã—ã¦ã„ã‚‹ã‹
- [ ] ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®æ•´åˆæ€§
- [ ] å¤–éƒ¨ãƒªãƒ³ã‚¯ã®æœ‰åŠ¹æ€§

### 4. æŽ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

ä»¥ä¸‹ã‚’æ¤œè¨Žã—ã¦ãã ã•ã„ï¼š

- å¤ããªã£ãŸæƒ…å ±ã®æ›´æ–°
- æ–°æ©Ÿèƒ½ã®ä½¿ç”¨ä¾‹è¿½åŠ 
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹é€ ã®æ”¹å–„
- ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã®å‘ä¸Š

## ðŸ”§ è‡ªå‹•åŒ–ã®æ”¹å–„

ã“ã®æœˆæ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§æ°—ã¥ã„ãŸç‚¹ãŒã‚ã‚Œã°ã€ä»¥ä¸‹ã‚’æ¤œè¨Žï¼š

- ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®æ”¹å–„
- è‡ªå‹•ãƒã‚§ãƒƒã‚¯ã®è¿½åŠ 
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç®¡ç†ãƒ—ãƒ­ã‚»ã‚¹ã®è¦‹ç›´ã—

---

ã“ã®Issueã¯ [monthly-docs-review.yml](/.github/workflows/monthly-docs-review.yml) ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
EOF
        
        # å¹´æœˆã‚’ç½®æ›
        sed -i "s/REPLACE_YEAR_MONTH/$YEAR_MONTH/g" /tmp/issue_body.md
        
        # Issueã‚’ä½œæˆ
        gh issue create \
          --title "æœˆæ¬¡ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼ - $YEAR_MONTH" \
          --body-file /tmp/issue_body.md \
          --label "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ" \
          --label "å„ªå…ˆåº¦:ä¸­" \
          --assignee mo9mo9-uwu-mo9mo9