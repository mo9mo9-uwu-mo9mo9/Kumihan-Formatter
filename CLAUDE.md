# CLAUDE.md

> **本ドキュメントは Claude Code (claude.ai/code) に本リポジトリの開発ガイドラインを日本語で伝えるためのものです。**
>
> プロジェクト名: **Kumihan-Formatter**  
> バージョン: 0.1.0 (CLI プロトタイプ)

---

## 1 📖 ツール概要

Kumihan-Formatter は **CoC6th 同人シナリオ** などのテキストファイル（.txt）を、*ワンコマンドで配布可能な HTML* に自動組版する **クロスプラットフォーム CLI ツール** です。

### 🎯 ターゲットユーザー
- **メインユーザー**: 開発知識を一切持たない同人作家
- **対象**: 組版知識・ツール経験なしでも作品を形にしたい方
- **対象外**: 企業・技術者・開発者向けではない

GUI は提供せず、Python 3.9 以上が導入されている **Windows / macOS** で動作します。

主なユーザーストーリー:

| # | ストーリー | 価値 |
|:-:|-------------------------|-------------|
| 1 | シナリオ作者は素の .txt を読み込ませたい | 面倒な組版作業から解放される |
| 2 | HTML 形式をワンコマンドで出力したい | 即売会・Booth でそのまま配布可能 |
| 3 | CSS を触らずに見栄えを整えたい | デザイン知識不要で品質確保 |
| 4 | batファイルをダブルクリックして変換したい | コマンドライン知識不要 |
| 5 | D&D操作で簡単に変換したい | 直感的な操作で高速化 |

### 🖥️ 基本操作方法
- **基本操作**: batファイル/commandファイルのダブルクリック → D&D変換・対話形式
- **上級操作**: ターミナルでのコマンド利用（優先度低）

---

## 2 🗺️ ロードマップ（ハイレベル）

| マイルストーン | 範囲 | 予定 |
|-----------|-------|------|
| **M0 – 初期セットアップ** | リポジトリ骨組み、Poetry/venv、CI | *完了* |
| **M1 – パーサ & HTML レンダラ** | §5 基本機能 1〜6 | *完了* |
| **M2 – UX 改善** | ライブプレビュー、エラーハイライト | *完了* |
| **M3 – 拡張フック** | YAML/JSON 設定、テーマ切替 | *完了* |
| **M4 – ドキュメント整備** | READMEのHTML化、ユーザーガイド作成 | 進行中 |
| **M5 – 配布機能** | ZIP配布、バッチファイル整備 | 計画中 |
| **M6 – UI改善** | D&D対応、直感的操作 | 計画中 |
| **M7 – 正式版準備** | バグ修正、テスト強化、フィードバック反映 | 計画中 |
| **M8 – 追加出力** | PDF 出力、EPUB 出力 | バックログ |

> **スプリント長** : 1 週間（ソロ開発）

### 🏷️ バージョニング戦略

#### セマンティックバージョニング採用
**MAJOR.MINOR.PATCH** 形式でバージョン管理を行います。

| バージョン | マイルストーン | 内容 | 備考 |
|-----------|-------------|------|------|
| **0.1.0** | M1-M3完了 | 基本機能実装 | *現在* |
| **0.2.0** | M4完了 | ドキュメント整備 | 配布準備の基盤 |
| **0.3.0** | M5完了 | 配布機能 | ユーザーが受け取れる形 |
| **0.4.0** | M6完了 | UI改善 | 初心者でも使える形 |
| **0.9.0** | M7完了 | 正式版準備 | バグ修正・テスト強化 |
| **0.9.x** | - | フィードバック反映 | 品質向上イテレーション |
| **1.0.0** | - | 初回正式リリース | **人様に渡せる品質** |

#### バージョン管理ツール
- **bumpversion**: pyproject.tomlで自動バージョン更新・タグ作成
- **Git タグ**: `v0.2.0` 形式でリリースポイントを管理

---

## 3 🧩 アーキテクチャ概要

```text
┌─ kumihan_formatter/            # Python パッケージルート
│  ├─ cli.py          ← Click CLIエントリポイント
│  ├─ parser.py       ← テキスト → AST (段落・ブロック・キーワード付きリスト)
│  ├─ renderer.py     ← AST → HTML (Jinja2 テンプレート)
│  ├─ config.py       ← YAML/JSON設定ファイル管理
│  ├─ templates/      ← base.html.j2
│  └─ utils/
│      └─ __init__.py
├─ dev/                # 開発者向けファイル
│  ├─ tests/          # テストファイル群
│  │  ├─ test_parser.py
│  │  ├─ test_renderer.py
│  │  ├─ test_config.py
│  │  └─ test_cli.py
│  └─ tools/
│      └─ generate_test_file.py
└─ examples/
    ├─ sample.txt
    ├─ comprehensive-sample.txt
    └─ config-sample.yaml
```

* **単一責任:** parser は純粋に構文解析、renderer は純粋に変換を担当。
* **プラガブル:** マーカーや CSS は YAML で増減可能。
* **ステートレス:** 大部分を純粋関数で構成しテスト容易性を向上。

---

## 4 ⚙️ 開発環境セットアップ（Claude Code）

### 4.1 初期化コマンド

```bash
# 1) リポジトリを取得
$ git clone https://github.com/USERNAME/kumihan-formatter.git
$ cd kumihan-formatter

# 2) 仮想環境（Python ≥ 3.9）を作成しインストール
$ python -m venv .venv && source .venv/bin/activate
$ pip install -e .[dev]        # dev extras = pytest, flake8, rich

# 3) テスト実行
$ pytest -q
```

### 4.2 ローカル実行例

```bash
$ python -m kumihan_formatter.cli \
    examples/sample.txt \
    -o dist/
```

主なフラグ（`-h` で一覧表示）:

| フラグ | 説明 |
|------|-------------|
| `-o, --output DIR` | 出力フォルダ (default: ./dist) |
| `--no-preview` | HTML 生成後にブラウザを開かない |
| `--config FILE` | YAML/JSON 設定ファイルを指定 |

---

## 5 🖋️ フォーマット仕様（要件定義書 §4 + 拡張）

| 入力構文 | 出力 HTML |
|--------------|---------------|
| 空行区切り | `<p>` 段落 |
| `- ` リスト | `<ul><li>` |
| `- ;;;キーワード;;; テキスト` | **キーワード付きリスト項目** |
| `- ;;;キー1＋キー2;;; テキスト` | **複合キーワード付きリスト項目** |
| `;;;キーワード\n内容\n;;;` | 単一ブロックタグ |
| `;;;キー1＋キー2\n内容\n;;;` | **複合ブロックタグ**（順不同・全適用） |

### 5.1 ブロックキーワード → タグ対照表

| キーワード | HTML | 備考 |
|---------|------|-------|
| 太字 | `<strong>` | ブロック全体 |
| イタリック | `<em>` | |
| 枠線 | `<div class="box">` | 標準枠線 + padding |
| ハイライト＋color=#hex | `<div class="highlight" style="background-color:#hex">` | 色指定可（属性は＋で連結） |
| 見出しN | `<hN>` | N = 1–5 |

### 5.2 複合キーワードのルール

* **連結記号**: 半角 `+` **または** 全角 `＋` のいずれでも認識します。
* これらで **複数のキーワードを連結** すると、そのすべてを適用した HTML を生成します。
* キーワードの並び順は不問です（パーサ側で正規化）。
* 同一カテゴリのキーワードが重複した場合は先頭を優先し、重複を警告として出力します。
* いずれかのキーワードが未知、または論理的に矛盾する組み合わせの場合は `[ERROR:invalid-combination]` として出力し、背景色 `#ffe6e6` で強調表示します。
* 出力 HTML は **内側に “高レベル → 低レベル”** の順でネストします（例: 見出し → 強調）。

### 5.3 複合キーワード例

| 入力 | 期待される HTML 構造 | 説明 |
|------|--------------------|------|
| `;;;見出し2＋太字\nこんにちは\n;;;` | `<h2><strong>こんにちは</strong></h2>` | 2 つのスタイルを合成した見出し |
| `;;;枠線＋ハイライト＋color=#ff0\n内容\n;;;` | `<div class="highlight" style="background-color:#ff0"><div class="box">内容</div></div>` | 枠線とハイライトを組み合わせ |
| `;;;太字＋イタリック\n内容\n;;;` | `<strong><em>内容</em></strong>` | 強調を二重適用 |

### 5.4 キーワード付きリスト例

| 入力 | 期待される HTML 構造 | 説明 |
|------|--------------------|------|
| `- ;;;枠線;;; 枠線付きの項目` | `<ul><li><div class="box">枠線付きの項目</div></li></ul>` | 単一キーワード付きリスト |
| `- ;;;太字＋枠線;;; 複合スタイル項目` | `<ul><li><div class="box"><strong>複合スタイル項目</strong></div></li></ul>` | 複合キーワード付きリスト |
| `- ;;;見出し2＋枠線＋太字;;; 3つ組み合わせ` | `<ul><li><h2><div class="box"><strong>3つ組み合わせ</strong></div></li></ul>` | 3つ以上のキーワード組み合わせ |
| `- ;;;ハイライト＋color=#ff0＋太字;;; 色付き` | `<ul><li><div class="highlight" style="background-color:#ff0"><strong>色付き</strong></div></li></ul>` | 属性付き複合キーワード |

### 5.5 ネスト順序ルール

キーワード付きリストと複合ブロックタグでは、以下の優先順位でネスト構造を決定します：

1. **見出し**（`見出し1`〜`見出し5`）- 最外側
2. **ハイライト**（`ハイライト`）
3. **枠線**（`枠線`）
4. **太字**（`太字`）
5. **イタリック**（`イタリック`）- 最内側

例：`見出し2＋ハイライト＋枠線＋太字` → `<h2><div class="highlight"><div class="box"><strong>…</strong></div></div></h2>`

> **実装指針:**
> * 複合キーワードは `"＋"` で分割し、一つずつ標準キーワードとして解釈。
> * 変換時に **タグのネスト順** を `['見出し', 'div系', 'strong', 'em']` の優先度で決定。
> * テストケースを `tests/test_parser.py::test_combined_markers` に追加し、パターン毎に期待 HTML を検証すること。

### 5.6 エスケープ・誤認識対策

- **エスケープ**: `###` で `;;;` を文字として表示
- **誤認識対策**: `;;;` は行頭のみ有効
- **空ブロック**: エラーメッセージ表示（「内容を入力してください」等）

パーサは *無効なマーカー* を `[ERROR:<msg>]` として出力し、背景色 #ffe6e6 で強調表示します。

---

## 6 🛠️ テスト戦略

* **ユニット**: パーサ & レンダラの境界ケース（マーカー入れ子、不正構文）
* **ゴールデン**: sample.txt → expected.html のスナップショット比較
* **パフォーマンス**: 10 k 文字 ≤ 1 秒（pytest-benchmark）

### CI スモークテスト

```bash
pytest && \
python -m kumihan_formatter.cli examples/sample.txt -o /tmp/out
```

---

## 7 📃 非機能要件サマリ

| 分類 | 要件 |
|----------|-------------|
| **性能** | 10 k 文字 → HTML ≤ 1 秒 |
| **信頼性** | エラー位置を HTML 内で可視化 |
| **移植性** | Python 標準 + `rich`, `jinja2`, `click` のみ |
| **セキュリティ** | 完全オフライン。上書き防止チェック有 |
| **i18n** | UI・メッセージともに日本語のみ |

---

## 8 🎲 製品戦略

### 8.1 開発段階
1. **第1段階**: CoC6th専用ツールとして完成
2. **第2段階**: TRPG汎用組版ツールへ拡大

### 8.2 配布・ライセンス方針
- **改変**: 自由に許可
- **再配布**: 禁止
- **基本方針**: 個人利用に特化
- **開発体制**: 個人開発、マネタイズなし

### 8.3 UI/UX 設計方針
- **GUI化・WEB化**: コスト重でCLI維持
- **複雑化回避**: 基本機能で十分使えることを重視

## 9 🔮 拡張フック（今後検討）

* テーマ / フォント / レイアウト切替（JSON スキーマ）
* 画像埋め込み (`:::画像 path=... alt=...`)
* PDF 出力（`weasyprint`）
* カスタムブロック用プラグインインタフェース

---

## 10 🤝 コントリビューションガイド

* **コードスタイル**: black + isort + flake8
* **コミット規約**: Conventional Commits (`feat:`, `fix:` など)

### 🏷️ GitHub Issue ラベリングルール

本プロジェクトでは日本語ラベルを使用し、体系的なIssue管理を行います。

#### 優先度ラベル（必須）
すべてのIssueに以下のいずれかを付与：

| ラベル | 用途 | 例 |
|-------|------|-----|
| `優先度:緊急` | システム停止・セキュリティ問題 | 変換できない、データ破損 |
| `優先度:高` | 重要な機能障害・リリースブロッカー | 主要機能の不具合 |
| `優先度:中` | 通常の機能改善・軽微なバグ | UI改善、細かなバグ |
| `優先度:低` | 細かい改善・将来的な検討事項 | ドキュメント微調整 |
| `優先度:保留` | あったら良い程度・将来検討 | 新機能のアイデア |

#### 種類ラベル（推奨）
Issueの内容に応じて付与：

| ラベル | 用途 |
|-------|------|
| `バグ` | 何かが正常に動作しない |
| `機能改善` | 既存機能の改善・新機能リクエスト |
| `種類:新機能` | 全く新しい機能の実装 |
| `種類:リファクタ` | コード整理・構造改善 |
| `種類:テスト` | テスト関連の作業 |
| `種類:パフォーマンス` | 性能改善 |
| `ドキュメント` | ドキュメントの改善・追加 |
| `質問` | 詳細情報が必要・質問 |

#### 状況ラベル（任意）
作業の進捗管理に使用：

| ラベル | 用途 |
|-------|------|
| `状況:調査中` | 作業開始前に調査が必要 |
| `状況:ブロック中` | 他のIssueや外部依存により一時停止 |
| `状況:着手可能` | 作業開始可能 |
| `状況:作業中` | 現在作業中 |

#### 難易度ラベル（任意）
技術的な難易度を示す：

| ラベル | 用途 |
|-------|------|
| `難易度:易` | 初心者向け・簡単 |
| `難易度:中` | ある程度の経験が必要 |
| `難易度:難` | 高度な技術・経験が必要 |

#### ラベル付与ルール
1. **優先度ラベルは必須** - すべてのIssueに付与する
2. **複数ラベル可** - 種類+状況+難易度の組み合わせ推奨
3. **日本語統一** - 英語ラベルは使用しない
4. **新規Issue作成時** - 最低限 優先度+種類 を付与する
5. **定期見直し** - 状況ラベルは作業進捗に応じて更新する

---

## 11 🔄 開発ワークフロー

1. **応答は必ず日本語を使用すること。**
2. **コード追加前** に必ず *開発ブランチ* (`feature/XXX`) を切る。
3. 機能コードと **対応するテストコード** を *セットで追加* する。
4. **コミット後** に *プルリクエスト* を作成し、レビュー後 **main ブランチにマージ** する。
5. **マージ後**、関連 **Issue を更新・整理** する。
6. マージが完了したら **不要ブランチを削除** する。
7. 1から6までの作業完了後、作業に関連するIssueがあれば更新する。

---

## 12 🚨 **絶対に守るべき禁止事項**

### 🔒 **ファイル削除の絶対禁止**
以下のファイル・フォルダは **絶対に削除してはならない**：

1. **CLAUDE.md** - 本ファイル（プロジェクトの仕様書・指示書）
   - `rm`、`git rm`、その他あらゆる削除操作禁止
   - Claude Code の動作を制御する重要ファイル

2. **.claude/ フォルダ内の全ファイル** - Claude Code設定フォルダ
   - `settings.local.json` などの設定ファイル
   - Claude Code自身の権限管理ファイル
   - 削除すると機能に重大な影響

### 🚫 **GitHubアップロード禁止**
Claude Code関連の設定ファイルはGitHubにアップロードしてはならない：
- `.claude/settings.local.json`
- その他 `.claude/` フォルダ内のファイル
- `.gitignore` で除外済み、追跡から外すこと

### ⚠️ **違反時の対応**
これらの禁止事項に違反した場合：
1. 即座に作業を停止
2. 可能な限り復元を試行
3. 同様の問題を防ぐ対策を実施

### 📋 **遵守チェックリスト**
- [ ] `rm` コマンド使用前に削除対象を確認
- [ ] `git rm` 実行前に対象ファイルを確認  
- [ ] コミット前に `.claude/` 関連ファイルが含まれていないか確認
- [ ] CLAUDE.md の変更は追記のみ、削除は禁止

---

## 13 📝 **追加指示・学習事項**

### 🎯 **今後の方針**
- プルリクエストワークフローの徹底
- 重要ファイルの保護意識の向上
- 丁寧なファイル操作の実行

### 📋 **開発ガイドライン**
- **シンプルさを優先**: 基本機能で十分使えることを重視
- **設定ファイルは上級者向け**: JSON/YAML設定は表に出さず、「カスタマイズも可能」程度の言及に留める
- **初心者に優しいUI**: 複雑な機能は隠し、基本的な使い方を前面に出す
- **ドキュメントの階層化**: 基本→応用→上級者向けの順で情報を整理
- **UIの複雑化を避ける**: 設定項目の増加より、使いやすさを優先
- **機能の段階的開示**: 初心者が圧倒されないよう、段階的に機能を紹介

### 📅 **更新履歴**
- 2025-06-22: GitHub Issueラベリングルールを策定・適用
  - 日本語ラベル体系を構築（優先度・種類・状況・難易度）
  - 既存13個のIssueすべてに適切なラベルを付与
  - CLAUDE.mdにラベリングルールセクションを追加
  - 英語ラベルを削除し、日本語統一を完了
- 2025-06-22: Issue #68でフォーマット記号仕様を大幅変更
  - フォーマット記号を `:::` → `;;;` に変更（誤認識対策）
  - 複合キーワードの連結記号を全角 `＋` に統一
  - 属性付きキーワードを `;;;ハイライト＋color=#ff0;;;` 形式に変更
  - エスケープ機能追加（`###` で `;;;` を表示）
  - 行頭のみ有効による誤認識対策を追加
- 2025-06-22: Issue #67を元にした開発戦略の明確化
  - ターゲットユーザーを開発知識なしの同人作家に特化
  - 基本操作をダブルクリック→D&D方式に変更
  - 製品戦略（CoC6th→TRPG汎用）と配布方針を明確化
  - M4にD&D対応を追加
- 2025-06-22: 配布戦略の拡張（M4開始）
  - GitHubに加えてBoothなど他プラットフォームでの配布対応を計画
  - ドキュメントHTML化対応（Issue #65）
  - ZIP配布対応の包括的実装（Issue #66）
  - ユーザー層拡大：開発者 → 同人作家・一般ユーザー
- 2025-01-21: v0.1.0 リリース完了
  - 基本機能実装完了（M1〜M3）
  - ドキュメント整備
  - テスト網羅ファイル生成機能追加
  - ダブルクリック実行スクリプト整備
  - キーワード付きリスト機能追加
- 2025-01-21: 開発方針更新（Issue #38）
  - 設定ファイルを上級者向け機能として位置づけ
  - ドキュメントでの扱いを控えめに変更
  - UIの複雑化を避ける方針を追加
  - 機能の段階的開示による初心者への配慮を強化

---

開発を楽しみましょう！ 🎉

