# CLAUDE.md

> **Kumihan-Formatter** - Claude Code プロジェクト設定ファイル  
> **Status**: Development - 2025年版最適化済み

---

## 🎯 プロジェクト概要

- **言語**: 日本語メインプロジェクト
- **技術スタック**: Python 3.12+, Black, mypy (strict), pytest, Serena MCP
- **記法**: Kumihan独自ブロック記法 (`# 装飾名 #内容##`)
- **最適化状況**: 5Phase統合最適化進行中 (2025年版アーキテクチャ)

### 🏆 統合最適化成果 (Phase1-5進行中)
- **パーサー統合**: 統合パーサーシステム構築中 (95個のPythonファイル)
- **ディレクトリ簡素化**: モジュール構造最適化進行中
- **テスト強化**: 17テストファイル、テストピラミッド構築完了
- **レガシー削除**: 継続的リファクタリング実施中

## 📋 開発原則

### コア原則
1. **作業計画の事前報告**: ファイル変更・実行前に必ず計画を報告
2. **ユーザー主導**: AIは提案のみ、決定権はユーザーが保持
3. **指示の厳格遵守**: 非効率でもユーザー指示を最優先
4. **透明性の確保**: 全作業プロセスを明確に報告

### 基本ルール
- **一時ファイル**: 全て `tmp/` 配下に出力（絶対遵守）
- **日本語使用**: コメント・レビュー・ドキュメントは日本語
- **ログ使用**: `from kumihan_formatter.core.utilities.logger import get_logger`
- **効率的コード探索**: Serenaツール優先、ファイル全読み込み最小化
- **セマンティック編集**: シンボル単位での精密な編集実行

---

## 🔧 開発ワークフロー

### ブランチ管理
```bash
# 必須形式: {type}/issue-{番号}-{英語概要}
git checkout -b feat/issue-123-description
```

### Issue・PR管理
```bash
gh issue create --title "タイトル" --body "内容" --label "ラベル"
gh pr create --title "タイトル" --body "詳細説明"
```

### テスト・品質管理（シンプル版）
```bash
make lint       # Black + mypy（高速）
make test       # pytest（基本テスト）
make test-unit  # 単体テストのみ（超高速）
```

---

## 🛡️ 品質保証システム

### Layer 0: セマンティック解析（Serena MCP）
- シンボル関係性の事前検証、影響範囲の正確な特定
- 型安全性の事前確保、mypy strictモードとの統合検証
- リファクタリング前の依存関係マップ生成

### Layer 1: 構文検証（自動）
- AST解析による構文エラー検出、型注釈パターン自動修正

### Layer 2: 品質検証（自動・シンプル版）
```bash
make lint        # Black + mypy 通過必須
make test        # pytest 全通過必須
```

### Layer 3: Claude最終承認（手動）
- **コードレビュー**: 成果物の詳細確認・品質責任
- **統合確認**: 全体システムとの整合性検証

---

## 🧠 コード解析・編集ツール

### Serena MCP活用方針
- **セマンティック解析優先**: `find_symbol`, `find_referencing_symbols`による精密な検索
- **効率的探索**: ファイル全体読み込み回避、シンボル単位での対象解析
- **関係性追跡**: パーサー・レンダラー間の依存関係の正確な把握
- **型安全編集**: mypy strictモードとの連携による安全なリファクタリング

### コード探索戦略
1. **概要把握**: `get_symbols_overview` でファイル構造理解
2. **シンボル検索**: `find_symbol` で対象の特定・詳細取得
3. **影響範囲調査**: `find_referencing_symbols` で変更影響の事前確認
4. **精密編集**: `replace_symbol_body`, `insert_after_symbol` での安全な変更

### 適用場面
- **大規模リファクタリング**: パーサーエンジンの改修時
- **新機能実装**: レンダラーとパーサーの統合処理追加
- **バグ修正**: 複雑な依存関係を持つモジュール間の問題解決
- **型安全性向上**: mypy strict準拠のための段階的修正

---

## 📝 コーディング標準

### Python コードスタイル（シンプル版）
- **フォーマット**: Black (line-length=88)
- **型注釈**: mypy strict mode必須
- **ログ**: プロジェクト標準ロガー使用

### ファイル・関数サイズ制限（厳格遵守）
#### ファイル単位の適正行数
- **推奨上限**: **500行以下** ✅
- **警戒ライン**: 500行を超えると注意が必要 ⚠️
- **危険ライン**: 1000行以上は確実にリファクタリング対象 ❌

#### 関数・メソッドの適正行数
- **一般的**: 20-50行程度 ✅
- **複雑なアルゴリズム**: 100-200行まで許容 ⚠️
- **上限**: 200行を超える場合は慎重に検討・分割必須 ❌

#### 責任分離戦略
- **単一責任原則**: 1ファイル1責任を厳格遵守
- **機能別分割**: parser.py + handlers.py + utils.py 構成推奨
- **依存関係**: 循環依存の完全排除

### ファイル出力・エラーハンドリング
- **出力**: 必ず`tmp/`配下に保存
- **ログ**: `from kumihan_formatter.core.utilities.logger import get_logger`

---

## 🎨 Kumihan記法仕様

### 基本記法
- **ブロック記法**: `# 装飾名 #内容##` （太字・イタリック・見出し等）
- **構造要素**: 見出し・リスト・目次・リンク対応

---

## 📊 プロジェクト構造

### 主要コンポーネント (2025年版アーキテクチャ)
- **パーサー**: `core/parsing/` - 記法解析エンジン  
- **処理**: `core/processing/` - ドキュメント変換・処理ロジック
- **レンダラー**: `core/rendering/` - HTML出力・テンプレート処理
- **テンプレート**: `core/templates/` - HTML テンプレートシステム
- **型定義**: `core/types/` - 型定義・データクラス
- **ユーティリティ**: `core/utilities/` - 共通ユーティリティ
- **バリデーション**: `core/validation/` - データ検証・エラー処理
- **AST**: `core/ast_nodes/` - 抽象構文木ノード
- **エラー処理**: `core/error_handling/` - エラーハンドリング
- **共通基盤**: `core/common/` - 基盤クラス・機能
- **設定管理**: `core/config/` - 設定管理システム
- **入出力**: `core/io/` - ファイル入出力処理
- **パターン**: `core/patterns/` - デザインパターン実装
- **構文**: `core/syntax/` - 構文定義・ルール
- **CLI**: `cli.py + commands/` - コマンドライン interface

---

## ⚙️ 重要な実行時注意事項

### 禁止事項
- ❌ 日本語ブランチ名（システム的に拒否）
- ❌ プロジェクトルート直下への一時ファイル出力
- ❌ 英語でのレビュー・コメント
- ❌ **`python`コマンド使用**（必ず`python3`を使用）

### 必須事項
- ✅ 作業前の計画報告
- ✅ tmp/ 配下での一時ファイル管理
- ✅ 品質チェック（lint/typecheck）の実行

---

## 🚀 品質保証コマンド（シンプル版）

```bash
# 基本品質チェック
make claude-check            # CLAUDE.mdサイズ・構造チェック
make lint                   # Black + mypy（高速）
make test                   # pytest全テスト実行
make test-unit              # 単体テストのみ（超高速）
```

---

## 🧪 テスト戦略（個人開発特化）

> **基本方針**: 質重視・量制限・ROI最大化  
> **2024年調査結果**: 89%の組織がテスト自動化に投資するも、23%のみが効果測定可能

### テスト量・カバレッジ目標
#### 現実的な目標値（個人開発）
- **コードカバレッジ**: **70-80%** が適正 ✅
  - 企業標準80%に対し、個人開発では現実的な範囲
  - 100%は過剰・保守負担増大のリスク
- **テスト:コード比率**: **1:0.3～1:0.5** 推奨
  - エンタープライズ(1:1-2)より控えめ
  - 保守性と開発速度のバランス重視

#### 時間投資の目安
- **テスト工数**: 開発時間の **40-50%** 追加
  - 例: 機能開発10日 → テスト4-5日
- **全体配分**: 解析25% + 開発・テスト50% + 検証25%

### テストピラミッド戦略（2024年版）
```
    E2E Tests (最小限)
       /----------\
      /  UI Tests  \    ← 5-10% (重要フローのみ)
     /              \
    /  API/統合Tests  \  ← 20-30% (ビジネスロジック)
   /------------------\
  /   Unit Tests       \ ← 60-70% (関数・クラス)
 /____________________\
```

#### 1. 基盤: ユニットテスト（60-70%）
- **対象**: 純粋関数、ビジネスロジック、ユーティリティ
- **利点**: 高速実行、低メンテナンス、即座フィードバック
- **重点**: セキュリティ・パーサー・設定管理のコア機能

#### 2. 中間層: API/統合テスト（20-30%）
- **対象**: モジュール間連携、外部API、データベース操作
- **理由**: **大部分のバグはここで発生** (UI以外)
- **利点**: UIテストより高速・安定、リアルな動作検証

#### 3. 上位層: E2Eテスト（5-10%）
- **対象**: **重要なユーザージャーニーのみ**
  - 認証フロー、コア変換処理、CLI基本動作
- **制限理由**: 最も脆弱・保守コスト高・実行時間長
- **原則**: 最小限に留める

### 優先順位付け戦略
#### 1. クリティカル機能優先（80/20ルール）
- **20%の重要機能に80%のテストを集中**
- セキュリティ機能、パーサーコア、設定管理
- 障害時の影響度・利用頻度で判断

#### 2. ビジネスロジック重視
- **UIより内部ロジックを優先**
- 計算処理、バリデーション、変換アルゴリズム
- 外部依存の少ない純粋な処理から

#### 3. BDD (Bug-Driven Development)
- **バグ発見後に該当テスト追加**
- 完璧な事前予測より高速リリース・修正
- リグレッション防止に特化

### 保守性重視の原則
#### メンテナンスコスト最小化
- **上位テストほど高コスト**: E2E > 統合 > ユニット
- **テスト自体も保守対象**: 複雑なテストは避ける
- **高速フィードバック**: 遅いテストは開発を阻害

#### AI活用時の注意点
- **監督なしの自動生成**: 過剰・無意味なテスト量産
- **自動修復の誤用**: 実際の問題を隠蔽するリスク
- **人的判断**: ツールの提案を精査・選別

### 実装ガイドライン
#### スタートアップ戦略
1. **スモールスタート**: いきなり80%カバレッジを目指さない
2. **段階的構築**: 重要機能から順次拡張
3. **継続的改善**: リファクタリング時にテスト整備

#### 実行・自動化
```bash
# 高速フィードバックループ
make test-unit      # <1秒: ユニットテストのみ
make test-integration # <10秒: API・統合テスト
make test          # <60秒: 全体テスト（CI用）
```

### 品質指標（参考値）
- **実行時間**: ユニット<1秒、統合<10秒、E2E<60秒
- **成功率**: >95% (不安定テスト削除)
- **保守工数**: 機能開発の<20% (テスト修正含む)

### ❌ 避けるべき過剰パターン
- **網羅的テスト**: 全機能を同等にテスト
- **UI偏重**: 見た目のテストに時間消費
- **完璧主義**: 100%カバレッジ追求
- **AI盲信**: 自動生成テストをそのまま採用

---

## 🚀 統合API使用方法 (2025年版アーキテクチャ)

### 基本的な使用
```python
from kumihan_formatter.unified_api import KumihanFormatter

# 基本的な変換
formatter = KumihanFormatter()
result = formatter.convert("input.txt", "output.html")

# 設定ファイル指定
formatter = KumihanFormatter(config_path="config.json")
result = formatter.convert("input.txt", "output.html", template="custom")

# オプション指定
options = {"enable_toc": True, "style": "modern"}
result = formatter.convert("input.txt", options=options)
```

### 統合Managerシステム (5つのManager)
- **CoreManager**: ファイル入出力・基盤機能
- **ParsingManager**: 解析処理制御
- **OptimizationManager**: 最適化処理
- **PluginManager**: プラグインシステム
- **DistributionManager**: 配布・出力管理

### メインコンポーネント
- **MainParser**: 統合パーサー（自動パーサー選択）
- **MainRenderer**: 統合レンダラー（HTML出力）

---

*🎯 Claude Code最適化済み - 統合最適化版（2025年アーキテクチャ）*