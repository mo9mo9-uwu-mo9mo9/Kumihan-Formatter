#!/usr/bin/env python3
"""
Quality Dashboard Generator
ÂìÅË≥™„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁîüÊàê„Ç∑„Çπ„ÉÜ„É† - HTML„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„ÉªÂèØË¶ñÂåñ„Éª„É™„Ç¢„É´„Çø„Ç§„É†Ë°®Á§∫
„É°„Éà„É™„ÇØ„ÇπÁµ±Âêà„Éª„Éà„É¨„É≥„ÉâÂèØË¶ñÂåñ„Éª„Ç¢„É©„Éº„ÉàË°®Á§∫„Éª„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„ÉñUI
"""

import os
import json
import datetime
from typing import Dict, List, Any, Optional
from pathlib import Path

class QualityDashboardGenerator:
    """ÂìÅË≥™„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁîüÊàê„Ç∑„Çπ„ÉÜ„É†"""
    
    def __init__(self):
        self.dashboard_dir = Path("postbox/quality/dashboard")
        self.templates_dir = self.dashboard_dir / "templates"
        self.output_dir = Path("tmp/quality_dashboard")
        
        # „Éá„Ç£„É¨„ÇØ„Éà„É™‰ΩúÊàê
        self.dashboard_dir.mkdir(parents=True, exist_ok=True)
        self.templates_dir.mkdir(parents=True, exist_ok=True)
        self.output_dir.mkdir(parents=True, exist_ok=True)
        
        self.metrics_path = self.dashboard_dir / "collected_metrics.json"
        
        print("üìä QualityDashboardGenerator ÂàùÊúüÂåñÂÆå‰∫Ü")
    
    def generate_dashboard(self, output_format: str = "html") -> str:
        """„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁîüÊàê"""
        
        print(f"üìä ÂìÅË≥™„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁîüÊàêÈñãÂßã ({output_format})...")
        
        # „É°„Éà„É™„ÇØ„Çπ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        metrics_data = self._load_metrics_data()
        
        if not metrics_data:
            print("‚ö†Ô∏è „É°„Éà„É™„ÇØ„Çπ„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì")
            return self._generate_no_data_dashboard()
        
        if output_format == "html":
            return self._generate_html_dashboard(metrics_data)
        elif output_format == "json":
            return self._generate_json_dashboard(metrics_data)
        else:
            raise ValueError(f"„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂá∫ÂäõÂΩ¢Âºè: {output_format}")
    
    def _load_metrics_data(self) -> Optional[Dict[str, Any]]:
        """„É°„Éà„É™„ÇØ„Çπ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø"""
        
        try:
            if self.metrics_path.exists():
                with open(self.metrics_path, 'r', encoding='utf-8') as f:
                    return json.load(f)
            else:
                print(f"‚ö†Ô∏è „É°„Éà„É™„ÇØ„Çπ„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: {self.metrics_path}")
                return None
        except Exception as e:
            print(f"‚ùå „É°„Éà„É™„ÇØ„Çπ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº: {e}")
            return None
    
    def _generate_html_dashboard(self, metrics_data: Dict[str, Any]) -> str:
        """HTML„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁîüÊàê"""
        
        dashboard_html = self._create_html_template()
        
        # „Éá„Éº„ÇøÊåøÂÖ•
        dashboard_html = dashboard_html.replace("{{METRICS_DATA}}", json.dumps(metrics_data, ensure_ascii=False, indent=2))
        dashboard_html = dashboard_html.replace("{{GENERATION_TIME}}", datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"))
        
        # ÂêÑ„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆÁîüÊàê
        dashboard_html = dashboard_html.replace("{{QUALITY_SCORES_SECTION}}", self._generate_quality_scores_section(metrics_data))
        dashboard_html = dashboard_html.replace("{{TREND_ANALYSIS_SECTION}}", self._generate_trend_analysis_section(metrics_data))
        dashboard_html = dashboard_html.replace("{{SYSTEM_PERFORMANCE_SECTION}}", self._generate_system_performance_section(metrics_data))
        dashboard_html = dashboard_html.replace("{{LEARNING_METRICS_SECTION}}", self._generate_learning_metrics_section(metrics_data))
        dashboard_html = dashboard_html.replace("{{GATE_STATISTICS_SECTION}}", self._generate_gate_statistics_section(metrics_data))
        dashboard_html = dashboard_html.replace("{{ALERT_SUMMARY_SECTION}}", self._generate_alert_summary_section(metrics_data))
        
        # „Éï„Ç°„Ç§„É´‰øùÂ≠ò
        output_path = self.output_dir / "quality_dashboard.html"
        with open(output_path, 'w', encoding='utf-8') as f:
            f.write(dashboard_html)
        
        print(f"‚úÖ HTML„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁîüÊàêÂÆå‰∫Ü: {output_path}")
        
        return str(output_path)
    
    def _create_html_template(self) -> str:
        """HTML„ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê"""
        
        return '''<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kumihan-Formatter ÂìÅË≥™„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            font-size: 1.1em;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        
        .metric-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .metric-label {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .metric-value {
            color: #27ae60;
            font-weight: bold;
        }
        
        .metric-value.warning {
            color: #f39c12;
        }
        
        .metric-value.error {
            color: #e74c3c;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-excellent {
            background: #d4edda;
            color: #155724;
        }
        
        .status-good {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 5px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .alert-item {
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #3498db;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .alert-critical {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }
        
        .alert-warning {
            border-left-color: #f39c12;
            background: #fffbf2;
        }
        
        .timestamp {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            margin-top: 20px;
        }
        
        .chart-container {
            height: 200px;
            background: #f8f9fa;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            color: #7f8c8d;
        }
        
        .no-data {
            text-align: center;
            color: #95a5a6;
            font-style: italic;
            padding: 20px;
        }
        
        .recommendation {
            background: #e8f5e8;
            border: 1px solid #27ae60;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
        }
        
        .recommendation::before {
            content: "üí° ";
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéØ Kumihan-Formatter ÂìÅË≥™„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h1>
            <div class="subtitle">„É™„Ç¢„É´„Çø„Ç§„É†ÂìÅË≥™Áõ£Ë¶ñ„ÉªÂàÜÊûê„Éª‰∫àÊ∏¨„Ç∑„Çπ„ÉÜ„É†</div>
        </header>
        
        <div class="dashboard-grid">
            {{QUALITY_SCORES_SECTION}}
            {{TREND_ANALYSIS_SECTION}}
            {{SYSTEM_PERFORMANCE_SECTION}}
            {{LEARNING_METRICS_SECTION}}
            {{GATE_STATISTICS_SECTION}}
            {{ALERT_SUMMARY_SECTION}}
        </div>
        
        <div class="timestamp">
            ÊúÄÁµÇÊõ¥Êñ∞: {{GENERATION_TIME}}
        </div>
    </div>
    
    <script>
        // „É°„Éà„É™„ÇØ„Çπ„Éá„Éº„Çø
        const metricsData = {{METRICS_DATA}};
        
        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂá¶ÁêÜ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ÂìÅË≥™„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
            console.log('„É°„Éà„É™„ÇØ„Çπ„Éá„Éº„Çø:', metricsData);
            
            // Ëá™ÂãïÊõ¥Êñ∞Ôºà5ÂàÜÈñìÈöîÔºâ
            setInterval(function() {
                location.reload();
            }, 300000);
        });
        
        // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóÊ©üËÉΩ
        function showTooltip(element, text) {
            // Á∞°Êòì„ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóÂÆüË£Ö
            element.title = text;
        }
        
        // „É°„Éà„É™„ÇØ„ÇπÂÄ§„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatMetricValue(value, type = 'number') {
            if (type === 'percentage') {
                return (value * 100).toFixed(1) + '%';
            } else if (type === 'score') {
                return value.toFixed(3);
            } else {
                return value.toString();
            }
        }
        
        // „Çπ„ÉÜ„Éº„Çø„ÇπÂà§ÂÆö
        function getStatusClass(value, thresholds = {good: 0.8, warning: 0.6}) {
            if (value >= thresholds.good) return 'status-excellent';
            if (value >= thresholds.warning) return 'status-warning';
            return 'status-error';
        }
    </script>
</body>
</html>'''
    
    def _generate_quality_scores_section(self, metrics_data: Dict[str, Any]) -> str:
        """ÂìÅË≥™„Çπ„Ç≥„Ç¢„Çª„ÇØ„Ç∑„Éß„É≥ÁîüÊàê"""
        
        quality_scores = metrics_data.get("quality_scores")
        if not quality_scores:
            return '<div class="card"><h2>üìä ÂìÅË≥™„Çπ„Ç≥„Ç¢</h2><div class="no-data">„Éá„Éº„Çø„Å™„Åó</div></div>'
        
        metrics = quality_scores.get("metrics", {})
        summary = quality_scores.get("summary", {})
        
        html = '''
        <div class="card">
            <h2>üìä ÂìÅË≥™„Çπ„Ç≥„Ç¢</h2>
        '''
        
        # Á∑èÂêàÂìÅË≥™„Çπ„Ç≥„Ç¢
        if "comprehensive_score" in metrics:
            score = metrics["comprehensive_score"]
            status_class = self._get_status_class(score)
            html += f'''
            <div class="metric-item">
                <span class="metric-label">Á∑èÂêàÂìÅË≥™„Çπ„Ç≥„Ç¢</span>
                <span class="metric-value">
                    <span class="status-badge {status_class}">{score:.3f}</span>
                </span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {score * 100}%"></div>
            </div>
            '''
        
        # „Ç´„ÉÜ„Ç¥„É™Âà•„Çπ„Ç≥„Ç¢
        if "category_scores" in metrics:
            html += '<h3>„Ç´„ÉÜ„Ç¥„É™Âà•„Çπ„Ç≥„Ç¢</h3>'
            for category, score in metrics["category_scores"].items():
                html += f'''
                <div class="metric-item">
                    <span class="metric-label">{category}</span>
                    <span class="metric-value">{score:.3f}</span>
                </div>
                '''
        
        # Âπ≥Âùá„Çπ„Ç≥„Ç¢
        if "average_scores" in metrics:
            html += '<h3>Âπ≥Âùá„Çπ„Ç≥„Ç¢</h3>'
            for check_type, score in metrics["average_scores"].items():
                html += f'''
                <div class="metric-item">
                    <span class="metric-label">{check_type}</span>
                    <span class="metric-value">{score:.3f}</span>
                </div>
                '''
        
        # „É™„Ç¢„É´„Çø„Ç§„É†ÊÉÖÂ†±
        if "realtime_average" in metrics:
            html += f'''
            <div class="metric-item">
                <span class="metric-label">„É™„Ç¢„É´„Çø„Ç§„É†Âπ≥Âùá</span>
                <span class="metric-value">{metrics["realtime_average"]:.3f}</span>
            </div>
            '''
        
        # „Çπ„ÉÜ„Éº„Çø„Çπ
        quality_status = summary.get("quality_status", "unknown")
        status_class = self._get_status_class_by_name(quality_status)
        html += f'''
        <div class="metric-item">
            <span class="metric-label">ÂìÅË≥™„Çπ„ÉÜ„Éº„Çø„Çπ</span>
            <span class="status-badge {status_class}">{quality_status}</span>
        </div>
        '''
        
        html += '</div>'
        
        return html
    
    def _generate_trend_analysis_section(self, metrics_data: Dict[str, Any]) -> str:
        """„Éà„É¨„É≥„ÉâÂàÜÊûê„Çª„ÇØ„Ç∑„Éß„É≥ÁîüÊàê"""
        
        trend_analysis = metrics_data.get("trend_analysis")
        if not trend_analysis:
            return '<div class="card"><h2>üìà „Éà„É¨„É≥„ÉâÂàÜÊûê</h2><div class="no-data">„Éá„Éº„Çø„Å™„Åó</div></div>'
        
        metrics = trend_analysis.get("metrics", {})
        summary = trend_analysis.get("summary", {})
        
        html = '''
        <div class="card">
            <h2>üìà „Éà„É¨„É≥„ÉâÂàÜÊûê</h2>
        '''
        
        # ÂÖ®‰Ωì„Éà„É¨„É≥„Éâ
        overall_trend = summary.get("overall_trend", "unknown")
        html += f'''
        <div class="metric-item">
            <span class="metric-label">ÂÖ®‰Ωì„Éà„É¨„É≥„Éâ</span>
            <span class="metric-value">{self._format_trend(overall_trend)}</span>
        </div>
        '''
        
        # „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Éà„É¨„É≥„Éâ
        if "performance_trends" in metrics:
            perf_trends = metrics["performance_trends"]
            html += '<h3>„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Éà„É¨„É≥„Éâ</h3>'
            for key, value in perf_trends.items():
                html += f'''
                <div class="metric-item">
                    <span class="metric-label">{key}</span>
                    <span class="metric-value">{value}</span>
                </div>
                '''
        
        # Â≠¶ÁøíÈÄ≤Âåñ
        if "learning_evolution" in metrics:
            evolution = metrics["learning_evolution"]
            html += '<h3>Â≠¶Áøí„Ç∑„Çπ„ÉÜ„É†ÈÄ≤Âåñ</h3>'
            html += f'''
            <div class="metric-item">
                <span class="metric-label">ÈÄ≤ÂåñÂõûÊï∞</span>
                <span class="metric-value">{evolution.get("evolution_count", 0)}</span>
            </div>
            '''
        
        # ‰∫àÊ∏¨Á≤æÂ∫¶
        prediction_accuracy = summary.get("prediction_accuracy", 0)
        html += f'''
        <div class="metric-item">
            <span class="metric-label">‰∫àÊ∏¨Á≤æÂ∫¶</span>
            <span class="metric-value">{prediction_accuracy:.1%}</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {prediction_accuracy * 100}%"></div>
        </div>
        '''
        
        html += '</div>'
        
        return html
    
    def _generate_system_performance_section(self, metrics_data: Dict[str, Any]) -> str:
        """„Ç∑„Çπ„ÉÜ„É†„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Çª„ÇØ„Ç∑„Éß„É≥ÁîüÊàê"""
        
        system_performance = metrics_data.get("system_performance")
        if not system_performance:
            return '<div class="card"><h2>‚ö° „Ç∑„Çπ„ÉÜ„É†„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ</h2><div class="no-data">„Éá„Éº„Çø„Å™„Åó</div></div>'
        
        metrics = system_performance.get("metrics", {})
        summary = system_performance.get("summary", {})
        
        html = '''
        <div class="card">
            <h2>‚ö° „Ç∑„Çπ„ÉÜ„É†„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ</h2>
        '''
        
        # „Ç∑„Çπ„ÉÜ„É†ÂÅ•ÂÖ®ÊÄß
        system_health = summary.get("overall_health", "unknown")
        health_class = self._get_status_class_by_name(system_health)
        html += f'''
        <div class="metric-item">
            <span class="metric-label">„Ç∑„Çπ„ÉÜ„É†ÂÅ•ÂÖ®ÊÄß</span>
            <span class="status-badge {health_class}">{system_health}</span>
        </div>
        '''
        
        # „É™„Ç¢„É´„Çø„Ç§„É†„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ
        if "realtime_performance" in metrics:
            rt_perf = metrics["realtime_performance"]
            html += '<h3>„É™„Ç¢„É´„Çø„Ç§„É†Áõ£Ë¶ñ</h3>'
            
            for key, value in rt_perf.items():
                if isinstance(value, (int, float)):
                    if "time" in key.lower():
                        formatted_value = f"{value:.3f}Áßí"
                    else:
                        formatted_value = str(value)
                    
                    html += f'''
                    <div class="metric-item">
                        <span class="metric-label">{key}</span>
                        <span class="metric-value">{formatted_value}</span>
                    </div>
                    '''
        
        # „Ç≤„Éº„Éà„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ
        if "gate_performance" in metrics:
            gate_perf = metrics["gate_performance"]
            html += '<h3>ÂìÅË≥™„Ç≤„Éº„Éà</h3>'
            
            for key, value in gate_perf.items():
                if isinstance(value, (int, float)):
                    formatted_value = f"{value:.3f}Áßí" if "time" in key else str(value)
                    html += f'''
                    <div class="metric-item">
                        <span class="metric-label">{key}</span>
                        <span class="metric-value">{formatted_value}</span>
                    </div>
                    '''
        
        # Ê§úË®º„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ
        if "validation_performance" in metrics:
            val_perf = metrics["validation_performance"]
            html += '<h3>ÂåÖÊã¨ÁöÑÊ§úË®º</h3>'
            
            for key, value in val_perf.items():
                if isinstance(value, (int, float)):
                    formatted_value = f"{value:.3f}Áßí" if "time" in key else f"{value:.2f}" if "throughput" in key else str(value)
                    html += f'''
                    <div class="metric-item">
                        <span class="metric-label">{key}</span>
                        <span class="metric-value">{formatted_value}</span>
                    </div>
                    '''
        
        html += '</div>'
        
        return html
    
    def _generate_learning_metrics_section(self, metrics_data: Dict[str, Any]) -> str:
        """Â≠¶Áøí„É°„Éà„É™„ÇØ„Çπ„Çª„ÇØ„Ç∑„Éß„É≥ÁîüÊàê"""
        
        learning_metrics = metrics_data.get("learning_metrics")
        if not learning_metrics:
            return '<div class="card"><h2>üß† Â≠¶Áøí„Ç∑„Çπ„ÉÜ„É†</h2><div class="no-data">„Éá„Éº„Çø„Å™„Åó</div></div>'
        
        metrics = learning_metrics.get("metrics", {})
        summary = learning_metrics.get("summary", {})
        
        html = '''
        <div class="card">
            <h2>üß† Â≠¶Áøí„Ç∑„Çπ„ÉÜ„É†</h2>
        '''
        
        # Â≠¶ÁøíÁä∂ÊÖã
        learning_active = summary.get("learning_active", False)
        learning_quality = summary.get("learning_quality", "unknown")
        
        html += f'''
        <div class="metric-item">
            <span class="metric-label">Â≠¶ÁøíÁä∂ÊÖã</span>
            <span class="status-badge {'status-good' if learning_active else 'status-warning'}">
                {'„Ç¢„ÇØ„ÉÜ„Ç£„Éñ' if learning_active else 'Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ'}
            </span>
        </div>
        <div class="metric-item">
            <span class="metric-label">Â≠¶ÁøíÂìÅË≥™</span>
            <span class="status-badge {self._get_status_class_by_name(learning_quality)}">{learning_quality}</span>
        </div>
        '''
        
        # Â≠¶ÁøíÂäπÊûú
        if "learning_effectiveness" in metrics:
            effectiveness = metrics["learning_effectiveness"]
            html += '<h3>Â≠¶ÁøíÂäπÊûú</h3>'
            
            success_rate = effectiveness.get("success_rate", 0)
            html += f'''
            <div class="metric-item">
                <span class="metric-label">ÊàêÂäüÁéá</span>
                <span class="metric-value">{success_rate:.1%}</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {success_rate * 100}%"></div>
            </div>
            '''
            
            for key, value in effectiveness.items():
                if key != "success_rate" and isinstance(value, (int, float)):
                    if "improvement" in key:
                        formatted_value = f"+{value:.3f}" if value > 0 else f"{value:.3f}"
                    else:
                        formatted_value = str(value)
                    
                    html += f'''
                    <div class="metric-item">
                        <span class="metric-label">{key}</span>
                        <span class="metric-value">{formatted_value}</span>
                    </div>
                    '''
        
        # ‰∫àÊ∏¨ÂìÅË≥™
        if "prediction_quality" in metrics:
            pred_quality = metrics["prediction_quality"]
            html += '<h3>‰∫àÊ∏¨ÂìÅË≥™</h3>'
            
            for key, value in pred_quality.items():
                if isinstance(value, (int, float)):
                    formatted_value = f"{value:.1%}" if "rate" in key else f"{value:.3f}"
                    html += f'''
                    <div class="metric-item">
                        <span class="metric-label">{key}</span>
                        <span class="metric-value">{formatted_value}</span>
                    </div>
                    '''
        
        # ÊîπÂñÑÂèØËÉΩÊÄß
        improvement_potential = summary.get("improvement_potential", "unknown")
        html += f'''
        <div class="metric-item">
            <span class="metric-label">ÊîπÂñÑÂèØËÉΩÊÄß</span>
            <span class="status-badge {self._get_status_class_by_name(improvement_potential)}">{improvement_potential}</span>
        </div>
        '''
        
        html += '</div>'
        
        return html
    
    def _generate_gate_statistics_section(self, metrics_data: Dict[str, Any]) -> str:
        """„Ç≤„Éº„ÉàÁµ±Ë®à„Çª„ÇØ„Ç∑„Éß„É≥ÁîüÊàê"""
        
        gate_statistics = metrics_data.get("gate_statistics")
        if not gate_statistics:
            return '<div class="card"><h2>üö™ ÂìÅË≥™„Ç≤„Éº„Éà</h2><div class="no-data">„Éá„Éº„Çø„Å™„Åó</div></div>'
        
        metrics = gate_statistics.get("metrics", {})
        summary = gate_statistics.get("summary", {})
        
        html = '''
        <div class="card">
            <h2>üö™ ÂìÅË≥™„Ç≤„Éº„Éà</h2>
        '''
        
        # „Ç≤„Éº„ÉàÂÅ•ÂÖ®ÊÄß
        gate_health = summary.get("overall_gate_health", "unknown")
        health_class = self._get_status_class_by_name(gate_health)
        html += f'''
        <div class="metric-item">
            <span class="metric-label">„Ç≤„Éº„ÉàÂÅ•ÂÖ®ÊÄß</span>
            <span class="status-badge {health_class}">{gate_health}</span>
        </div>
        '''
        
        # „Ç≤„Éº„ÉàÁµ±Ë®à
        if "gate_statistics" in metrics:
            gate_stats = metrics["gate_statistics"]
            html += '<h3>ÂÆüË°åÁµ±Ë®à</h3>'
            
            for key, value in gate_stats.items():
                if isinstance(value, (int, float)):
                    if "rate" in key:
                        formatted_value = f"{value:.1%}"
                        value_class = "metric-value" if value >= 0.8 else "metric-value warning" if value >= 0.6 else "metric-value error"
                    elif "score" in key:
                        formatted_value = f"{value:.3f}"
                        value_class = "metric-value"
                    else:
                        formatted_value = str(int(value))
                        value_class = "metric-value"
                    
                    html += f'''
                    <div class="metric-item">
                        <span class="metric-label">{key}</span>
                        <span class="{value_class}">{formatted_value}</span>
                    </div>
                    '''
                    
                    if "rate" in key:
                        html += f'''
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {value * 100}%"></div>
                        </div>
                        '''
        
        # „Éï„Çß„Éº„Ç∫Âà•Áµ±Ë®à
        if "phase_statistics" in metrics:
            phase_stats = metrics["phase_statistics"]
            html += '<h3>„Éï„Çß„Éº„Ç∫Âà•Áµ±Ë®à</h3>'
            
            for phase, stats in phase_stats.items():
                pass_rate = stats.get("pass_rate", 0)
                executions = stats.get("executions", 0)
                
                html += f'''
                <div class="metric-item">
                    <span class="metric-label">{phase}</span>
                    <span class="metric-value">{pass_rate:.1%} ({executions}Âõû)</span>
                </div>
                '''
        
        # Êé®Â•®‰∫ãÈ†Ö
        recommendations = summary.get("recommendations", [])
        if recommendations:
            html += '<h3>Êé®Â•®‰∫ãÈ†Ö</h3>'
            for rec in recommendations:
                html += f'<div class="recommendation">{rec}</div>'
        
        html += '</div>'
        
        return html
    
    def _generate_alert_summary_section(self, metrics_data: Dict[str, Any]) -> str:
        """„Ç¢„É©„Éº„Éà„Çµ„Éû„É™„Éº„Çª„ÇØ„Ç∑„Éß„É≥ÁîüÊàê"""
        
        alert_summary = metrics_data.get("alert_summary")
        if not alert_summary:
            return '<div class="card"><h2>üö® „Ç¢„É©„Éº„Éà</h2><div class="no-data">„Éá„Éº„Çø„Å™„Åó</div></div>'
        
        metrics = alert_summary.get("metrics", {})
        summary = alert_summary.get("summary", {})
        
        html = '''
        <div class="card">
            <h2>üö® „Ç¢„É©„Éº„Éà</h2>
        '''
        
        # „Ç∑„Çπ„ÉÜ„É†„Çπ„ÉÜ„Éº„Çø„Çπ
        system_status = summary.get("system_status", "unknown")
        status_class = self._get_status_class_by_name(system_status)
        html += f'''
        <div class="metric-item">
            <span class="metric-label">„Ç∑„Çπ„ÉÜ„É†„Çπ„ÉÜ„Éº„Çø„Çπ</span>
            <span class="status-badge {status_class}">{system_status}</span>
        </div>
        '''
        
        # „Ç¢„É©„Éº„ÉàÁµ±Ë®à
        if "alert_statistics" in metrics:
            alert_stats = metrics["alert_statistics"]
            html += '<h3>„Ç¢„É©„Éº„ÉàÁµ±Ë®à</h3>'
            
            total_alerts = alert_stats.get("total_alerts", 0)
            html += f'''
            <div class="metric-item">
                <span class="metric-label">Á∑è„Ç¢„É©„Éº„ÉàÊï∞</span>
                <span class="metric-value">{total_alerts}</span>
            </div>
            '''
            
            # „É¨„Éô„É´Âà•„Ç¢„É©„Éº„Éà
            by_level = alert_stats.get("by_level", {})
            if by_level:
                html += '<h4>„É¨„Éô„É´Âà•</h4>'
                for level, count in by_level.items():
                    alert_class = f"alert-{level}" if level in ["critical", "warning"] else "alert-item"
                    html += f'''
                    <div class="{alert_class}">
                        <span class="metric-label">{level}</span>: {count}‰ª∂
                    </div>
                    '''
            
            # Ëß£Ê±∫„ÅåÂøÖË¶Å„Å™„Ç¢„É©„Éº„Éà
            resolution_needed = alert_stats.get("resolution_needed", 0)
            if resolution_needed > 0:
                html += f'''
                <div class="alert-critical">
                    ‚ö†Ô∏è Ëß£Ê±∫„ÅåÂøÖË¶Å„Å™„Ç¢„É©„Éº„Éà: {resolution_needed}‰ª∂
                </div>
                '''
        
        # „Ç∑„Çπ„ÉÜ„É†ÂÅ•ÂÖ®ÊÄß
        if "system_health" in metrics:
            health = metrics["system_health"]
            html += '<h3>„Ç∑„Çπ„ÉÜ„É†ÂÅ•ÂÖ®ÊÄß</h3>'
            
            monitoring_active = health.get("monitoring_active", False)
            html += f'''
            <div class="metric-item">
                <span class="metric-label">Áõ£Ë¶ñÁä∂ÊÖã</span>
                <span class="status-badge {'status-good' if monitoring_active else 'status-error'}">
                    {'Á®ºÂÉç‰∏≠' if monitoring_active else 'ÂÅúÊ≠¢‰∏≠'}
                </span>
            </div>
            '''
            
            if health.get("last_alert_time"):
                html += f'''
                <div class="metric-item">
                    <span class="metric-label">ÊúÄÁµÇ„Ç¢„É©„Éº„Éà</span>
                    <span class="metric-value">{health["last_alert_time"][:19]}</span>
                </div>
                '''
        
        html += '</div>'
        
        return html
    
    def _generate_json_dashboard(self, metrics_data: Dict[str, Any]) -> str:
        """JSON„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁîüÊàê"""
        
        dashboard_data = {
            "dashboard_metadata": {
                "generated_at": datetime.datetime.now().isoformat(),
                "version": "1.0.0",
                "type": "quality_dashboard"
            },
            "metrics": metrics_data,
            "summary": self._generate_overall_summary(metrics_data)
        }
        
        output_path = self.output_dir / "quality_dashboard.json"
        with open(output_path, 'w', encoding='utf-8') as f:
            json.dump(dashboard_data, f, indent=2, ensure_ascii=False)
        
        print(f"‚úÖ JSON„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁîüÊàêÂÆå‰∫Ü: {output_path}")
        
        return str(output_path)
    
    def _generate_overall_summary(self, metrics_data: Dict[str, Any]) -> Dict[str, Any]:
        """ÂÖ®‰Ωì„Çµ„Éû„É™„ÉºÁîüÊàê"""
        
        summary = {
            "total_categories": len(metrics_data),
            "data_completeness": self._calculate_data_completeness(metrics_data),
            "overall_health": self._determine_overall_health(metrics_data),
            "key_insights": self._generate_key_insights(metrics_data)
        }
        
        return summary
    
    def _calculate_data_completeness(self, metrics_data: Dict[str, Any]) -> float:
        """„Éá„Éº„ÇøÂÆåÂÖ®ÊÄßË®àÁÆó"""
        
        expected_categories = 6  # ÊúüÂæÖ„Åï„Çå„Çã„Ç´„ÉÜ„Ç¥„É™Êï∞
        actual_categories = len(metrics_data)
        
        return min(1.0, actual_categories / expected_categories)
    
    def _determine_overall_health(self, metrics_data: Dict[str, Any]) -> str:
        """ÂÖ®‰ΩìÂÅ•ÂÖ®ÊÄßÂà§ÂÆö"""
        
        health_scores = []
        
        # ÂìÅË≥™„Çπ„Ç≥„Ç¢ÂÅ•ÂÖ®ÊÄß
        quality_scores = metrics_data.get("quality_scores")
        if quality_scores:
            comprehensive_score = quality_scores.get("metrics", {}).get("comprehensive_score", 0)
            health_scores.append(comprehensive_score)
        
        # „Ç∑„Çπ„ÉÜ„É†„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÂÅ•ÂÖ®ÊÄß
        system_performance = metrics_data.get("system_performance")
        if system_performance:
            health = system_performance.get("summary", {}).get("overall_health", "unknown")
            if health == "healthy":
                health_scores.append(1.0)
            elif health == "degraded":
                health_scores.append(0.5)
            else:
                health_scores.append(0.0)
        
        if health_scores:
            avg_health = sum(health_scores) / len(health_scores)
            if avg_health >= 0.9:
                return "excellent"
            elif avg_health >= 0.8:
                return "good"
            elif avg_health >= 0.6:
                return "acceptable"
            else:
                return "needs_attention"
        
        return "unknown"
    
    def _generate_key_insights(self, metrics_data: Dict[str, Any]) -> List[str]:
        """‰∏ªË¶ÅÊ¥ûÂØüÁîüÊàê"""
        
        insights = []
        
        # ÂìÅË≥™„Çπ„Ç≥„Ç¢Ê¥ûÂØü
        quality_scores = metrics_data.get("quality_scores")
        if quality_scores:
            score = quality_scores.get("metrics", {}).get("comprehensive_score", 0)
            if score >= 0.9:
                insights.append("ÂÑ™ÁßÄ„Å™ÂìÅË≥™„É¨„Éô„É´„ÇíÁ∂≠ÊåÅ„Åó„Å¶„ÅÑ„Åæ„Åô")
            elif score < 0.7:
                insights.append("ÂìÅË≥™ÊîπÂñÑ„ÅåÊÄ•Âãô„Åß„Åô")
        
        # Â≠¶Áøí„Ç∑„Çπ„ÉÜ„É†Ê¥ûÂØü
        learning_metrics = metrics_data.get("learning_metrics")
        if learning_metrics:
            if learning_metrics.get("summary", {}).get("learning_active", False):
                insights.append("Â≠¶Áøí„Ç∑„Çπ„ÉÜ„É†„ÅåÊ¥ªÁô∫„Å´Á®ºÂÉç„Åó„Å¶„ÅÑ„Åæ„Åô")
        
        # „Ç¢„É©„Éº„ÉàÊ¥ûÂØü
        alert_summary = metrics_data.get("alert_summary")
        if alert_summary:
            alert_stats = alert_summary.get("metrics", {}).get("alert_statistics", {})
            critical_rate = alert_stats.get("critical_rate", 0)
            if critical_rate > 0.1:
                insights.append("ÈáçË¶Å„Å™„Ç¢„É©„Éº„Éà„ÅåÂ§öÁô∫„Åó„Å¶„ÅÑ„Åæ„Åô")
        
        return insights
    
    def _generate_no_data_dashboard(self) -> str:
        """„Éá„Éº„Çø„Å™„Åó„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁîüÊàê"""
        
        html = '''<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂìÅË≥™„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ - „Éá„Éº„Çø„Å™„Åó</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
        .no-data-message { color: #666; font-size: 1.2em; }
    </style>
</head>
<body>
    <h1>üîç ÂìÅË≥™„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h1>
    <div class="no-data-message">
        <p>„É°„Éà„É™„ÇØ„Çπ„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</p>
        <p>ÂìÅË≥™„Ç∑„Çπ„ÉÜ„É†„ÇíÂÆüË°å„Åó„Å¶„Éá„Éº„Çø„ÇíÂèéÈõÜ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
    </div>
</body>
</html>'''
        
        output_path = self.output_dir / "quality_dashboard_no_data.html"
        with open(output_path, 'w', encoding='utf-8') as f:
            f.write(html)
        
        return str(output_path)
    
    # „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£„É°„ÇΩ„ÉÉ„Éâ
    def _get_status_class(self, value: float) -> str:
        """„Çπ„ÉÜ„Éº„Çø„Çπ„ÇØ„É©„ÇπÂèñÂæó"""
        if value >= 0.9:
            return "status-excellent"
        elif value >= 0.8:
            return "status-good"
        elif value >= 0.6:
            return "status-warning"
        else:
            return "status-error"
    
    def _get_status_class_by_name(self, status: str) -> str:
        """ÂêçÂâç„Å´„Çà„Çã„Çπ„ÉÜ„Éº„Çø„Çπ„ÇØ„É©„ÇπÂèñÂæó"""
        status_mapping = {
            "excellent": "status-excellent",
            "good": "status-good",
            "healthy": "status-good",
            "acceptable": "status-warning",
            "warning": "status-warning",
            "moderate": "status-warning",
            "needs_improvement": "status-error",
            "needs_attention": "status-error",
            "error": "status-error",
            "critical": "status-error",
            "unknown": "status-warning"
        }
        return status_mapping.get(status.lower(), "status-warning")
    
    def _format_trend(self, trend: str) -> str:
        """„Éà„É¨„É≥„ÉâË°®Á§∫„Éï„Ç©„Éº„Éû„ÉÉ„Éà"""
        trend_mapping = {
            "improving": "üìà ÊîπÂñÑ‰∏≠",
            "declining": "üìâ ‰Ωé‰∏ã‰∏≠",
            "stable": "üìä ÂÆâÂÆö",
            "unknown": "‚ùì ‰∏çÊòé"
        }
        return trend_mapping.get(trend, trend)

def main():
    """„ÉÜ„Çπ„ÉàÂÆüË°å"""
    print("üß™ QualityDashboardGenerator „ÉÜ„Çπ„ÉàÈñãÂßã")
    
    generator = QualityDashboardGenerator()
    
    # HTML„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁîüÊàê„ÉÜ„Çπ„Éà
    print("\n=== HTML„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁîüÊàê ===")
    html_path = generator.generate_dashboard("html")
    print(f"ÁîüÊàê„Åï„Çå„ÅüHTML: {html_path}")
    
    # JSON„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁîüÊàê„ÉÜ„Çπ„Éà
    print("\n=== JSON„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁîüÊàê ===")
    json_path = generator.generate_dashboard("json")
    print(f"ÁîüÊàê„Åï„Çå„ÅüJSON: {json_path}")
    
    print("‚úÖ QualityDashboardGenerator „ÉÜ„Çπ„ÉàÂÆå‰∫Ü")

if __name__ == "__main__":
    main()